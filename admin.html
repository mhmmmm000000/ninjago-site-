<!doctype html>
<html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Admin — Ninjago</title><link rel="stylesheet" href="styles.css"></head>
<body>
  <main style="max-width:980px;margin:24px auto;padding:16px">
    <h1>Admin — Ninjago</h1>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <input id="adminPass" class="input" placeholder="Enter admin password">
      <button id="loginBtn" class="btn small">Login</button>
      <button id="logoutBtn" class="small">Logout</button>
      <div id="loginStatus" class="meta"></div>
    </div>

    <div id="adminArea" style="display:none">
      <h2>Orders</h2>
      <div id="ordersList"></div>
      <h2>Requests</h2>
      <div id="requestsList"></div>
      <h2>Giftcards (create)</h2>
      <div style="display:flex;gap:8px">
        <input id="gcCode" class="input" placeholder="Code (e.g. GC-100)">
        <input id="gcBal" class="input" placeholder="Balance" type="number">
        <button id="createGC" class="btn small">Create</button>
      </div>
    </div>
  </main>

<script>
const $ = q => document.querySelector(q);
function showStatus(s){ $('#loginStatus').innerText = s; }
function requireAuth(){
  const s = sessionStorage.getItem('adminSecret');
  return !!s;
}

$('#loginBtn').onclick = ()=> {
  const v = $('#adminPass').value.trim();
  if(!v){ showStatus('enter password'); return; }
  sessionStorage.setItem('adminSecret', v);
  showStatus('logged in for this session');
  initAdmin();
};
$('#logoutBtn').onclick = ()=> {
  sessionStorage.removeItem('adminSecret'); showStatus('logged out'); $('#adminArea').style.display='none';
};

async function api(path, opts={}){
  const secret = sessionStorage.getItem('adminSecret');
  opts.headers = opts.headers || {};
  if(secret) opts.headers['x-admin-secret'] = secret;
  const res = await fetch(path, opts);
  if(res.status === 401){ alert('Admin secret invalid for server. Check ADMIN_SECRET in Vercel.'); return null; }
  return res;
}

async function initAdmin(){
  if(!requireAuth()) return;
  $('#adminArea').style.display='block';
  // try to load server data; if fails, fallback to localStorage
  try {
    const ores = await api('/api/orders');
    if(ores && ores.ok){
      const orders = await ores.json();
      renderOrders(orders);
    } else {
      const orders = JSON.parse(localStorage.getItem('orders')||'[]');
      renderOrders(orders);
    }
    const rres = await api('/api/requests');
    if(rres && rres.ok){
      const requests = await rres.json();
      renderRequests(requests);
    } else {
      renderRequests(JSON.parse(localStorage.getItem('requests')||'[]'));
    }
  } catch(e){ console.warn(e); renderOrders(JSON.parse(localStorage.getItem('orders')||'[]')); renderRequests(JSON.parse(localStorage.getItem('requests')||'[]')); }
}

function renderOrders(orders){
  const el = $('#ordersList'); el.innerHTML = '';
  if(!orders.length) { el.innerHTML = '<div class="meta">No orders</div>'; return; }
  orders.slice().reverse().forEach(o=>{
    const d = document.createElement('div'); d.className='card show'; d.style.marginBottom='8px';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>Order ${o.id}</strong><div><button class="small mark">Toggle done</button> <button class="small del">Delete</button></div></div><div class="meta">Method: ${o.method||'-'} • Total: SAR ${o.total||0}</div><div class="meta">Name: ${o.name||'-'} • Date: ${o.date||'-'}</div><div style="margin-top:8px">${(o.cart||[]).map(it=>`<div>${it.title} × ${it.qty} — SAR ${it.price}</div>`).join('')}</div><div class="meta">Notes: ${o.msg||''}</div>`;
    el.appendChild(d);
    d.querySelector('.del').onclick = async ()=> { if(!confirm('Delete order?')) return; const res = await api('/api/orders', { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:o.id}) }); if(res && res.ok) initAdmin(); else { let arr = JSON.parse(localStorage.getItem('orders')||'[]'); arr = arr.filter(x=>x.id!==o.id); localStorage.setItem('orders', JSON.stringify(arr)); initAdmin(); } };
    d.querySelector('.mark').onclick = async ()=> { o.done = !o.done; const res = await api('/api/orders', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(o) }); if(res && res.ok) initAdmin(); else { let arr = JSON.parse(localStorage.getItem('orders')||'[]'); arr = arr.map(x=> x.id===o.id?o:x); localStorage.setItem('orders', JSON.stringify(arr)); initAdmin(); } };
  });
}

function renderRequests(requests){
  const el = $('#requestsList'); el.innerHTML = '';
  if(!requests.length) { el.innerHTML = '<div class="meta">No requests</div>'; return; }
  requests.slice().reverse().forEach(r=>{
    const d = document.createElement('div'); d.className='card show'; d.style.marginBottom='8px';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${new Date(r.time||Date.now()).toLocaleString()}</div><div><button class="small rdel">Delete</button></div></div><div class="msg user" style="padding:8px;margin-top:8px">${r.name?('<strong>'+r.name+'</strong> — '):''}${r.type?('['+r.type+'] '):''}${r.text}</div>`;
    el.appendChild(d);
    d.querySelector('.rdel').onclick = async ()=> { if(!confirm('Delete request?')) return; const res = await api('/api/requests', { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:r.id}) }); if(res && res.ok) initAdmin(); else { let arr = JSON.parse(localStorage.getItem('requests')||'[]'); arr = arr.filter(x=> x.id !== r.id); localStorage.setItem('requests', JSON.stringify(arr)); initAdmin(); } };
  });
}

$('#createGC').onclick = async ()=>{
  const code = $('#gcCode').value.trim(); const bal = Number($('#gcBal').value);
  if(!code || !bal){ alert('enter code and numeric balance'); return; }
  const res = await api('/api/giftcards', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, balance: bal }) });
  if(res && res.ok){ alert('giftcard created'); $('#gcCode').value=''; $('#gcBal').value=''; }
};

window.addEventListener('load', ()=>{ if(requireAuth()) initAdmin(); });
</script>
</body></html>
