<!doctype html>
<html lang="en">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Admin — Ninjago</title><link rel="stylesheet" href="styles.css"></head>
<body>
  <main style="max-width:1000px;margin:24px auto;padding:16px">
    <h1>Admin — Orders & Requests</h1>

    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <input id="adminSecret" class="input" placeholder="ADMIN_SECRET (optional)">
      <button id="loadBtn" class="btn small">Load</button>
      <button id="exportLocal" class="small">Export local data</button>
    </div>

    <h2>Orders</h2>
    <div id="ordersList"></div>

    <h2>Requests</h2>
    <div id="requestsList"></div>
  </main>

<script>
const $ = q => document.querySelector(q);

async function loadAdmin(){
  const secret = $('#adminSecret').value.trim();
  // try server first if SECRET provided
  let orders = [], requests = [];
  if(secret){
    try {
      const ores = await fetch('/api/orders', {headers:{'x-admin-secret':secret}});
      if(ores.ok){ orders = await ores.json(); }
      const rres = await fetch('/api/requests', {headers:{'x-admin-secret':secret}});
      if(rres.ok){ requests = await rres.json(); }
    } catch(e){ console.warn('server admin failed', e); }
  }
  // fallback to localStorage if empty
  if(!orders.length) orders = JSON.parse(localStorage.getItem('orders')||'[]');
  if(!requests.length) requests = JSON.parse(localStorage.getItem('requests')||'[]');

  renderOrders(orders, secret);
  renderRequests(requests, secret);
}

function renderOrders(orders, secret){
  const el = $('#ordersList'); el.innerHTML = '';
  if(!orders.length) { el.innerHTML = '<div class="meta">No orders</div>'; return; }
  orders.slice().reverse().forEach(o=>{
    const d = document.createElement('div'); d.className='card show'; d.style.marginBottom='8px';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>Order ${o.id}</strong><div><button class="small mark">Toggle done</button> <button class="small del">Delete</button></div></div>
      <div class="meta">Method: ${o.method||'-'} • Total: SAR ${o.total||0}</div>
      <div class="meta">Name: ${o.name||'-'} • Date: ${o.date||'-'}</div>
      <div style="margin-top:8px">${(o.cart||[]).map(it=>`<div>${it.title} × ${it.qty} — SAR ${it.price}</div>`).join('')}</div>
      <div class="meta">Notes: ${o.msg||''}</div>`;
    el.appendChild(d);

    d.querySelector('.del').onclick = async ()=>{
      if(!confirm('Delete order?')) return;
      // server delete if secret provided
      if(secret){
        await fetch('/api/orders', {method:'DELETE', headers:{'content-type':'application/json','x-admin-secret':secret}, body: JSON.stringify({id:o.id}) }).catch(()=>null);
      } else {
        let arr = JSON.parse(localStorage.getItem('orders')||'[]'); arr = arr.filter(x=>x.id!==o.id); localStorage.setItem('orders', JSON.stringify(arr));
      }
      loadAdmin();
    };

    d.querySelector('.mark').onclick = async ()=>{
      o.done = !o.done;
      if(secret){
        await fetch('/api/orders', {method:'PUT', headers:{'content-type':'application/json','x-admin-secret':secret}, body: JSON.stringify(o)}).catch(()=>null);
      } else {
        let arr = JSON.parse(localStorage.getItem('orders')||'[]'); arr = arr.map(x=> x.id===o.id ? o : x); localStorage.setItem('orders', JSON.stringify(arr));
      }
      loadAdmin();
    };
  });
}

function renderRequests(requests, secret){
  const el = $('#requestsList'); el.innerHTML = '';
  if(!requests.length) { el.innerHTML = '<div class="meta">No requests</div>'; return; }
  requests.slice().reverse().forEach(r=>{
    const d = document.createElement('div'); d.className='card show'; d.style.marginBottom='8px';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${new Date(r.time||Date.now()).toLocaleString()}</div><div><button class="small rdel">Delete</button></div></div><div class="msg user" style="padding:8px;margin-top:8px">${r.name?('<strong>'+r.name+'</strong> — '):''}${r.type?('['+r.type+'] '):''}${r.text}</div>`;
    el.appendChild(d);
    d.querySelector('.rdel').onclick = async ()=>{
      if(!confirm('Delete request?')) return;
      if(secret){
        await fetch('/api/requests',{method:'DELETE', headers:{'content-type':'application/json','x-admin-secret':secret}, body: JSON.stringify({id:r.id})}).catch(()=>null);
      } else {
        let arr = JSON.parse(localStorage.getItem('requests')||'[]'); arr = arr.filter(x=> x.id !== r.id); localStorage.setItem('requests', JSON.stringify(arr));
      }
      loadAdmin();
    };
  });
}

$('#loadBtn').onclick = loadAdmin;
$('#exportLocal').onclick = ()=> {
  const data = {orders: JSON.parse(localStorage.getItem('orders')||'[]'), requests: JSON.parse(localStorage.getItem('requests')||'[]')};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ninjago-local-data.json'; a.click(); URL.revokeObjectURL(a.href);
};

loadAdmin();
</script>
</body>
</html>
