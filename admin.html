<!doctype html>
<html lang="en">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Admin — Ninjago</title><link rel="stylesheet" href="styles.css"></head>
<body style="background:#071428;color:#eaf6ff;font-family:Inter,system-ui,Roboto,Arial">
<main style="max-width:1000px;margin:24px auto;padding:16px">
  <h1>Admin — Ninjago (Local gate)</h1>
  <div id="authArea"></div>
  <div id="adminArea" style="display:none">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <button id="refreshBtn" class="small">Refresh</button>
      <button id="exportLocal" class="small">Export local data</button>
      <button id="clearLocal" class="small" style="margin-left:auto">Clear local orders & requests</button>
    </div>

    <h2>Orders (local)</h2>
    <div id="ordersList"></div>

    <h2>Requests (local)</h2>
    <div id="requestsList"></div>
  </div>
  <div style="margin-top:12px;color:#9fb7ca;font-size:13px">
    Note: To enable server-backed admin, configure server env variable ADMIN_SECRET in Vercel and the server /api endpoints. This local gate protects from casual visitors but is not a full server-side auth.
  </div>
</main>

<script>
/* simple sha256 helper */
async function sha256(str){ const buf = new TextEncoder().encode(str); const hash = await crypto.subtle.digest('SHA-256', buf); return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

const authArea = document.getElementById('authArea');
const adminArea = document.getElementById('adminArea');

async function renderAuth(){
  const stored = localStorage.getItem('ninjago_admin_hash');
  if(!stored){
    authArea.innerHTML = `<div style="background:#05202b;padding:12px;border-radius:8px"><div style="font-weight:700;margin-bottom:8px">Set admin password (owner only)</div><input id="setPw" class="input" placeholder="New admin password"><div style="margin-top:8px"><button id="savePw" class="btn small">Save password</button></div></div>`;
    document.getElementById('savePw').onclick = async ()=>{
      const pw = document.getElementById('setPw').value.trim();
      if(!pw) return alert('Enter password');
      const h = await sha256(pw);
      localStorage.setItem('ninjago_admin_hash', h);
      alert('Password saved locally. Keep it safe.');
      renderAuth();
    };
  } else {
    authArea.innerHTML = `<div style="background:#05202b;padding:12px;border-radius:8px"><div style="font-weight:700;margin-bottom:8px">Enter admin password</div><input id="enterPw" class="input" placeholder="Password"><div style="margin-top:8px"><button id="enterBtn" class="btn small">Enter</button></div></div>`;
    document.getElementById('enterBtn').onclick = async ()=>{
      const v = document.getElementById('enterPw').value.trim(); if(!v) return;
      const h = await sha256(v);
      if(h === localStorage.getItem('ninjago_admin_hash')){
        showAdmin();
      } else {
        alert('Wrong password');
      }
    };
  }
}

function showAdmin(){
  authArea.style.display = 'none';
  adminArea.style.display = 'block';
  loadAdminData();
}

function loadAdminData(){
  const orders = JSON.parse(localStorage.getItem('orders')||'[]');
  const requests = JSON.parse(localStorage.getItem('requests')||'[]');
  const ol = document.getElementById('ordersList'); ol.innerHTML = '';
  if(orders.length===0) ol.innerHTML = '<div class="meta">No orders</div>';
  orders.slice().reverse().forEach(o=>{
    const d = document.createElement('div'); d.className='card'; d.style.marginBottom='8px'; d.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>Order ${o.id}</strong><div><button class="small done">Toggle done</button> <button class="small del">Delete</button></div></div><div class="meta">Method: ${o.method||'-'} • Total: SAR ${o.total||0}</div><div class="meta">Name: ${o.name||'-'} • Date: ${o.date||'-'}</div><div style="margin-top:8px">${(o.cart||[]).map(it=>`<div>${it.title} × ${it.qty} — SAR ${it.price}</div>`).join('')}</div><div class="meta">Notes: ${o.msg||''}</div>`;
    ol.appendChild(d);
    d.querySelector('.del').onclick = ()=> { if(confirm('Delete order?')) { let arr = JSON.parse(localStorage.getItem('orders')||'[]'); arr = arr.filter(x=>x.id!==o.id); localStorage.setItem('orders', JSON.stringify(arr)); loadAdminData(); } };
    d.querySelector('.done').onclick = ()=> { o.done = !o.done; let arr = JSON.parse(localStorage.getItem('orders')||'[]'); arr = arr.map(x=> x.id===o.id ? o : x); localStorage.setItem('orders', JSON.stringify(arr)); loadAdminData(); };
  });

  const rl = document.getElementById('requestsList'); rl.innerHTML = '';
  if(requests.length===0) rl.innerHTML = '<div class="meta">No requests</div>';
  requests.slice().reverse().forEach(r=>{
    const d = document.createElement('div'); d.className='card'; d.style.marginBottom='8px'; d.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${new Date(r.time||Date.now()).toLocaleString()}</div><div><button class="small rdel">Delete</button></div></div><div class="msg user" style="padding:8px;margin-top:8px">${r.name?('<strong>'+r.name+'</strong> — '):''}${r.type?('['+r.type+'] '):''}${r.text}</div>`;
    rl.appendChild(d);
    d.querySelector('.rdel').onclick = ()=>{ if(confirm('Delete request?')){ let arr = JSON.parse(localStorage.getItem('requests')||'[]'); arr = arr.filter(x=> x.id !== r.id); localStorage.setItem('requests', JSON.stringify(arr)); loadAdminData(); } };
  });
}

document.getElementById('refreshBtn').onclick = loadAdminData;
document.getElementById('exportLocal').onclick = ()=> {
  const data = {orders: JSON.parse(localStorage.getItem('orders')||'[]'), requests: JSON.parse(localStorage.getItem('requests')||'[]')};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ninjago-local-data.json'; a.click(); URL.revokeObjectURL(a.href);
};
document.getElementById('clearLocal').onclick = ()=> { if(confirm('Clear local orders and requests?')){ localStorage.removeItem('orders'); localStorage.removeItem('requests'); loadAdminData(); } };

renderAuth();

</script>
</body>
</html>
