<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Market ‚Äî final</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">Ninjago Market</div>
      <div class="subtitle">Browse ‚Ä¢ Request ‚Ä¢ Reserve ‚Ä¢ Giftcard</div>
    </div>
    <div class="controls">
      <input id="search" class="search" placeholder="Search sets, figures, books...">
      <button id="themeToggle" class="btn small" title="Toggle theme">üåô</button>
      <div id="cartBtn" class="btn">üõí <span id="cartCount">0</span></div>
      <a class="btn small" id="adminOpen" href="#" title="Admin">Admin</a>
    </div>
  </header>

  <main class="container">
    <div class="top-row">
      <div class="hint">Tip: click a category (e.g., Sets). Click a tile to go inside a category and browse subthemes.</div>
      <div class="filters">
        <label><input id="showHardToFindOnly" type="checkbox"> Show only Hard-to-find</label>
      </div>
    </div>

    <div id="mainArea" class="main-area"></div>
  </main>

  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

  <!-- admin dialog (client-side only) -->
  <div id="adminDialog" class="modal-backdrop" style="display:none">
    <div class="modal small" role="dialog">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Admin</h3>
        <button id="adminClose" class="btn small">Close</button>
      </div>
      <div id="adminBody"></div>
    </div>
  </div>

<script>
/* ---------- utilities ---------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
const mainArea = $('#mainArea');

/* ---------- state ---------- */
let products = [];
let cart = JSON.parse(localStorage.getItem('cart')||'[]');
let storeCredits = JSON.parse(localStorage.getItem('storeCredits')||'{}');
let credits = Number(localStorage.getItem('storeCredit')||0);
let dark = localStorage.getItem('theme') === 'dark';
const ADMIN_FLAG_KEY = 'ninjago_admin_pass_hash'; // used only for local password fallback

/* ---------- theme ---------- */
function applyTheme(){
  document.documentElement.classList.toggle('dark', dark);
  $('#themeToggle').textContent = dark ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', dark ? 'dark':'light');
}
$('#themeToggle').onclick = ()=> { dark = !dark; applyTheme(); }
applyTheme();

/* ---------- load products.json ---------- */
async function load(){
  try{
    const res = await fetch('products.json', {cache:'no-store'});
    products = await res.json();
  }catch(e){
    mainArea.innerHTML = '<p class="error">Failed to load products.json ‚Äî check file.</p>';
    console.error(e);
    return;
  }
  renderCategoriesView();
  renderCartCount();
  attachSearch();
  loadChatFloating();
}
load();

/* ---------- categories view ---------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function categoryIconName(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Polybags':'üõçÔ∏è','Books':'üìö','Miscs':'‚öôÔ∏è','Books (Rent)':'üìñ'};
  return map[cat]||'üì¶';
}
function renderCategoriesView(){
  mainArea.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className='categories-grid';
  cats.forEach((cat,i)=>{
    const tile = document.createElement('button');
    tile.className='category-tile';
    const count = products.filter(p=>p.category===cat).length;
    tile.innerHTML = `<div class="cat-emoji">${categoryIconName(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${count} items</div>`;
    wrap.appendChild(tile);
    setTimeout(()=>tile.classList.add('show'), 70*i);
    tile.onclick = ()=> renderCategoryPage(cat);
  });
  mainArea.appendChild(wrap);
}

/* ---------- category page ---------- */
function renderCategoryPage(category){
  mainArea.innerHTML = `
    <div class="category-header">
      <button id="catBack" class="btn small">‚Üê Back</button>
      <h2>${escapeHtml(category)}</h2>
      <div class="controls-inline">
        <select id="subFilter" class="small"></select>
        <button id="clearFilter" class="small">Clear</button>
      </div>
    </div>
    <div id="categoryProducts"></div>
  `;
  $('#catBack').onclick = ()=> renderCategoriesView();

  const items = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  const sel = $('#subFilter');
  sel.innerHTML = `<option value="">All subthemes</option>` + subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  $('#clearFilter').onclick = ()=> { sel.value=''; renderCategoryProducts(category); };
  sel.onchange = ()=> renderCategoryProducts(category, sel.value);
  renderCategoryProducts(category);
}

function renderCategoryProducts(category, subfilter){
  const cont = $('#categoryProducts');
  const search = ($('#search')?$('#search').value.trim().toLowerCase():'');
  const hardOnly = $('#showHardToFindOnly').checked;
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'') === subfilter);
  if(search) items = items.filter(p => (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(search));
  if(hardOnly) items = items.filter(p=> p.hard_to_find );
  if(items.length === 0){ cont.innerHTML = '<p class="hint">No items found.</p>'; return; }

  const grid = document.createElement('div'); grid.className = 'grid large';
  items.forEach((p,i)=>{
    const thumb = Array.isArray(p.image) ? p.image[0] : p.image;
    // badges
    const badges = [];
    if(p.hard_to_find) badges.push('<span class="badge hard">Hard to find</span>');
    if(p.price_discounted) badges.push(`<span class="badge sale">${p.price_discounted_text||'Discount'}</span>`);
    const pieceInfo = (p.piece_count? `${p.piece_count} pcs` : '') + (p.figures_count? ` ‚Ä¢ ${p.figures_count} figs` : '');
    const price = p.price_sar ? `SAR ${p.price_sar}` : '-';
    grid.insertAdjacentHTML('beforeend', `
      <article class="card big show">
        <div class="card-media"><img src="${thumb}" alt="${escapeHtml(p.title)}"></div>
        <div class="card-body">
          <h3>${escapeHtml(p.title)}</h3>
          <div class="meta">${escapeHtml(p.origin||p.subtheme||'')}</div>
          <div class="meta small-note">${escapeHtml(p.condition||'')}</div>
          <div class="meta">${escapeHtml(pieceInfo)}</div>
          <div class="price-row"><div class="price">${price}</div><div class="badges">${badges.join(' ')}</div></div>
          <div class="card-actions">
            <button class="btn view" data-id="${p.id}">View</button>
            <button class="small add" data-id="${p.id}">‚ûï Add</button>
          </div>
        </div>
      </article>
    `);
    setTimeout(()=> {
      const c = grid.children[grid.children.length-1];
      c.classList.add('show');
    }, 60*i);
  });
  cont.innerHTML = ''; cont.appendChild(grid);
  attachCardEvents();
}

/* ---------- search ---------- */
function attachSearch(){
  const s = $('#search');
  if(!s) return;
  s.addEventListener('input', ()=>{
    const catHeader = document.querySelector('.category-header');
    if(catHeader){
      const cat = catHeader.querySelector('h2').textContent;
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      renderCategoryProducts(cat, sub);
    } else {
      renderCategoriesView();
      const q = s.value.trim();
      if(!q) return;
      const results = products.filter(p=> (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(q.toLowerCase()));
      if(results.length){
        const resWrap = document.createElement('div'); resWrap.className='search-results';
        resWrap.innerHTML = `<h3 class="section-title">Quick results</h3><div class="grid large"></div>`;
        results.forEach(p=> resWrap.querySelector('.grid').insertAdjacentHTML('beforeend', `<article class="card big show"><div class="card-media"><img src="${Array.isArray(p.image)?p.image[0]:p.image}"></div><div class="card-body"><h3>${escapeHtml(p.title)}</h3><div class="meta">${escapeHtml(p.category||'')}</div><div class="price">SAR ${p.price_sar||'-'}</div><div class="card-actions"><button class="btn view" data-id="${p.id}">View</button></div></div></article>`));
        mainArea.appendChild(resWrap);
        attachCardEvents();
      }
    }
  });
}

/* ---------- card events ---------- */
function attachCardEvents(){
  $$('.view').forEach(b=> b.onclick = ()=> openDetail(b.dataset.id));
  $$('.add').forEach(b=> b.onclick = ()=> addToCart(b.dataset.id));
}

/* ---------- modal detail ---------- */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image)?p.image:[p.image];
  $('#modal').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>${escapeHtml(p.title)}</h2>
      <div><button id="closeModal" class="btn small">Close</button></div>
    </div>
    <div class="modal-grid">
      <div>
        <div class="gallery">
          <div class="gallery-main"><img id="galleryMain" src="${imgs[0]}" alt="${escapeHtml(p.title)}"></div>
          <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${u}" src="${u}">`).join('')}</div>
        </div>
        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count? p.piece_count + ' pcs' : ''} ${p.figures_count? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="price">SAR ${p.price_sar||'-'}</div>
        <div style="margin-top:8px"><button class="btn" id="modalAdd">Add to cart</button> <button class="small" id="modalBuy">Buy now</button></div>
        <div class="notes">${escapeHtml(p.notes||'')}</div>
        <div class="recommended">
          <h4>Recommended</h4>
          ${(p.recommended||[]).map(id=>{ const r=products.find(x=>x.id===id); return r? `<div class="rec-item"><img src="${Array.isArray(r.image)?r.image[0]:r.image}"><div><strong>${escapeHtml(r.title)}</strong><div class="meta">SAR ${r.price_sar||'-'}</div></div></div>` : ''}).join('')}
        </div>
      </div>

      <aside>
        <div class="cart-mini">
          <h4>Quick cart</h4>
          <div id="quickCartList" class="cart-list"></div>
          <div class="order-summary" id="quickSummary"></div>
          <div style="margin-top:8px"><button class="btn" id="gotoCheckout">Go to checkout</button></div>
        </div>
      </aside>
    </div>
  `;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  $('#closeModal').onclick = closeModal;
  $('#modalAdd').onclick = ()=>{ addToCart(p.id); updateQuickCart(); }
  $('#modalBuy').onclick = ()=>{ addToCart(p.id); openCheckout(); }
  $('#gotoCheckout').onclick = openCheckout;
  $$('.gthumb').forEach(t=> t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); });
  updateQuickCart();
}
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=>$('#modalBackdrop').classList.remove('show'),200); }

/* ---------- cart ---------- */
function addToCart(id){
  const p = products.find(x=>x.id===id); if(!p) return;
  const item = cart.find(c=>c.id===id);
  if(item) item.qty++; else cart.push({id:p.id,title:p.title,price:p.price_sar||0,qty:1,image: Array.isArray(p.image)?p.image[0]:p.image});
  localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); updateQuickCart();
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0) }
function updateQuickCart(){
  const el = $('#quickCartList'); const sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

/* ---------- checkout ---------- */
function openCheckout(){
  $('#modal').innerHTML = checkoutHtml();
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  renderCheckoutCart();
  $('#closeModal2').onclick = closeModal;
  $('#cashPay').onclick = handleCashPay;
  $('#giftPay').onclick = handleGiftPay;
}
function checkoutHtml(){
  return `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Checkout</h2><div><button id="closeModal2" class="btn small">Close</button></div></div>
    <div class="checkout-grid">
      <div>
        <h4>Cart</h4><div id="checkoutCart"></div><div class="order-summary" id="checkoutSummary"></div>
      </div>
      <div class="pay-panel">
        <h4>Reserve with cash</h4>
        <input id="custName" class="input" placeholder="Full name">
        <input id="custEmail" class="input" placeholder="Email (optional)">
        <input id="custDate" class="input" type="date">
        <textarea id="custMsg" class="textarea" placeholder="Message or pickup instructions"></textarea>
        <button class="btn" id="cashPay">Reserve (cash)</button>

        <h4 style="margin-top:12px">Pay with Giftcard</h4>
        <input id="giftCode" class="input" placeholder="Giftcard code">
        <input id="giftAmount" class="input" placeholder="Amount (SAR)" type="number" min="0" step="0.01">
        <button class="btn" id="giftPay">Redeem Giftcard</button>
        <div class="hint">If you overpay, remainder becomes in-store credit (if email provided).</div>
      </div>
    </div>`;
}
function renderCheckoutCart(){
  const el = $('#checkoutCart'); const sumEl = $('#checkoutSummary');
  el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}
function handleCashPay(){
  const name = $('#custName').value.trim(); if(!name){ alert('Enter name'); return; }
  const date = $('#custDate').value; const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const order = { id:'order-'+Date.now(), name, date, email:$('#custEmail').value, cart, total, method:'cash', msg:$('#custMsg').value, created:Date.now() };
  let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
  alert('Cash reservation saved. ID: ' + order.id);
  cart = []; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategoryViewAfterOrder();
}
async function handleGiftPay(){
  // Flow: attempt server redeem (if /api/giftcards exists) else local fallback (no validation)
  const code = $('#giftCode').value.trim(); const amount = Number($('#giftAmount').value) || 0;
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  if(!code){ alert('Enter giftcard code'); return; }
  try {
    const res = await fetch('/api/giftcards', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'redeem', code, amount, total, email: $('#custEmail') ? $('#custEmail').value : '' }) });
    const body = await res.json();
    if(!res.ok) throw new Error(body.error || 'Redeem failed');
    alert(`Redeemed SAR ${body.deducted}. Remaining card balance: SAR ${body.remainingBalance}. Store credit given: SAR ${body.creditGiven || 0}`);
    // save order
    const order = { id:'order-'+Date.now(), cart, total, paid: body.deducted, method:'giftcard', code, created:Date.now() };
    let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    cart=[]; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategoryViewAfterOrder();
  } catch(e){
    // fallback: accept as partial without validation (warn user)
    if(!confirm('Giftcard server not available or redeem failed. Proceed with local fallback (no validation)?')) return;
    const order = { id:'order-'+Date.now(), cart, total, paid: Math.min(amount,total), method:'giftcard-fallback', code, created:Date.now() };
    let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    alert('Order saved locally (no server validation).');
    cart=[]; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategoryViewAfterOrder();
  }
}

/* ---------- keep view ---------- */
function renderCategoryViewAfterOrder(){
  const catHeader = document.querySelector('.category-header');
  if(catHeader){ const cat = catHeader.querySelector('h2').textContent; const sub = $('#subFilter')?$('#subFilter').value:''; renderCategoryProducts(cat, sub); } else renderCategoriesView();
}

/* ---------- cart button ---------- */
$('#cartBtn').onclick = ()=> openCheckout();

/* ---------- floating request chat ---------- */
function loadChatFloating(){
  if(document.querySelector('.chat-floating')) return;
  const wrap = document.createElement('div'); wrap.className='chat-floating';
  wrap.innerHTML = `<div class="chat-head">Request product üí¨</div><div class="chat-body"><div id="miniChat" class="chat"></div><div style="display:flex;gap:8px;margin-top:6px"><input id="miniReq" class="input" placeholder="Request a set or figure"><button id="miniSend" class="btn small">Send</button></div></div>`;
  document.body.appendChild(wrap);
  $('#miniSend').onclick = ()=> {
    const text = $('#miniReq').value.trim(); if(!text) return;
    const m = { from:'user', text, time:Date.now() };
    const existing = JSON.parse(localStorage.getItem('requests')||'[]'); existing.push(m); localStorage.setItem('requests', JSON.stringify(existing));
    $('#miniReq').value='';
    setTimeout(()=>{ const reply = { from:'owner', text:'Thanks ‚Äî noted: ' + text }; const e2 = JSON.parse(localStorage.getItem('requests')||'[]'); e2.push(reply); localStorage.setItem('requests', JSON.stringify(e2)); renderMiniChat(); }, 600);
    renderMiniChat();
  }
  renderMiniChat();
}
function renderMiniChat(){ const mini = $('#miniChat'); if(!mini) return; const all = JSON.parse(localStorage.getItem('requests')||'[]'); mini.innerHTML = all.map(m=>`<div class="msg ${m.from==='user'?'user':'owner'}">${escapeHtml(m.text)}</div>`).join('') || '<div class="meta">No requests yet.</div>'; }

/* ---------- admin (client-side) ---------- */
$('#adminOpen').onclick = (e)=> { e.preventDefault(); openAdminDialog(); };
$('#adminClose').onclick = ()=> { $('#adminDialog').style.display='none'; };

async function openAdminDialog(){
  $('#adminDialog').style.display='flex';
  // check if server api is available
  let serverAvailable = false;
  try { const r = await fetch('/api/health'); serverAvailable = r.ok; } catch(e){ serverAvailable = false; }
  const adminBody = $('#adminBody'); adminBody.innerHTML = `
    <div><strong>Admin panel</strong></div>
    <div id="adminAuth"></div>
    <div id="adminContent" style="display:none"></div>
  `;
  // require password (local fallback) or ADMIN_SECRET (server)
  const auth = $('#adminAuth');
  auth.innerHTML = `<p>Enter admin password to continue (local fallback). If server admin is configured, you'll be asked for server secret later.</p>
    <input id="adminPass" class="input" placeholder="Admin password"><div style="display:flex;gap:8px;margin-top:8px"><button id="adminEnter" class="btn">Enter</button><button id="adminSet" class="small">Set / Reset local password</button></div>`;
  $('#adminEnter').onclick = async ()=> {
    const pass = $('#adminPass').value || '';
    if(!pass) return alert('Enter password');
    const hash = await sha256(pass);
    const stored = localStorage.getItem(ADMIN_FLAG_KEY);
    if(stored && stored === hash){
      showAdminContent(true);
    } else {
      // if server available, allow user to enter server secret
      if(serverAvailable){
        const secret = prompt('Server admin available. Enter server ADMIN_SECRET to proceed (will not be stored):');
        if(secret){
          // try server ping
          try {
            const r = await fetch('/api/admin/ping', { method:'POST', headers: {'Content-Type':'application/json','x-admin-secret': secret }, body: '{}' });
            if(r.ok) { showAdminContent(false, secret); return; }
            alert('Server secret rejected.');
          } catch(e){ alert('Server not reachable.'); }
        }
      }
      alert('Local password mismatch. Use "Set / Reset local password" to set a local admin password on this browser.');
    }
  };
  $('#adminSet').onclick = async ()=> {
    const pass = prompt('Choose a local admin password (this stores a hash in your browser only):');
    if(!pass) return;
    const hash = await sha256(pass);
    localStorage.setItem(ADMIN_FLAG_KEY, hash);
    alert('Local admin password saved locally in this browser.');
  };
}

async function showAdminContent(localAuth=true, serverSecret=''){
  $('#adminAuth').style.display='none';
  const content = $('#adminContent'); content.style.display='block';
  content.innerHTML = `
    <h4>Orders (local)</h4><div id="adminOrders"></div>
    <h4>Requests</h4><div id="adminRequests"></div>
    <h4>Giftcards (server only)</h4><div id="adminGiftcards"></div>
  `;
  const orders = JSON.parse(localStorage.getItem('orders')||'[]');
  $('#adminOrders').innerHTML = orders.length ? orders.map(o=>`<div class="order"><strong>${o.id}</strong> ‚Ä¢ ${o.method || ''} ‚Ä¢ SAR ${o.total||o.paid||0}</div>`).join('') : '<div class="meta">No local orders</div>';
  const reqs = JSON.parse(localStorage.getItem('requests')||'[]');
  $('#adminRequests').innerHTML = reqs.length ? reqs.map(r=>`<div class="req">${r.from}: ${escapeHtml(r.text)}</div>`).join('') : '<div class="meta">No requests</div>';
  if(serverSecret){
    try {
      const r = await fetch('/api/giftcards', { headers: {'x-admin-secret': serverSecret }});
      if(r.ok){ const j = await r.json(); $('#adminGiftcards').innerHTML = j.length ? j.map(gc=>`<div>${escapeHtml(gc.code)} ‚Ä¢ SAR ${gc.balance}</div>`).join('') : '<div class="meta">No giftcards</div>'; }
    } catch(e){ $('#adminGiftcards').innerHTML = '<div class="meta">Server error fetching giftcards</div>'; }
  } else {
    $('#adminGiftcards').innerHTML = '<div class="meta">Server admin not connected</div>';
  }
}

/* ---------- utils: sha256 ---------- */
async function sha256(str){
  const buf = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ---------- keyboard ---------- */
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ $('#modalBackdrop').classList.remove('show'); $('#modal').classList.remove('show'); } });

</script>
</body>
</html>
