<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Marketplace</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div>
      <div class="logo">Ninjago Marketplace</div>
      <div class="subtitle">Official images only ‚Ä¢ Request ‚Ä¢ Reserve</div>
    </div>
    <div class="controls">
      <input id="search" class="search" placeholder="Search sets, figures, books...">
      <button id="themeToggle" class="btn small">üåì</button>
      <div id="cartBtn" class="btn">üõí <span id="cartCount">0</span></div>
      <a class="btn small" id="adminBtn" href="#" target="_blank" rel="noopener noreferrer">Admin</a>
    </div>
  </header>

  <main class="container">
    <div class="top-row">
      <div class="hint">Click a category to open subtheme tiles. Products use official LEGO pages where available.</div>
    </div>

    <div id="mainArea" class="main-area"></div>
  </main>

  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

<script>
/* helper + state */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
let products = [];
let cart = JSON.parse(localStorage.getItem('cart')||'[]');
let credits = Number(localStorage.getItem('storeCredit')||0);
const mainArea = $('#mainArea');

/* theme */
function loadTheme(){
  const t = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', t);
  $('#themeToggle').innerText = t === 'dark' ? 'üåû' : 'üåô';
}
$('#themeToggle').onclick = ()=> {
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  $('#themeToggle').innerText = next === 'dark' ? 'üåû' : 'üåô';
};

/* load products.json */
async function load(){
  try{
    const res = await fetch('products.json');
    products = await res.json();
  } catch(e){
    mainArea.innerHTML = '<p style="color:salmon">Failed to load products.json ‚Äî check file.</p>'; console.error(e); return;
  }
  loadTheme();
  renderCategoriesView();
  renderCartCount();
  attachSearch();
}
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function categoryIconName(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Polybags':'üßæ','Miscs':'üîß','Books':'üìö','Books (Rent)':'üìñ'};
  return map[cat]||'üì¶';
}

/* categories */
function renderCategoriesView(){
  mainArea.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className='categories-grid';
  cats.forEach((cat,i)=>{
    const el = document.createElement('button');
    el.className='category-tile';
    el.innerHTML = `<div class="cat-emoji">${categoryIconName(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${products.filter(p=>p.category===cat).length} items</div>`;
    wrap.appendChild(el);
    setTimeout(()=> el.classList.add('show'), 80*i);
    el.onclick = ()=> renderCategoryPage(cat);
  });
  mainArea.appendChild(wrap);
}

/* category page + products grid (bigger cards for sets) */
function renderCategoryPage(category){
  mainArea.innerHTML = `
    <div class="category-header">
      <button id="catBack" class="btn small">‚Üê Back</button>
      <h2>${escapeHtml(category)}</h2>
      <div class="controls-inline">
        <select id="subFilter" class="small"></select>
        <button id="clearFilter" class="small">Clear</button>
      </div>
    </div>
    <div id="categoryProducts"></div>
  `;
  $('#catBack').onclick = ()=> renderCategoriesView();
  const items = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  const sel = $('#subFilter');
  sel.innerHTML = `<option value="">All subthemes</option>` + subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  $('#clearFilter').onclick = ()=> { sel.value=''; renderCategoryProducts(category); };
  sel.onchange = ()=> renderCategoryProducts(category, sel.value);
  renderCategoryProducts(category);
}
function renderCategoryProducts(category, subfilter){
  const cont = $('#categoryProducts');
  const search = ($('#search')?$('#search').value.trim().toLowerCase():'');
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'')===subfilter);
  if(search) items = items.filter(p => (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(search));
  if(items.length===0){ cont.innerHTML = '<p class="hint">No items found.</p>'; return; }

  const grid = document.createElement('div'); grid.className='grid';
  items.forEach((p,i)=>{
    const thumb = Array.isArray(p.image) ? p.image[0] : p.image;
    // if image is a lego product page, we show a badge and use placeholder until you fetch CDN images
    const isOfficialPage = typeof thumb === 'string' && (thumb.includes('lego.com/') || thumb.includes('lego.com'));
    const imgSrc = isOfficialPage ? 'images/lego-official-placeholder.jpg' : thumb;
    const extraClass = (category === 'Sets') ? 'card-large' : 'card';
    const hardBadge = p.hard_to_find ? `<div class="badge">Hard to find</div>`: '';
    grid.insertAdjacentHTML('beforeend', `
      <div class="${extraClass} card-anim">
        <div class="imgwrap">
          <img src="${imgSrc}" data-official="${isOfficialPage?escapeHtml(thumb):''}" alt="${escapeHtml(p.title)}">
          ${hardBadge}
        </div>
        <h3>${escapeHtml(p.title)}</h3>
        <div class="meta">${escapeHtml(p.origin||'')}</div>
        <div class="meta small">${escapeHtml(p.condition||'')}</div>
        <div class="price">SAR ${p.price_sar}</div>
        <div class="contact">
          <button class="btn view" data-id="${p.id}">View</button>
          <button class="small add" data-id="${p.id}">‚ûï</button>
        </div>
      </div>
    `);
    setTimeout(()=> { grid.lastChild.classList.add('show') }, 60*i);
  });
  cont.innerHTML = ''; cont.appendChild(grid);
  attachCardEvents();
}

/* search */
function attachSearch(){
  const s = $('#search'); if(!s) return;
  s.addEventListener('input', ()=> {
    const catHeader = document.querySelector('.category-header');
    if(catHeader){
      const cat = catHeader.querySelector('h2').textContent;
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      renderCategoryProducts(cat, sub);
    } else {
      renderCategoriesView();
      const q = s.value.trim();
      if(!q) return;
      const results = products.filter(p=> (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(q.toLowerCase()));
      if(results.length){
        const resWrap = document.createElement('div'); resWrap.className='search-results';
        resWrap.innerHTML = `<h3 class="section-title">Quick results</h3><div class="grid"></div>`;
        results.forEach(p=> resWrap.querySelector('.grid').insertAdjacentHTML('beforeend', `<div class="card card-anim show"><img src="${(Array.isArray(p.image)?p.image[0]:p.image)}"><h3>${escapeHtml(p.title)}</h3><div class="meta">${escapeHtml(p.category)}</div><div class="price">SAR ${p.price_sar}</div><div class="contact"><button class="btn view" data-id="${p.id}">View</button></div></div>`));
        mainArea.appendChild(resWrap);
        attachCardEvents();
      }
    }
  });
}

/* card events */
function attachCardEvents(){
  $$('.view').forEach(btn=> btn.onclick = ()=> openDetail(btn.dataset.id));
  $$('.add').forEach(btn=> btn.onclick = ()=> addToCart(btn.dataset.id));
}

/* modal detail */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  const imgs = Array.isArray(p.image)? p.image : [p.image];
  $('#modal').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>${escapeHtml(p.title)}</h2>
      <div><button id="closeModal" class="btn small">Close</button></div>
    </div>
    <div class="modal-grid">
      <div>
        <div class="gallery">
          <div class="gallery-main"><img id="galleryMain" src="${resolveImage(imgs[0])}" alt=""></div>
          <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${resolveImage(u)}" src="${resolveImage(u)}">`).join('')}</div>
        </div>
        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count ? p.piece_count + ' pcs' : ''} ${p.figures_count? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="price">SAR ${p.price_sar}</div>
        <div style="margin-top:8px">
          <button class="btn" id="modalAdd">Add to cart</button>
          <button class="small" id="modalBuy">Buy now</button>
        </div>
      </div>
      <aside>
        <div class="cart-mini">
          <h4>Quick cart</h4>
          <div id="quickCartList" class="cart-list"></div>
          <div class="order-summary" id="quickSummary"></div>
          <div style="margin-top:8px"><button class="btn" id="gotoCheckout">Go to checkout</button></div>
        </div>
      </aside>
    </div>
  `;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  $('#closeModal').onclick = closeModal;
  $('#modalAdd').onclick = ()=>{ addToCart(p.id); updateQuickCart(); }
  $('#modalBuy').onclick = ()=>{ addToCart(p.id); openCheckout(); }
  $('#gotoCheckout').onclick = openCheckout;

  $$('.gthumb').forEach(t=> t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); });
  updateQuickCart();
}
function resolveImage(u){
  if(!u) return 'images/placeholder.jpg';
  // if it's a lego product page, return placeholder and set data-official for later replacement
  if(typeof u === 'string' && (u.includes('lego.com') || u.includes('lego'))){
    return 'images/lego-official-placeholder.jpg';
  }
  return u;
}
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=>$('#modalBackdrop').classList.remove('show'),200); }

/* cart */
function addToCart(id){
  const p = products.find(x=>x.id===id); if(!p) return;
  const item = cart.find(c=>c.id===id);
  if(item) item.qty++; else cart.push({id:p.id,title:p.title,price:p.price_sar,qty:1,image:Array.isArray(p.image)?p.image[0]:p.image});
  localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); updateQuickCart();
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0) }
function updateQuickCart(){
  const el = $('#quickCartList'); const sumEl = $('#quickSummary'); if(!el) return;
  el.innerHTML = cart.map(it=>`<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><img src="${it.image}" style="width:48px;height:40px;object-fit:cover;border-radius:6px"><div style="flex:1"><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0); sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

/* checkout (kept simple, same as demo) */
function openCheckout(){ /* identical to previous checkout code ‚Äî omitted for brevity in chat */ alert('Checkout modal (same as demo).'); }
$('#cartBtn').onclick = ()=> openCheckout();

/* admin gating: basic client-side password prompt to access admin.html */
$('#adminBtn').onclick = (e)=> {
  e.preventDefault();
  const pw = prompt('Enter admin password:');
  if(!pw) return;
  const ok = pw === (localStorage.getItem('adminPwd') || 'letmein'); // default password 'letmein' for local admin (change in admin)
  if(ok){
    // open admin.html in new tab
    window.open('admin.html','_blank','noopener');
  } else {
    alert('Wrong password');
  }
};

/* search + init */
attachSearch();
load();

/* keyboard: escape */
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ document.getElementById('modalBackdrop').classList.remove('show'); document.getElementById('modal').classList.remove('show'); }});
</script>
</body>
</html>
