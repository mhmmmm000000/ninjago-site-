<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Marketplace</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="left-head">
      <div class="logo">Ninjago Marketplace</div>
      <div class="subtitle">Browse ‚Ä¢ Request ‚Ä¢ Reserve ‚Ä¢ Giftcard</div>
    </div>
    <div class="controls">
      <input id="search" class="search" placeholder="Search sets, figures, books...">
      <button id="themeToggle" class="btn small" title="Toggle theme">üåô</button>
      <button id="feedbackBtn" class="btn small">Feedback</button>
      <button id="cartBtn" class="btn">üõí <span id="cartCount">0</span></button>
      <button id="adminOpen" class="btn small">Admin</button>
    </div>
  </header>

  <main class="container">
    <div class="top-row">
      <div class="hint">Click a category to enter it. Click a product box to view details. Mobile/tablet supported ‚Äî pinch to zoom product image.</div>
    </div>
    <div id="mainArea" class="main-area"></div>
  </main>

  <!-- Modals & overlays -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

  <!-- Feedback modal -->
  <div id="feedbackModal" class="modal-hidden">
    <div class="modal-card">
      <div class="modal-header"><strong>Send feedback</strong><button id="feedbackClose" class="small">Close</button></div>
      <div class="modal-body">
        <input id="fbName" class="input" placeholder="Your name (optional)">
        <input id="fbEmail" class="input" placeholder="Email (optional)">
        <textarea id="fbMsg" class="textarea" placeholder="Message"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="fbSubmit" class="btn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Request floating -->
  <div id="reqFloating" class="chat-floating">
    <div class="chat-head">
      Request product üí¨
      <div style="float:right;">
        <button id="reqMin" class="small">‚àí</button>
      </div>
    </div>
    <div id="reqBody" class="chat-body">
      <div id="miniChat" class="chat"></div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <input id="miniName" class="input" placeholder="Your name (optional)">
        <select id="miniType" class="small">
          <option>Set</option><option>Figure</option><option>Box/Instructions</option><option>Other</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <input id="miniReq" class="input" placeholder="What would you like to request?">
        <button id="miniSend" class="btn small">Send</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Helpers ---------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
const ADMIN_PASSWORD = 'M.O.D8643'; // WARNING: client-side password (not secure) ‚Äî you asked for HTML-only

/* ---------- State ---------- */
let products = [];
let cart = JSON.parse(localStorage.getItem('cart')||'[]');
let credits = Number(localStorage.getItem('storeCredit')||0);
const mainArea = $('#mainArea');

/* ---------- Load products.json ---------- */
async function loadProducts(){
  try{
    const res = await fetch('products.json');
    products = await res.json();
  } catch(e){
    mainArea.innerHTML = '<p class="hint error">Failed to load products.json ‚Äî check file.</p>';
    console.error(e);
    return;
  }
  initTheme();
  renderCategoriesView();
  renderCartCount();
  attachSearch();
  initFloatingRequest();
  initFeedback();
}

/* ---------- Theme ---------- */
function initTheme(){
  const t = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
  $('#themeToggle').textContent = t==='dark' ? 'üåô' : '‚òÄÔ∏è';
  $('#themeToggle').onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = cur==='dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    $('#themeToggle').textContent = next==='dark' ? 'üåô' : '‚òÄÔ∏è';
  }
}

/* ---------- Categories / Tiles ---------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function categoryIcon(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Polybags':'üéí','Miscs':'‚öôÔ∏è','Books':'üìö','Books (Rent)':'üìñ'};
  return map[cat] || 'üì¶';
}
function renderCategoriesView(){
  mainArea.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className='categories-grid';
  cats.forEach((cat,i)=>{
    const count = products.filter(p=>p.category===cat).length;
    const btn = document.createElement('button'); btn.className='category-tile';
    btn.innerHTML = `<div class="cat-emoji">${categoryIcon(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${count} items</div>`;
    wrap.appendChild(btn);
    setTimeout(()=>btn.classList.add('show'), 50*i);
    btn.onclick = ()=> renderCategoryPage(cat);
  });
  mainArea.appendChild(wrap);
}

/* ---------- Category page ---------- */
function renderCategoryPage(category){
  mainArea.innerHTML = `
    <div class="category-header">
      <button id="catBack" class="btn small">‚Üê Back</button>
      <h2>${escapeHtml(category)}</h2>
      <div class="controls-inline">
        <select id="subFilter" class="small"></select>
        <button id="clearFilter" class="small">Clear</button>
      </div>
    </div>
    <div id="categoryProducts"></div>
  `;
  $('#catBack').onclick = renderCategoriesView;
  const items = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  const sel = $('#subFilter'); sel.innerHTML = `<option value="">All</option>${subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('')}`;
  sel.onchange = ()=> renderCategoryProducts(category, sel.value);
  $('#clearFilter').onclick = ()=> { sel.value=''; renderCategoryProducts(category); };
  renderCategoryProducts(category);
}
function renderCategoryProducts(category, subfilter){
  const cont = $('#categoryProducts');
  const search = ($('#search')?$('#search').value.trim().toLowerCase():'');
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'')===subfilter);
  if(search) items = items.filter(p => (p.title+p.origin+(p.subtheme||'')).toLowerCase().includes(search));
  if(items.length===0){ cont.innerHTML = '<p class="hint">No items found.</p>'; return; }
  const grid = document.createElement('div'); grid.className='grid';
  items.forEach((p,i)=>{
    const thumb = Array.isArray(p.image) ? p.image[0] : p.image;
    const hard = p.hard_to_find ? '<span class="hard">Hard to find</span>' : '';
    const noteBadge = p.notes ? `<div class="note-badge">${escapeHtml(p.notes)}</div>` : '';
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="card-inner">
        <div class="thumb-wrap"><img loading="lazy" src="${thumb}" alt="${escapeHtml(p.title)}" onerror="this.src='images/placeholder.jpg'"></div>
        <div class="card-body">
          <h3>${escapeHtml(p.title)} ${hard}</h3>
          <div class="meta">${escapeHtml(p.origin||'')}</div>
          <div class="meta">${escapeHtml(p.condition||'')}</div>
          <div class="price">SAR ${p.price_sar}${p.price_discounted? '  <span class="discount">SAR '+p.price_discounted+'</span>':''}</div>
          ${noteBadge}
        </div>
      </div>
    `;
    // open product on whole card click
    card.onclick = (e)=> {
      // avoid double open when clicking buttons inside later
      if(e.target.tagName.toLowerCase() === 'button') return;
      openDetail(p.id);
    };
    grid.appendChild(card);
    setTimeout(()=>card.classList.add('show'), 40*i);
  });
  cont.innerHTML = ''; cont.appendChild(grid);
}

/* ---------- search ---------- */
function attachSearch(){
  const s = $('#search');
  if(!s) return;
  s.addEventListener('input', ()=> {
    const catHeader = document.querySelector('.category-header');
    if(catHeader){
      const cat = catHeader.querySelector('h2').textContent;
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      renderCategoryProducts(cat, sub);
    } else {
      renderCategoriesView();
      const q = s.value.trim();
      if(!q) return;
      const results = products.filter(p=> (p.title+p.origin+(p.subtheme||'')).toLowerCase().includes(q.toLowerCase()));
      if(results.length){
        const resWrap = document.createElement('div'); resWrap.className='search-results';
        resWrap.innerHTML = `<h3 class="section-title">Quick results</h3><div class="grid"></div>`;
        results.forEach(p=> resWrap.querySelector('.grid').insertAdjacentHTML('beforeend', `<div class="card show"><img src="${Array.isArray(p.image)?p.image[0]:p.image}"><h3>${escapeHtml(p.title)}</h3><div class="meta">${escapeHtml(p.category)}</div><div class="price">SAR ${p.price_sar}</div></div>`));
        mainArea.appendChild(resWrap);
      }
    }
  });
}

/* ---------- Product detail modal (gallery) ---------- */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image) ? p.image : [p.image];
  $('#modal').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>${escapeHtml(p.title)}</h2>
      <div><button id="closeModal" class="btn small">Close</button></div>
    </div>
    <div class="modal-grid">
      <div>
        <div class="gallery">
          <div class="gallery-main"><img id="galleryMain" src="${imgs[0]}" onerror="this.src='images/placeholder.jpg'"></div>
          <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${u}" src="${u}" onerror="this.src='images/placeholder.jpg'">`).join('')}</div>
        </div>

        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count? p.piece_count + ' pcs' : ''} ${p.figures_count? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="price">SAR ${p.price_sar}${p.price_discounted? ` ‚Ä¢ <span class="discount">SAR ${p.price_discounted}</span>` : ''}</div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="reserveCash" class="btn pay-cash">Reserve with cash</button>
          <button id="payGift" class="btn pay-gift">Pay with giftcard</button>
        </div>

        <div class="price-compare">
          <h4>Price comparisons</h4>
          ${(p.price_comparisons||[]).map(c=>`<div class="item ${c.overpriced? 'over':''}"><a href="${c.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(c.site)}</a><div>${escapeHtml(c.price)}</div></div>`).join('')}
        </div>

        <div class="recommended">
          <h4>Recommended</h4>
          ${(p.recommended||[]).map(id=>{
            const r = products.find(x=>x.id===id);
            return r ? `<div class="rec-item"><img src="${Array.isArray(r.image)?r.image[0]:r.image}" onerror="this.src='images/placeholder.jpg'"><div><strong>${escapeHtml(r.title)}</strong><div class="meta">SAR ${r.price_sar}</div></div></div>` : '';
          }).join('')}
        </div>
      </div>

      <aside>
        <div class="cart-mini">
          <h4>Quick cart</h4>
          <div id="quickCartList" class="cart-list"></div>
          <div class="order-summary" id="quickSummary"></div>
          <div style="margin-top:8px"><button class="btn" id="gotoCheckout">Go to checkout</button></div>
        </div>
      </aside>
    </div>
  `;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);

  $('#closeModal').onclick = closeModal;
  $$('.gthumb').forEach(t=> t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); });
  $('#reserveCash').onclick = ()=> reserveWithCash(p.id);
  $('#payGift').onclick = ()=> payWithGiftcard(p.id);
  $('#gotoCheckout').onclick = openCheckout;
  updateQuickCart();
}
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=>$('#modalBackdrop').classList.remove('show'),240); }

/* ---------- Cart & quick-cart ---------- */
function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const item = cart.find(c=>c.id===id);
  if(item) item.qty++; else cart.push({id:p.id,title:p.title,price:p.price_sar,qty:1,image: Array.isArray(p.image)?p.image[0]:p.image});
  localStorage.setItem('cart', JSON.stringify(cart));
  renderCartCount(); updateQuickCart();
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0) }
function updateQuickCart(){
  const el = $('#quickCartList'); const sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="mini-row"><img src="${it.image}" onerror="this.src='images/placeholder.jpg'"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

/* ---------- Checkout: simple flows ---------- */
function reserveWithCash(productId){
  // add single item to cart and open simplified reserve prompt
  const p = products.find(x=>x.id===productId);
  if(!p) return;
  addToCart(productId);
  openSimpleReserve();
}
function payWithGiftcard(productId){
  addToCart(productId);
  openSimpleGift();
}

function openCheckout(){
  // open modal with checkout summary and two clear buttons
  $('#modal').innerHTML = checkoutHtml();
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  renderCheckoutCart();
  $('#closeModal2').onclick = closeModal;
  $('#cashPay').onclick = handleCashPay;
  $('#giftPay').onclick = handleGiftPay;
}
function checkoutHtml(){
  return `<div class="checkout-wrap"><div style="display:flex;justify-content:space-between;align-items:center"><h2>Checkout</h2><div><button id="closeModal2" class="btn small">Close</button></div></div>
    <div class="checkout-grid">
      <div>
        <h4>Cart</h4><div id="checkoutCart"></div><div class="order-summary" id="checkoutSummary"></div>
      </div>
      <div>
        <h4>Reserve with Cash</h4>
        <div class="checkout-forms">
          <input id="custName" class="input" placeholder="Full name">
          <input id="custEmail" class="input" placeholder="Email (optional)">
          <input id="custDate" class="input" type="date">
          <textarea id="custMsg" class="textarea" placeholder="Pickup notes"></textarea>
          <button class="btn pay-cash" id="cashPay">Reserve with cash</button>
        </div>
        <h4 style="margin-top:12px">Pay with Giftcard</h4>
        <div class="checkout-forms">
          <input id="giftCode" class="input" placeholder="Giftcard code">
          <input id="giftAmount" class="input" placeholder="Amount (SAR)" type="number" min="0" step="0.01">
          <button class="btn pay-gift" id="giftPay">Pay with giftcard</button>
        </div>
        <div class="hint">Overpay becomes store credit (if you provide an email).</div>
      </div>
    </div></div>`;
}
function renderCheckoutCart(){
  const el = $('#checkoutCart'); const sumEl = $('#checkoutSummary');
  el.innerHTML = cart.map(it=>`<div class="mini-row"><img src="${it.image}" onerror="this.src='images/placeholder.jpg'"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}
function handleCashPay(){
  const name = $('#custName').value.trim(); if(!name){ alert('Enter name'); return; }
  const date = $('#custDate').value; const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const order = {id:'order-'+Date.now(),name,date,email:$('#custEmail').value,cart,total,method:'cash',msg:$('#custMsg').value,done:false,created:Date.now()};
  let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
  alert('Cash reservation saved ‚Äî Order ID: '+order.id);
  cart=[]; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategoryViewAfterOrder();
}
function handleGiftPay(){
  const code = $('#giftCode').value.trim() || ('GC-'+Math.floor(Math.random()*99999));
  const amount = Number($('#giftAmount').value) || 0;
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  // demo giftcards are kept in localStorage 'giftcards' as {code:balance}
  const giftcards = JSON.parse(localStorage.getItem('giftcards')||'{}');
  const available = giftcards[code] || 0;
  if(available <= 0){ alert('Giftcard not found or zero balance'); return; }
  const used = Math.min(available, amount || total);
  const remaining = +(available - used).toFixed(2);
  giftcards[code] = remaining;
  localStorage.setItem('giftcards', JSON.stringify(giftcards));
  // handle overpay -> store credit if provided
  if(amount > total){
    const credit = +(amount - total).toFixed(2);
    const email = $('#custEmail') ? $('#custEmail').value.trim().toLowerCase() : '';
    if(email){
      const sc = JSON.parse(localStorage.getItem('store_credits')||'{}'); sc[email] = +( (sc[email]||0) + credit ).toFixed(2); localStorage.setItem('store_credits', JSON.stringify(sc));
      alert(`Payment successful. Store credit SAR ${credit} added to ${email}`);
    } else {
      // return leftover to giftcard if no email
      giftcards[code] = +(giftcards[code] + credit).toFixed(2);
      localStorage.setItem('giftcards', JSON.stringify(giftcards));
      alert('No email provided ‚Äî leftover returned to giftcard');
    }
  } else {
    alert('Payment applied: SAR ' + used);
  }
  // save order
  const order = {id:'order-'+Date.now(),total,paid:amount,method:'giftcard',code,created:Date.now()};
  let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
  cart=[]; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategoryViewAfterOrder();
}

/* ---------- small helpers ---------- */
function openSimpleReserve(){ // quick reserve UI
  $('#modal').innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Reserve ‚Äî Cash</h2><div><button id="closeModalQuick" class="btn small">Close</button></div></div>
  <div style="padding:12px"><input id="quickName" class="input" placeholder="Full name"><input id="quickEmail" class="input" placeholder="Email (optional)"><input id="quickDate" class="input" type="date"><textarea id="quickMsg" class="textarea" placeholder="Notes"></textarea><div style="text-align:right"><button id="quickReserve" class="btn pay-cash">Reserve</button></div></div>`;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  $('#closeModalQuick').onclick = closeModal;
  $('#quickReserve').onclick = ()=> {
    const name = $('#quickName').value.trim(); if(!name){ alert('Name required'); return; }
    const date = $('#quickDate').value; const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
    const order = {id:'order-'+Date.now(),name,date,email:$('#quickEmail').value,cart,total,method:'cash',msg:$('#quickMsg').value,created:Date.now()};
    let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    alert('Reserved ‚Äî ID ' + order.id);
    cart=[]; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal();
  };
}
function openSimpleGift(){
  $('#modal').innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Pay ‚Äî Giftcard</h2><div><button id="closeModalGift" class="btn small">Close</button></div></div>
  <div style="padding:12px"><input id="giftCodeQuick" class="input" placeholder="Giftcard code"><input id="giftAmountQuick" class="input" placeholder="Amount (SAR)" type="number" min="0" step="0.01"><input id="giftEmailQuick" class="input" placeholder="Email (for credit)"><div style="text-align:right"><button id="giftConfirm" class="btn pay-gift">Pay</button></div></div>`;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  $('#closeModalGift').onclick = closeModal;
  $('#giftConfirm').onclick = ()=> {
    const code = $('#giftCodeQuick').value.trim(); const amount = Number($('#giftAmountQuick').value)||0; const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
    const giftcards = JSON.parse(localStorage.getItem('giftcards')||'{}'); const available = giftcards[code]||0;
    if(!available){ alert('Giftcard not found'); return; }
    const used = Math.min(available, amount || total);
    giftcards[code] = +(available - used).toFixed(2);
    localStorage.setItem('giftcards', JSON.stringify(giftcards));
    if(amount > total){
      const credit = +(amount - total).toFixed(2); const email = $('#giftEmailQuick').value.trim().toLowerCase();
      if(email){ const sc = JSON.parse(localStorage.getItem('store_credits')||'{}'); sc[email] = +( (sc[email]||0) + credit).toFixed(2); localStorage.setItem('store_credits', JSON.stringify(sc)); alert('Store credit added: SAR '+credit); }
      else { giftcards[code] = +(giftcards[code] + credit).toFixed(2); localStorage.setItem('giftcards', JSON.stringify(giftcards)); alert('Leftover returned to giftcard (no email provided)'); }
    } else { alert('Payment applied: SAR ' + used); }
    const order = {id:'order-'+Date.now(),total,paid:amount,method:'giftcard',code,created:Date.now()};
    let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    cart=[]; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal();
  };
}

/* ---------- Floating request box ---------- */
function initFloatingRequest(){
  if(document.querySelector('.chat-floating')) return;
  const mini = $('#miniChat');
  $('#miniSend').onclick = ()=> {
    const text = $('#miniReq').value.trim(); if(!text) return;
    const item = {id:'req-'+Date.now(), name: $('#miniName').value.trim(), type: $('#miniType').value, text, from:'user', time:Date.now()};
    const arr = JSON.parse(localStorage.getItem('requests')||'[]'); arr.push(item); localStorage.setItem('requests', JSON.stringify(arr));
    $('#miniReq').value='';
    loadMiniChat();
    // owner auto-reply (demo)
    setTimeout(()=>{ const arr2 = JSON.parse(localStorage.getItem('requests')||'[]'); arr2.push({id:'req-'+Date.now(), name:'Owner', type:'reply', text:'Thanks ‚Äî noted: ' + text, from:'owner', time:Date.now()}); localStorage.setItem('requests', JSON.stringify(arr2)); loadMiniChat(); }, 800);
  };
  loadMiniChat();
  $('#reqMin').onclick = ()=> {
    const body = $('#reqBody');
    if(body.style.display === 'none'){ body.style.display = 'block'; $('#reqMin').textContent = '‚àí'; }
    else { body.style.display = 'none'; $('#reqMin').textContent = '+'; }
  };
}
function loadMiniChat(){
  const mini = $('#miniChat'); const arr = JSON.parse(localStorage.getItem('requests')||'[]');
  mini.innerHTML = arr.slice(-12).map(m=>`<div class="msg ${m.from==='user'?'user':'owner'}">${escapeHtml((m.name?m.name+': ':'')+m.text)}</div>`).join('') || '<div class="meta">No requests yet.</div>';
}

/* ---------- Feedback ---------- */
function initFeedback(){
  $('#feedbackBtn').onclick = ()=> { $('#feedbackModal').classList.add('open'); };
  $('#feedbackClose').onclick = ()=> { $('#feedbackModal').classList.remove('open'); };
  $('#fbSubmit').onclick = ()=> {
    const f = {id:'fb-'+Date.now(), name:$('#fbName').value.trim(), email:$('#fbEmail').value.trim(), text:$('#fbMsg').value.trim(), time:Date.now()};
    const arr = JSON.parse(localStorage.getItem('feedbacks')||'[]'); arr.push(f); localStorage.setItem('feedbacks', JSON.stringify(arr));
    $('#fbName').value=''; $('#fbEmail').value=''; $('#fbMsg').value='';
    $('#feedbackModal').classList.remove('open');
    alert('Thanks ‚Äî feedback saved.');
  };
}

/* ---------- Admin button (login gate) ---------- */
$('#adminOpen').onclick = ()=> {
  // quick in-page prompt
  const p = prompt('Enter admin password:');
  if(p === ADMIN_PASSWORD){
    // mark admin session
    localStorage.setItem('isAdmin','1');
    // open admin page
    window.open('admin.html','_blank');
  } else {
    alert('Wrong password');
  }
};

/* ---------- Keep user in same place after order ---------- */
function renderCategoryViewAfterOrder(){
  const catHeader = document.querySelector('.category-header');
  if(catHeader){ const cat = catHeader.querySelector('h2').textContent; renderCategoryProducts(cat); } else renderCategoriesView();
}

/* ---------- Cart button ---------- */
$('#cartBtn').onclick = ()=> openCheckout();

/* ---------- keyboard / modal close ---------- */
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ $('#modalBackdrop').classList.remove('show'); $('#modal').classList.remove('show'); } });

/* ---------- init ---------- */
loadProducts();
</script>
</body>
</html>
