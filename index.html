<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Marketplace ‚Äî Final</title>
<link rel="stylesheet" href="styles.css">
<style>
/* quick extra polish (keeps main CSS smaller for the demo) */
:root{
  --accent:#ffcc00;
  --hero1:#081428;
  --hero2:#0b2a3c;
}
.hero{
  background: linear-gradient(120deg,var(--hero1),var(--hero2));
  color: white; padding: 36px 20px; border-radius: 12px; margin-bottom:16px;
  display:flex; gap:18px; align-items:center; justify-content:space-between;
}
.hero .left{max-width:800px}
.hero h1{margin:0;font-size:28px;letter-spacing:0.6px}
.hero p{margin:6px 0;color:rgba(255,255,255,0.85)}
.cta{background:var(--accent); color:#071428; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer}
.subtle{color:rgba(255,255,255,0.8);font-size:13px}
.logo{font-weight:800;font-size:20px;color:var(--hero2);letter-spacing:.4px}
.header-left{display:flex;align-items:center;gap:14px}
.header-right{display:flex;align-items:center;gap:12px}
.badge{background:#122533;color:#9be1ff;padding:6px 8px;border-radius:8px;font-weight:700}
</style>
</head>
<body data-theme="dark" style="background:#071428;color:#eaf6ff;font-family:Inter,system-ui,Segoe UI,Roboto,Arial">
  <header style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px">
    <div class="header-left">
      <div class="logo">Ninjago Marketplace</div>
      <div class="subtle">Browse ‚Ä¢ Request ‚Ä¢ Reserve</div>
    </div>
    <div class="header-right">
      <div id="cartBtn" class="badge">üõí <span id="cartCount">0</span></div>
      <a class="cta" href="admin.html" target="_blank" rel="noopener noreferrer">Admin</a>
    </div>
  </header>

  <main style="max-width:1200px;margin:18px auto;padding:0 16px">
    <section class="hero">
      <div class="left">
        <h1>Official & collector Ninjago sets, figures, blind bags and books</h1>
        <p class="subtle">Curated picks, real condition notes, rent options for books, and a secure giftcard system (soon server-backed).</p>
        <div style="margin-top:12px"><button id="browseBtn" class="cta">Browse sets</button></div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:800;font-size:28px;color:var(--accent)">Ninjago</div>
        <div style="margin-top:8px;color:rgba(255,255,255,0.85)">Collector-grade selection</div>
      </div>
    </section>

    <div style="display:flex;gap:12px;align-items:center;margin:8px 0">
      <input id="search" class="search" placeholder="Search sets, figures, books..." style="flex:1;padding:10px;border-radius:10px;border:0;box-shadow:0 6px 20px rgba(0,0,0,0.6);background:#0a2434;color:#eaf6ff">
      <select id="categoryFilter" class="small" style="padding:8px;border-radius:10px;background:#071a28;color:#eaf6ff;border:0">
        <option value="">All categories</option>
      </select>
    </div>

    <div id="mainArea"></div>
  </main>

  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

<script>
/* ---------- Helpers ---------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ---------- State ---------- */
let products = [];
let cart = JSON.parse(localStorage.getItem('cart')||'[]');
let credits = Number(localStorage.getItem('storeCredit')||0);

/* ---------- Load products.json ---------- */
async function loadProducts(){
  try{
    const res = await fetch('products.json');
    products = await res.json();
  }catch(e){
    console.error('products.json load failed', e);
    products = []; // empty fallback
  }
  initFilters();
  renderHome();
  renderCartCount();
  attachSearch();
}
function placeholderFor(id){
  // external fallback thumbnails (keeps site pretty before you commit images)
  const map = {
    'sets-71799':'https://images.unsplash.com/photo-1613451630477-6c9d1c50c0f7?w=1200&q=80',
    'sets-zane-big':'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=1200&q=80',
    'fig-santa-garmadon':'https://images.unsplash.com/photo-1607746882042-944635dfe10e?w=800&q=80'
  };
  return map[id] || 'https://images.unsplash.com/photo-1526406915894-23f5e4c2f6b9?w=800&q=60';
}

/* ---------- UI: home / categories ---------- */
function initFilters(){
  const cats = Array.from(new Set(products.map(p=>p.category))).filter(Boolean);
  const sel = $('#categoryFilter'); sel.innerHTML = `<option value="">All categories</option>` + cats.map(c=>`<option>${escapeHtml(c)}</option>`).join('');
}

function renderHome(){
  const main = $('#mainArea'); main.innerHTML = '';
  // show category tiles
  const cats = Array.from(new Set(products.map(p=>p.category))).filter(Boolean);
  const catWrap = document.createElement('div'); catWrap.className='categories-grid';
  catWrap.style.display = 'grid';
  catWrap.style.gridTemplateColumns = 'repeat(auto-fit,minmax(220px,1fr))';
  catWrap.style.gap = '16px';

  cats.forEach((cat,i)=>{
    const tile = document.createElement('div');
    tile.className='category-tile';
    tile.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02))';
    tile.style.borderRadius = '12px';
    tile.style.padding = '18px';
    tile.style.cursor = 'pointer';
    tile.style.opacity = 0;
    tile.innerHTML = `<div style="font-size:28px">${catEmoji(cat)}</div><div style="font-weight:800;margin-top:8px">${escapeHtml(cat)}</div><div style="color:rgba(255,255,255,0.65);margin-top:6px">${products.filter(p=>p.category===cat).length} items</div>`;
    catWrap.appendChild(tile);
    // staggered reveal
    setTimeout(()=> tile.style.opacity = 1, 80*i);
    tile.onclick = ()=> renderCategoryPage(cat);
  });

  main.appendChild(catWrap);

  // show featured products row
  const featured = products.slice(0,6);
  if(featured.length){
    const sec = document.createElement('section'); sec.style.marginTop = '20px';
    sec.innerHTML = `<h3 style="color:var(--accent);margin-bottom:8px">Featured picks</h3><div class="grid" id="featuredGrid"></div>`;
    main.appendChild(sec);
    const g = sec.querySelector('#featuredGrid');
    featured.forEach((p,i)=>{
      const thumb = Array.isArray(p.image)?p.image[0]:p.image;
      const src = (thumb && thumb.startsWith('images/')) ? thumb : (thumb || placeholderFor(p.id));
      const card = document.createElement('div'); card.className='card';
      card.style.background='#0b2a3a'; card.style.borderRadius='12px'; card.style.padding='12px';
      card.innerHTML = `<img src="${src}" style="width:100%;height:160px;object-fit:cover;border-radius:8px"><h4 style="margin:10px 0 6px">${escapeHtml(p.title)}</h4><div class="meta" style="color:rgba(255,255,255,0.6)">${escapeHtml(p.origin||'')}</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px"><div style="font-weight:800;color:var(--accent)">SAR ${p.price_sar}</div><button class="btn" data-id="${p.id}">View</button></div>`;
      g.appendChild(card);
      setTimeout(()=> card.style.transform='translateY(0)', 60*i);
      card.querySelector('.btn').onclick = ()=> openDetail(p.id);
    });
  }
}

/* ---------- Category page ---------- */
function categoryEmoji(cat){ return catEmoji(cat); }
function catEmoji(str){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Books':'üìö','Books (Rent)':'üìñ'};
  return map[str] || 'üì¶';
}
function renderCategoryPage(category){
  const main = $('#mainArea'); main.innerHTML = '';
  const header = document.createElement('div'); header.style.display='flex'; header.style.alignItems='center'; header.style.justifyContent='space-between';
  header.innerHTML = `<div><button id="backBtn" class="small">‚Üê Back</button><h2 style="display:inline-block;margin-left:12px">${escapeHtml(category)}</h2></div><div><select id="subtheme" class="small"><option value="">All</option></select></div>`;
  main.appendChild(header);
  $('#backBtn').onclick = renderHome;

  const all = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(all.map(p=>p.subtheme))).filter(Boolean);
  const subsel = header.querySelector('#subtheme');
  subs.forEach(s=> subsel.insertAdjacentHTML('beforeend', `<option>${escapeHtml(s)}</option>`));
  subsel.onchange = ()=> renderGrid(category, subsel.value);

  renderGrid(category, '');
}
function renderGrid(category, subfilter){
  const main = $('#mainArea');
  const cont = document.createElement('div'); cont.style.marginTop='12px';
  const search = ($('#search')?$('#search').value.trim().toLowerCase():'');
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=>p.subtheme === subfilter);
  if(search) items = items.filter(p => (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(search));
  if(items.length === 0){ cont.innerHTML = '<p class="hint" style="color:#9fb7ca">No items found</p>'; main.appendChild(cont); return; }

  const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit,minmax(220px,1fr))'; grid.style.gap='14px';
  items.forEach((p,i)=>{
    const thumb = Array.isArray(p.image)?p.image[0]:p.image;
    const src = (thumb && thumb.startsWith('images/')) ? thumb : (thumb || placeholderFor(p.id));
    const card = document.createElement('div'); card.className='card';
    card.style.background='#05202b'; card.style.padding='12px'; card.style.borderRadius='12px';
    card.innerHTML = `<img src="${src}" style="width:100%;height:160px;object-fit:cover;border-radius:8px"><h3 style="color:#eaf6ff;margin:8px 0">${escapeHtml(p.title)}</h3><div style="color:rgba(255,255,255,0.6)">${escapeHtml(p.condition||'')}</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px"><div style="font-weight:900;color:var(--accent)">SAR ${p.price_sar}</div><div><button class="btn view" data-id="${p.id}">View</button> <button class="small add" data-id="${p.id}">‚ûï</button></div></div>`;
    grid.appendChild(card);
  });
  cont.appendChild(grid);
  main.appendChild(cont);
  attachCategoryEvents();
}

/* ---------- actions ---------- */
function attachCategoryEvents(){
  $$('.view').forEach(b=> b.onclick = ()=> openDetail(b.dataset.id));
  $$('.add').forEach(b=> b.onclick = ()=> addToCart(b.dataset.id));
}

/* ---------- detail modal ---------- */
function openDetail(id){
  const p = products.find(x=>x.id===id) || {};
  const imgs = Array.isArray(p.image) ? p.image : (p.image ? [p.image] : []);
  const mainImg = (imgs[0] && imgs[0].startsWith('images/')) ? imgs[0] : (imgs[0] || placeholderFor(p.id));
  $('#modal').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="color:#eaf6ff">${escapeHtml(p.title||'Product')}</h2>
      <div><button id="closeModal" class="small">Close</button></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:12px">
      <div>
        <img id="galleryMain" src="${mainImg}" style="width:100%;height:360px;object-fit:contain;border-radius:8px;background:#071a27">
        <div style="display:flex;gap:8px;margin-top:8px">${imgs.map((u,i)=>`<img class="thumb" data-src="${u}" src="${(u && u.startsWith('images/'))?u:(u||placeholderFor(p.id))}" style="width:72px;height:54px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid transparent">`).join('')}</div>

        <div style="margin-top:12px;color:#cce9ff">${escapeHtml(p.origin||'')}</div>
        <div style="margin-top:6px;color:#9fb7ca">${escapeHtml(p.condition||'')}</div>
        <div style="margin-top:8px;font-weight:900;color:var(--accent)">SAR ${p.price_sar||'0'}</div>
        <div style="margin-top:12px"><button id="modalAdd" class="cta">Add to cart</button> <button id="modalBuy" class="small">Buy now</button></div>
      </div>
      <aside>
        <div style="background:#062732;padding:12px;border-radius:10px">
          <h4 style="margin:0 0 8px;color:var(--accent)">Quick cart</h4>
          <div id="quickCartList" style="min-height:80px"></div>
          <div id="quickSummary" style="margin-top:8px;color:#cfefff"></div>
          <div style="margin-top:8px"><button id="gotoCheckout" class="small">Checkout</button></div>
        </div>
      </aside>
    </div>
  `;
  document.getElementById('modalBackdrop').classList.add('show');
  setTimeout(()=> document.getElementById('modal').classList.add('show'),10);
  document.getElementById('closeModal').onclick = closeModal;
  $('#modalAdd').onclick = ()=> { addToCart(p.id); updateQuickCart(); };
  $('#modalBuy').onclick = ()=> { addToCart(p.id); openCheckout(); };
  $('#gotoCheckout').onclick = openCheckout;
  $$('.thumb').forEach(t=> t.onclick = ()=> { document.getElementById('galleryMain').src = t.dataset.src; });
  updateQuickCart();
}
function closeModal(){ document.getElementById('modal').classList.remove('show'); setTimeout(()=> document.getElementById('modalBackdrop').classList.remove('show'),200); }

/* ---------- cart ---------- */
function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const item = cart.find(c=>c.id===id);
  if(item) item.qty++; else cart.push({id:p.id,title:p.title,price:p.price_sar,qty:1,image: Array.isArray(p.image)?p.image[0]:p.image});
  localStorage.setItem('cart', JSON.stringify(cart));
  renderCartCount(); updateQuickCart();
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0) }
function updateQuickCart(){
  const el = $('#quickCartList'); const sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><img src="${(it.image && it.image.startsWith('images/'))?it.image:(it.image||placeholderFor(it.id))}" style="width:48px;height:40px;object-fit:cover;border-radius:6px"><div style="flex:1;color:#dff6ff"><strong>${escapeHtml(it.title)}</strong><div style="color:#9fb7ca">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div style="color:#9fb7ca">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div style="margin-top:8px;font-weight:900;color:var(--accent)">Total: SAR ${total.toFixed(2)}</div>`;
}

/* ---------- checkout (simple demo) ---------- */
function openCheckout(){
  document.getElementById('modal').innerHTML = checkoutHtml();
  document.getElementById('modalBackdrop').classList.add('show');
  setTimeout(()=> document.getElementById('modal').classList.add('show'),10);
  renderCheckoutCart();
  document.getElementById('cashPay').onclick = handleCashPay;
  document.getElementById('giftPay').onclick = handleGiftPay;
}
function checkoutHtml(){
  return `<div style="display:flex;justify-content:space-between;align-items:center"><h2 style="color:#eaf6ff">Checkout</h2><div><button id="closeCheckout" class="small">Close</button></div></div>
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:12px">
      <div style="flex:1;min-width:320px"><h4 style="color:#cfefff">Cart</h4><div id="checkoutCart"></div><div id="checkoutSummary" style="margin-top:8px;color:#dff6ff"></div></div>
      <div style="width:360px">
        <h4 style="color:#cfefff">Reserve with Cash</h4>
        <input id="custName" placeholder="Full name" class="input"><input id="custEmail" placeholder="Email (optional)" class="input"><input id="custDate" type="date" class="input"><textarea id="custMsg" placeholder="Pickup notes" class="textarea"></textarea><button id="cashPay" class="cta" style="margin-top:8px">Reserve with cash</button>
        <h4 style="margin-top:14px;color:#cfefff">Pay with Giftcard</h4>
        <input id="giftCode" placeholder="Giftcard code" class="input"><input id="giftAmount" placeholder="Amount (SAR)" class="input" type="number"><button id="giftPay" class="small" style="margin-top:8px">Pay with giftcard</button>
        <div class="subtle" style="margin-top:8px">Demo giftcard flow will call server API when configured; for now it stores local orders.</div>
      </div>
    </div>`;
}
function renderCheckoutCart(){
  const el = $('#checkoutCart'); const sumEl = $('#checkoutSummary');
  el.innerHTML = cart.map(it=>`<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><img src="${(it.image && it.image.startsWith('images/'))?it.image:(it.image||placeholderFor(it.id))}" style="width:48px;height:40px;object-fit:cover;border-radius:6px"><div style="flex:1;color:#dff6ff"><strong>${escapeHtml(it.title)}</strong><div style="color:#9fb7ca">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div style="color:#9fb7ca">Cart empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div style="font-weight:900;color:var(--accent)">Total: SAR ${total.toFixed(2)}</div>`;
  document.getElementById('closeCheckout').onclick = closeModal;
}
function closeModal(){ document.getElementById('modal').classList.remove('show'); setTimeout(()=> document.getElementById('modalBackdrop').classList.remove('show'),200); }
function handleCashPay(){
  const name = $('#custName').value.trim(); if(!name){ alert('Enter name'); return; }
  const date = $('#custDate').value;
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const order = {id:'order-'+Date.now(), name, date, email:$('#custEmail').value, cart, total, method:'cash', msg:$('#custMsg').value, created:Date.now()};
  let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
  alert('Cash reservation saved ‚Äî Order ID: '+order.id);
  cart = []; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderHome();
}
function handleGiftPay(){
  const code = $('#giftCode').value.trim() || ('GC-'+Math.floor(Math.random()*99999));
  const amount = Number($('#giftAmount').value) || 0;
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  // Demo: local-only gift handling. For managed giftcards, call /api/giftcards (redeem).
  if(amount < total){
    const remaining = total - amount;
    const order = {id:'order-'+Date.now(), total, paid:amount, method:'giftcard', code, remaining, created:Date.now()};
    let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    alert(`Partial paid SAR ${amount}. Remaining: SAR ${remaining.toFixed(2)}`);
  } else {
    const credit = +(amount - total);
    credits = +(credits + credit).toFixed(2); localStorage.setItem('storeCredit', credits);
    const order = {id:'order-'+Date.now(), total, paid:amount, method:'giftcard', code, storeCreditGained:credit, created:Date.now()};
    let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    alert(`Payment successful. You gained SAR ${credit.toFixed(2)} in-store credit. Current credit: SAR ${credits.toFixed(2)}`);
  }
  cart=[]; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderHome();
}

/* ---------- request/chat floating ---------- */
function initChat(){
  if(document.querySelector('.chat-floating')) return;
  const wrap = document.createElement('div'); wrap.className='chat-floating';
  wrap.style.position='fixed'; wrap.style.right='18px'; wrap.style.bottom='18px'; wrap.style.width='300px'; wrap.style.zIndex=9999;
  wrap.innerHTML = `<div style="background:#062732;padding:8px;border-radius:10px 10px 0 0;color:#eaf6ff;font-weight:700">Request product üí¨</div><div style="background:#05202b;padding:10px;border-radius:0 0 10px 10px"><div id="miniChat" style="height:120px;overflow:auto;border-radius:8px;background:#071a27;padding:8px;margin-bottom:8px"></div><div style="display:flex;gap:8px"><input id="miniReq" class="input" placeholder="Request a set or figure"><button id="miniSend" class="small">Send</button></div></div>`;
  document.body.appendChild(wrap);
  $('#miniSend').onclick = ()=> {
    const text = $('#miniReq').value.trim(); if(!text) return;
    const m = {from:'user', text, time:Date.now()};
    const existing = JSON.parse(localStorage.getItem('requests')||'[]'); existing.push(m); localStorage.setItem('requests', JSON.stringify(existing));
    $('#miniReq').value='';
    // auto-reply for demo
    setTimeout(()=> {
      const reply = {from:'owner', text:'Thanks ‚Äî noted: ' + text, time:Date.now()};
      const e2 = JSON.parse(localStorage.getItem('requests')||'[]'); e2.push(reply); localStorage.setItem('requests', JSON.stringify(e2));
      loadMiniChat();
    }, 700);
    loadMiniChat();
  }
  loadMiniChat();
}
function loadMiniChat(){
  const mini = document.getElementById('miniChat');
  const all = JSON.parse(localStorage.getItem('requests')||'[]');
  if(!mini) return;
  mini.innerHTML = all.slice(-10).map(m=>`<div style="margin-bottom:6px;color:${m.from==='user'?'#eaf6ff':'#9fb7ca'}">${escapeHtml(m.text)}</div>`).join('') || '<div style="color:#9fb7ca">No requests</div>';
}

/* ---------- search ---------- */
function attachSearch(){
  const s = $('#search');
  if(!s) return;
  s.oninput = ()=> {
    const q = s.value.trim().toLowerCase();
    if(!q){ renderHome(); return; }
    // quick results overlay
    const hits = products.filter(p => (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(q));
    const main = $('#mainArea'); main.innerHTML = `<h3 style="color:var(--accent)">Search results (${hits.length})</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px" id="searchGrid"></div>`;
    const grid = $('#searchGrid');
    hits.forEach(p=>{
      const thumb = Array.isArray(p.image)?p.image[0]:p.image;
      const src = (thumb && thumb.startsWith('images/')) ? thumb : (thumb || placeholderFor(p.id));
      grid.insertAdjacentHTML('beforeend', `<div class="card" style="background:#05202b;padding:10px;border-radius:10px"><img src="${src}" style="width:100%;height:140px;object-fit:cover;border-radius:8px"><h4 style="color:#eaf6ff">${escapeHtml(p.title)}</h4><div style="color:#9fb7ca">SAR ${p.price_sar}</div><div style="margin-top:6px"><button class="btn" data-id="${p.id}">View</button></div></div>`);
    });
    attachCategoryEvents();
  }
}

/* ---------- init ---------- */
document.getElementById('browseBtn').onclick = ()=> { const firstCategory = products.length ? products[0].category : null; if(firstCategory) renderCategoryPage(firstCategory); else alert('No products loaded'); };
document.getElementById('cartBtn').onclick = ()=> openCheckout();

loadProducts();
initChat();
</script>
</body>
</html>
