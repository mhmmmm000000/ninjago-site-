<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Vault</title>

<!-- Tailwind in-browser: same CDN used in your example -->
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

<style>
  :root{
    --accent: #00c853;
    --muted: #9aa4b2;
  }

  /* small custom animations to match the sample layout */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-up { animation: fadeUp 0.6s ease-out forwards; }
  .fade-up-delay-1 { animation-delay: .08s; }
  .fade-up-delay-2 { animation-delay: .16s; }
  .fade-up-delay-3 { animation-delay: .24s; }

  /* small card tweaks */
  .card-custom { transition: transform .18s ease, box-shadow .18s ease; }
  .card-custom:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 10px 30px rgba(2,6,23,.35); }

  /* modal backdrop quick tweak */
  .modal-backdrop { backdrop-filter: blur(6px); }

  /* small responsive fixes for hero spacing */
  .pt-safe { padding-top: 72px; }
</style>
</head>
<body class="bg-gray-900 text-gray-100">

  <!-- NAV / HEADER: matches the Tailwind feel you liked -->
  <nav class="backdrop-blur-md bg-white/5 fixed top-0 left-0 right-0 z-30 border-b border-white/6">
    <div class="max-w-6xl mx-auto px-6 py-3 flex items-center justify-between">
      <!-- Logo (secret admin unlock here) -->
      <div id="logoArea" class="flex items-center gap-3 cursor-pointer select-none">
        <img src="assets/favicon.png" alt="logo" class="w-10 h-10 rounded-md shadow-sm">
        <div>
          <div id="brandName" class="text-lg font-extrabold">Ninjago Vault</div>
          <div class="text-xs text-gray-400">Browse ‚Ä¢ Request ‚Ä¢ Pay</div>
        </div>
      </div>

      <!-- top controls (no visible admin link anymore) -->
      <div class="flex items-center gap-3">
        <input id="search" class="px-3 py-2 rounded-xl bg-white/6 text-sm placeholder:text-gray-400 outline-none" placeholder="Search sets, figures, books..." />
        <button id="themeToggle" class="px-3 py-2 rounded-xl bg-white/6 text-sm">üåì</button>
        <button id="signupBtn" class="px-3 py-2 rounded-xl bg-white/6 text-sm">Sign up / Sign in</button>
        <button id="cartBtn" class="px-3 py-2 rounded-xl bg-green-600 text-sm">üõí <span id="cartCount">0</span></button>
        <!-- admin link removed on purpose (secret unlock used instead) -->
      </div>
    </div>
  </nav>

  <!-- HERO like the example (keeps site from feeling empty) -->
  <header class="flex items-center justify-center h-48 pt-safe">
    <div class="text-center space-y-3 fade-up" style="animation-delay:.12s">
      <h1 class="text-4xl font-extrabold tracking-tight">Ninjago Vault ‚Äî Marketplace</h1>
      <p class="text-gray-400">Curated sets, polybags, blind bags and rare finds ‚Äî sign in to order or request.</p>
      <div class="mt-3">
        <a id="browseBtn" href="#" class="px-5 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 transition text-white">Browse catalog</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 pb-20">
    <div class="mt-6">
      <p class="text-sm text-gray-400">Tip: click a category tile. Click the product image to view details.</p>
    </div>

    <div id="mainArea" class="mt-5"></div>
  </main>

  <!-- modal -->
  <div id="modalBackdrop" class="modal-backdrop fixed inset-0 hidden items-center justify-center z-50">
    <div id="modal" class="bg-gray-800 w-11/12 max-w-3xl rounded-xl p-6 text-white transform scale-95 opacity-0"></div>
  </div>

  <!-- signin modal -->
  <div id="signinBackdrop" class="modal-backdrop fixed inset-0 hidden items-center justify-center z-50">
    <div id="signinModal" class="bg-gray-800 w-11/12 max-w-md rounded-xl p-6 text-white transform scale-95 opacity-0">
      <h2 class="text-xl font-bold mb-2">Sign up / Sign in</h2>
      <p class="text-sm text-gray-400 mb-3">Only email is required. Stored locally for demo.</p>
      <input id="inputEmail" class="w-full px-3 py-2 rounded-md bg-gray-900 outline-none" placeholder="Your email">
      <div class="flex gap-3 mt-4">
        <button id="btnSaveEmail" class="flex-1 px-4 py-2 rounded-xl bg-green-600">Save & Continue</button>
        <button id="btnCloseSignin" class="px-4 py-2 rounded-xl bg-white/6">Close</button>
      </div>
    </div>
  </div>

  <!-- chat floating -->
  <div id="chatFloating" class="fixed right-6 bottom-6 w-80 bg-gray-800 rounded-xl border border-white/6 shadow-lg">
    <div class="px-3 py-2 flex justify-between items-center border-b border-white/6">
      <div>Request product üí¨</div>
      <button id="minimizeChat" class="px-2 py-1 rounded-full bg-white/6">‚Äî</button>
    </div>
    <div id="chatBody" class="p-3">
      <div id="miniChat" class="h-36 overflow-auto text-sm text-gray-200"></div>
      <div class="flex gap-2 mt-3">
        <input id="miniReq" class="flex-1 px-3 py-2 rounded-md bg-gray-900" placeholder="Request a set or figure">
        <button id="miniSend" class="px-3 py-2 rounded-md bg-indigo-600">Send</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Utilities ---------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- State ---------- */
let products = [];
let currentView = 'catalog';
let cart = [];
let userEmail = localStorage.getItem('nm_user_email') || '';
const mainArea = $('#mainArea');

/* ---------- Admin secret setup ----------
   - Clicking the logo while Ctrl+Shift is pressed unlocks admin for this session.
   - That sets sessionStorage.admin_unlocked = "1" for admin.html to read.
*/
const logoArea = document.getElementById('logoArea');
logoArea.addEventListener('click', (ev) => {
  if (ev.ctrlKey && ev.shiftKey) {
    sessionStorage.setItem('admin_unlocked','1');
    // open admin in new tab
    window.open('admin.html', '_blank');
  } else {
    // optional: if normal click, scroll to catalog
    document.getElementById('browseBtn').scrollIntoView({behavior:'smooth'});
  }
});

/* ---------- Load products ---------- */
async function loadProducts(){
  try{
    const res = await fetch('products.json');
    products = await res.json();
  }catch(e){
    mainArea.innerHTML = '<p class="text-red-400">Failed to load products.json ‚Äî check file.</p>';
    console.error(e);
    return;
  }
  renderView();
  renderCartCount();
  attachSearch();
  loadChat();
}
loadProducts();

/* ---------- Theme toggle ---------- */
function initTheme(){
  const saved = localStorage.getItem('nm_theme') || 'dark';
  setTheme(saved);
  $('#themeToggle').onclick = () => {
    const t = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
    setTheme(t);
  };
}
function setTheme(t){
  document.documentElement.dataset.theme = t;
  localStorage.setItem('nm_theme', t);
}
initTheme();

/* ---------- Navigation ---------- */
function renderView(){
  if(currentView === 'catalog') renderCategoriesView();
  else if(currentView === 'rewards') renderRewardsView();
  else if(currentView === 'requests') renderRequestsView();
  else if(currentView === 'feedback') renderFeedbackView();
}

/* ---------- Categories view (animated) ---------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function categoryIcon(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Polybags':'üõçÔ∏è','Miscs':'üì¶','Books':'üìö','Books (Rent)':'üìñ'};
  return map[cat]||'üì¶';
}
function renderCategoriesView(){
  mainArea.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4';
  cats.forEach((cat,i)=>{
    const tile = document.createElement('button'); tile.className='p-4 rounded-xl bg-gray-800 border border-white/6 text-left card-custom fade-up';
    tile.classList.add('fade-up-delay-'+((i%3)+1));
    tile.style.animationDelay = (i*70)+'ms';
    tile.innerHTML = `<div class="text-3xl">${categoryIcon(cat)}</div><div class="mt-2 font-bold">${escapeHtml(cat)}</div><div class="text-xs text-gray-400">${products.filter(p=>p.category===cat).length} items</div>`;
    tile.onclick = ()=> renderCategoryPage(cat);
    wrap.appendChild(tile);
  });
  mainArea.appendChild(wrap);
}

/* ---------- Category page ---------- */
function renderCategoryPage(category){
  mainArea.innerHTML = `
    <div class="flex items-center gap-3 mt-3">
      <button id="catBack" class="px-3 py-1 rounded-xl bg-white/6">‚Üê Back</button>
      <h2 class="text-2xl font-bold">${escapeHtml(category)}</h2>
      <div class="ml-auto flex items-center gap-2">
        <select id="subFilter" class="px-3 py-1 rounded-xl bg-white/6"></select>
        <button id="clearFilter" class="px-3 py-1 rounded-xl bg-white/6">Clear</button>
      </div>
    </div>
    <div id="categoryProducts" class="mt-4"></div>
  `;
  $('#catBack').onclick = ()=> renderCategoriesView();
  const items = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  $('#subFilter').innerHTML = `<option value="">All subthemes</option>` + subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  $('#subFilter').onchange = ()=> renderCategoryProducts(category, $('#subFilter').value);
  $('#clearFilter').onclick = ()=> { $('#subFilter').value=''; renderCategoryProducts(category); };
  renderCategoryProducts(category);
}

function renderCategoryProducts(category, subfilter){
  const cont = $('#categoryProducts');
  if(!cont) return;
  const search = ($('#search')? $('#search').value.trim().toLowerCase() : '');
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'')===subfilter);
  if(search) items = items.filter(p=> (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(search));
  if(items.length === 0){ cont.innerHTML = '<p class="text-gray-400">No items found.</p>'; return; }

  const grid = document.createElement('div'); grid.className='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
  items.forEach((p,i)=>{
    const img = Array.isArray(p.image) ? p.image[0] : p.image;
    const hard = p.hard_to_find ? `<div class="absolute top-2 left-2 bg-red-600 text-xs px-2 py-1 rounded">Hard</div>` : '';
    const card = document.createElement('div'); card.className='rounded-xl bg-gray-800 border border-white/6 p-3 card-custom relative fade-up';
    card.style.animationDelay = (i*50)+'ms';
    card.innerHTML = `
      <div class="card-image cursor-pointer rounded-md overflow-hidden mb-2">
        <img src="${img}" alt="${escapeHtml(p.title)}" class="w-full h-44 object-cover">
        ${hard}
      </div>
      <h3 class="font-bold text-lg">${escapeHtml(p.title)}</h3>
      <div class="text-xs text-gray-400">${escapeHtml(p.origin||'')}</div>
      <div class="text-xs text-gray-400">${escapeHtml(p.condition||'')}</div>
      <div class="mt-2 font-extrabold text-green-400">SAR ${p.price_sar ? p.price_sar : '-'}</div>
      <div class="flex gap-2 mt-3">
        <button class="add px-3 py-1 rounded-xl bg-white/6 text-sm" data-id="${p.id}">‚ûï Add</button>
        <button class="view px-3 py-1 rounded-xl bg-indigo-600 text-sm" data-id="${p.id}">View</button>
      </div>
    `;
    grid.appendChild(card);
    // click image to open detail
    card.querySelector('.card-image').onclick = ()=> openDetail(p.id);
  });

  cont.innerHTML = ''; cont.appendChild(grid);
  attachCardEvents();
}

/* ---------- Attach card events ---------- */
function attachCardEvents(){
  $$('.view').forEach(b => b.onclick = e => openDetail(e.target.dataset.id));
  $$('.add').forEach(b => b.onclick = e => {
    const id = e.target.dataset.id;
    addToCart(id);
  });
}

/* ---------- Search ---------- */
function attachSearch(){
  const s = $('#search');
  if(!s) return;
  s.addEventListener('input', ()=> {
    const header = document.querySelector('.category-header');
    if(header) {
      const cat = header.querySelector('h2') ? header.querySelector('h2').textContent : '';
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      if(cat) renderCategoryProducts(cat, sub);
    } else {
      renderCategoriesView();
      const q = s.value.trim();
      if(!q) return;
      const results = products.filter(p => (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(q.toLowerCase()));
      if(results.length) {
        const resWrap = document.createElement('div'); resWrap.className='mt-4';
        resWrap.innerHTML = `<h3 class="text-xl font-bold mb-3">Quick results</h3><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>`;
        results.forEach((p,i)=> {
          const img = Array.isArray(p.image)?p.image[0]:p.image;
          resWrap.querySelector('.grid').insertAdjacentHTML('beforeend', `
            <div class="rounded-xl bg-gray-800 border border-white/6 p-3 fade-up" style="animation-delay:${i*40}ms">
              <div class="card-image mb-2"><img src="${img}" class="w-full h-44 object-cover rounded-md"></div>
              <h3 class="font-bold">${escapeHtml(p.title)}</h3>
              <div class="text-xs text-gray-400">${escapeHtml(p.category)}</div>
              <div class="mt-2 font-extrabold text-green-400">SAR ${p.price_sar}</div>
              <div class="mt-2"><button class="view px-3 py-1 rounded-xl bg-indigo-600 text-sm" data-id="${p.id}">View</button></div>
            </div>
          `);
        });
        mainArea.appendChild(resWrap);
        attachCardEvents();
      }
    }
  });
}

/* ---------- Modal / Detail ---------- */
function openDetail(id){
  const p = products.find(x => x.id === id);
  if(!p) return;
  const imgs = Array.isArray(p.image) ? p.image : [p.image];
  $('#modal').innerHTML = `
    <div class="flex justify-between items-start gap-3">
      <div>
        <h2 class="text-2xl font-bold">${escapeHtml(p.title)}</h2>
        <div class="text-sm text-gray-400">${escapeHtml(p.origin||'')}</div>
      </div>
      <div><button id="closeModal" class="px-3 py-1 rounded-xl bg-white/6">Close</button></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div>
        <div class="gallery-main rounded-md overflow-hidden bg-gray-900"><img id="galleryMain" src="${imgs[0]}" class="w-full h-72 object-contain"></div>
        <div class="flex gap-2 mt-2 overflow-auto">${imgs.map((u,i)=>`<img class="gthumb w-20 h-14 object-cover rounded-md cursor-pointer ${i===0? 'border-2 border-indigo-600' : ''}" data-src="${u}" src="${u}">`).join('')}</div>
      </div>
      <div>
        <div class="text-sm text-gray-300">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="text-sm text-gray-300 mt-1">${p.piece_count? p.piece_count + ' pcs' : ''} ${p.figures_count? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="text-2xl font-extrabold text-green-400 mt-4">SAR ${p.price_sar ? p.price_sar : '-'}</div>
        <p class="text-gray-300 mt-4">${escapeHtml(p.description || p.notes || '')}</p>
        <div class="flex gap-2 mt-4">
          <button class="btn-add px-4 py-2 rounded-xl bg-green-600" id="modalAdd">Add to cart</button>
          <button class="btn-buy px-4 py-2 rounded-xl bg-indigo-600" id="modalBuy">Buy now</button>
        </div>

        <div class="mt-6">
          <h4 class="font-bold">Recommended</h4>
          <div id="recList" class="mt-2"></div>
        </div>
      </div>
    </div>
  `;
  $('#modalBackdrop').classList.remove('hidden');
  setTimeout(()=> { $('#modalBackdrop').classList.add('flex'); $('#modal').style.transform='none'; $('#modal').style.opacity='1'; }, 20);
  $('#closeModal').onclick = closeModal;
  $('#modalAdd').onclick = ()=>{ addToCart(p.id); updateQuickCart(); }
  $('#modalBuy').onclick = ()=>{ addToCart(p.id); openCheckout(); }

  $$('.gthumb').forEach(t=> t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('border-2')); t.classList.add('border-2'); });
  // render recommended
  const recEl = $('#recList'); recEl.innerHTML = (p.recommended||[]).map(id=>{ const r = products.find(x=>x.id===id); return r ? `<div class="flex gap-2 items-center mt-2"><img src="${Array.isArray(r.image)?r.image[0]:r.image}" class="w-12 h-10 object-cover rounded-sm"><div><div class="font-bold">${escapeHtml(r.title)}</div><div class="text-xs text-gray-400">SAR ${r.price_sar}</div></div></div>` : '' }).join('');
  updateQuickCart();
}
function closeModal(){ $('#modalBackdrop').classList.add('hidden'); $('#modal').style.transform='scale(.98) translateY(8px)'; $('#modal').style.opacity='0'; }

/* ---------- Cart (per-user) ---------- */
function loadCart(){
  if(!userEmail) { cart = []; return; }
  cart = JSON.parse(localStorage.getItem('cart_' + userEmail) || '[]');
}
function saveCart(){
  if(!userEmail) return;
  localStorage.setItem('cart_' + userEmail, JSON.stringify(cart));
}
function addToCart(id){
  if(!userEmail){ promptSignin('You must sign in to add items to your cart.'); return; }
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const it = cart.find(i=>i.id===id);
  if(it) it.qty++; else cart.push({ id:p.id, title:p.title, price:p.price_sar||0, qty:1, image: Array.isArray(p.image)?p.image[0]:p.image });
  saveCart(); renderCartCount(); updateQuickCart();
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }
function updateQuickCart(){
  const el = $('#quickCartList'), sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="cart-row flex items-center gap-2"><img src="${it.image}" class="w-12 h-10 object-cover rounded-sm"><div><strong>${escapeHtml(it.title)}</strong><div class="text-xs text-gray-400">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="text-gray-400">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s + i.price * i.qty, 0);
  if(sumEl) sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}
$('#cartBtn').onclick = ()=> { if(!userEmail) promptSignin('You must sign in to view your cart and checkout.'); else openCheckout(); };

/* ---------- Checkout ---------- */
function openCheckout(){
  if(!userEmail){ promptSignin('You must sign in to checkout.'); return; }
  $('#modal').innerHTML = checkoutHtml();
  $('#modalBackdrop').classList.remove('hidden'); setTimeout(()=> { $('#modalBackdrop').classList.add('flex'); $('#modal').style.transform='none'; $('#modal').style.opacity='1';},20);
  renderCheckoutCart();
  $('#closeModal2').onclick = closeModal;
  $('#cashPay').onclick = handleCashPay;
  $('#giftPay').onclick = handleGiftPay;
}
function checkoutHtml(){
  return `<div class="flex justify-between items-center"><h2 class="text-xl font-bold">Checkout</h2><div><button id="closeModal2" class="px-3 py-1 rounded-xl bg-white/6">Close</button></div></div>
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <h4 class="font-bold">Cart</h4><div id="checkoutCart" class="mt-2"></div><div id="checkoutSummary" class="mt-2 font-bold"></div>
      </div>
      <div>
        <h4 class="font-bold">Pay with Cash (Reserve)</h4>
        <div class="mt-2">
          <input id="custDate" type="date" class="w-full px-3 py-2 rounded-md bg-gray-900" />
          <textarea id="custMsg" class="w-full px-3 py-2 rounded-md bg-gray-900 mt-2" placeholder="Message / pickup instructions"></textarea>
          <button class="w-full mt-3 px-4 py-2 rounded-xl bg-green-600" id="cashPay">Reserve with cash</button>
        </div>
        <h4 class="font-bold mt-4">Pay with Giftcard</h4>
        <div class="mt-2">
          <input id="giftCode" class="w-full px-3 py-2 rounded-md bg-gray-900" placeholder="Giftcard code (demo)">
          <input id="giftAmount" class="w-full px-3 py-2 rounded-md mt-2 bg-gray-900" placeholder="Amount (SAR)" type="number" min="0" step="0.01">
          <button class="w-full mt-3 px-4 py-2 rounded-xl bg-indigo-600" id="giftPay">Pay with giftcard</button>
        </div>
      </div>
    </div>`;
}
function renderCheckoutCart(){
  const el = $('#checkoutCart'), sumEl = $('#checkoutSummary');
  el.innerHTML = cart.map(it=>`<div class="flex items-center gap-2"><img src="${it.image}" class="w-12 h-10 object-cover rounded-sm"><div><strong>${escapeHtml(it.title)}</strong><div class="text-xs text-gray-400">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="text-gray-400">Cart empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}
function handleCashPay(){
  const date = $('#custDate').value || '';
  const msg = $('#custMsg').value || '';
  const total = cart.reduce((s,i)=>s + i.price * i.qty, 0);
  const order = { id:'order-'+Date.now(), email:userEmail, method:'cash', total, date, msg, items:cart.slice(), created:Date.now() };
  saveOrder(order);
  addPointsFor(userEmail, total);
  cart = []; saveCart(); renderCartCount(); closeModal(); alert('Cash reservation saved. Order ID: ' + order.id);
}
function handleGiftPay(){
  const code = $('#giftCode').value.trim() || '';
  const amount = Number($('#giftAmount').value) || 0;
  const total = cart.reduce((s,i)=>s + i.price * i.qty, 0);
  if(amount < total){ alert('Partial payment recorded (demo). Please pay remaining on pickup.'); }
  const order = { id:'order-'+Date.now(), email:userEmail, method:'giftcard', total, paid:amount, code, items:cart.slice(), created:Date.now() };
  saveOrder(order);
  addPointsFor(userEmail, Math.min(total, amount));
  cart = []; saveCart(); renderCartCount(); closeModal(); alert('Giftcard payment processed (demo). Order ID: ' + order.id);
}
function saveOrder(order){
  const all = JSON.parse(localStorage.getItem('orders_all') || '[]');
  all.push(order);
  localStorage.setItem('orders_all', JSON.stringify(all));
}

/* ---------- Sign-in flow ---------- */
$('#signupBtn').onclick = ()=> openSignin();
function openSignin(){ $('#signinBackdrop').classList.remove('hidden'); setTimeout(()=> { $('#signinBackdrop').classList.add('flex'); $('#signinModal').style.transform='none'; $('#signinModal').style.opacity='1'; }, 20); $('#inputEmail').focus(); }
$('#btnCloseSignin').onclick = ()=> closeSignin();
function closeSignin(){ $('#signinBackdrop').classList.add('hidden'); $('#signinModal').style.transform='scale(.98)'; $('#signinModal').style.opacity='0'; }
$('#btnSaveEmail').onclick = ()=> {
  const em = $('#inputEmail').value.trim().toLowerCase();
  if(!em || !em.includes('@')){ alert('Enter a valid email'); return; }
  userEmail = em;
  localStorage.setItem('nm_user_email', userEmail);
  loadCart();
  renderCartCount();
  closeSignin();
  alert('Signed in as ' + userEmail);
};

/* ---------- Prompt sign in when required ---------- */
function promptSignin(msg){
  $('#signinBackdrop').classList.remove('hidden'); setTimeout(()=> { $('#signinBackdrop').classList.add('flex'); $('#signinModal').style.transform='none'; $('#signinModal').style.opacity='1'; }, 20);
  if(msg) alert(msg);
}

/* ---------- Load cart on init if email exists ---------- */
if(userEmail) loadCart();

/* ---------- Quick cart display (in modal when opened) ---------- */
function updateQuickCart(){
  const el = $('#quickCartList'), sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="flex items-center gap-2"><img src="${it.image}" class="w-12 h-10 object-cover rounded-sm"><div><strong>${escapeHtml(it.title)}</strong><div class="text-xs text-gray-400">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="text-gray-400">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  if(sumEl) sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

/* ---------- Request chat (floating) ---------- */
function loadChat(){
  const msgs = JSON.parse(localStorage.getItem('requests') || '[]');
  if(!document.querySelector('#chatFloating')) return;
  $('#miniSend').onclick = ()=> {
    const text = $('#miniReq').value.trim(); if(!text) return;
    const m = {from:'user', text, time:Date.now()};
    const existing = JSON.parse(localStorage.getItem('requests')||'[]'); existing.push(m); localStorage.setItem('requests', JSON.stringify(existing));
    $('#miniReq').value='';
    setTimeout(()=> { const reply = {from:'owner', text:'Thanks ‚Äî we noted: ' + text, time:Date.now()}; const e2 = JSON.parse(localStorage.getItem('requests')||'[]'); e2.push(reply); localStorage.setItem('requests', JSON.stringify(e2)); renderMiniChat(); }, 700);
    renderMiniChat();
  };
  $('#minimizeChat').onclick = ()=> {
    const body = $('#chatBody');
    if(body.style.display === 'none'){ body.style.display = ''; $('#minimizeChat').innerText = '‚Äî'; }
    else { body.style.display = 'none'; $('#minimizeChat').innerText = '+'; }
  };
  renderMiniChat();
}
function renderMiniChat(){
  const mini = $('#miniChat');
  const all = JSON.parse(localStorage.getItem('requests')||'[]');
  mini.innerHTML = all.map(m=>`<div class="py-1"><div class="${m.from==='user' ? 'text-right text-green-300' : 'text-left text-gray-300'}">${escapeHtml(m.text)}</div></div>`).join('') || '<div class="text-gray-400">No requests yet.</div>';
}
loadChat();

/* ---------- Rewards system ---------- */
function addPointsFor(email, amountSAR){
  const add = +(amountSAR * 0.5).toFixed(2);
  const key = 'points_' + email;
  const cur = Number(localStorage.getItem(key) || 0);
  localStorage.setItem(key, (cur + add).toFixed(2));
}
function getPoints(email){ return Number(localStorage.getItem('points_' + email) || 0); }

function renderRewardsView(){
  const points = getPoints(userEmail || '') || 0;
  mainArea.innerHTML = `
    <div class="mt-4">
      <h2 class="text-2xl font-bold">Rewards & Milestones</h2>
      <div class="text-gray-400 mt-2">You earn 0.5 points per SAR spent. Sign in to collect and redeem.</div>
      <div class="timeline mt-4 border-l border-white/6 pl-4 space-y-3">
        <div><strong>100 points</strong> ‚Äî Dragon Rising blind bag</div>
        <div><strong>250 points</strong> ‚Äî Blind bag of your choice</div>
        <div><strong>500 points</strong> ‚Äî 30070 polybag</div>
        <div><strong>750 points</strong> ‚Äî Any $10 set</div>
        <div><strong>1000 points</strong> ‚Äî Special mystery reward</div>
      </div>
      <div class="mt-4 text-gray-300">Your points: <strong>${points}</strong></div>
    </div>
  `;
}

/* ---------- Requests & Feedback views ---------- */
function renderRequestsView(){
  const all = JSON.parse(localStorage.getItem('requests')||'[]');
  mainArea.innerHTML = `<h2 class="text-2xl font-bold mt-4">Requests</h2><div class="mt-3">${all.map(r=>`<div class="py-2"><div class="${r.from==='user'?'text-right text-green-300':'text-left text-gray-300'}">${escapeHtml(r.text)}</div></div>`).join('') || '<div class="text-gray-400">No requests yet.</div>'}</div>`;
}
function renderFeedbackView(){
  const fb = JSON.parse(localStorage.getItem('feedbacks')||'[]');
  mainArea.innerHTML = `<h2 class="text-2xl font-bold mt-4">Feedback</h2><div class="mt-3">${fb.map(f=>`<div class="py-2"><strong>${escapeHtml(f.email||'Anonymous')}</strong><div class="text-gray-300">${escapeHtml(f.text)}</div></div>`).join('') || '<div class="text-gray-400">No feedback yet.</div>'}</div>`;
}

/* ---------- Keyboard close modal ---------- */
document.addEventListener('keydown', e=> { if(e.key === 'Escape'){ closeModal(); closeSignin(); } });

</script>
</body>
</html>
