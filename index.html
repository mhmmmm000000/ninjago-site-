<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Market ‚Äî Marketplace</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<header class="site-header">
  <div class="brand">
    <div class="logo">Ninjago Market</div>
    <div class="subtitle">Collect ‚Ä¢ Request ‚Ä¢ Reserve</div>
  </div>
  <div class="controls">
    <input id="search" class="search" placeholder="Search sets, figures, books...">
    <button id="themeToggle" class="btn small">üåô</button>
    <button id="cartBtn" class="btn">üõí <span id="cartCount">0</span></button>
    <a class="btn small" href="admin.html" target="_blank" rel="noopener noreferrer">Admin</a>
  </div>
</header>

<main class="container">
  <div class="top-row">
    <div class="hint">Tip: click a category (e.g., Sets). Inside you can filter subthemes and view product details.</div>
    <div class="view-controls">
      <label class="small">View:</label>
      <select id="viewMode" class="small">
        <option value="grid">Grid</option>
        <option value="list">List</option>
      </select>
    </div>
  </div>

  <div id="mainArea" class="main-area"></div>
</main>

<!-- modal -->
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
</div>

<!-- floating request widget (minimizable) -->
<div id="requestWidget" class="request-widget minimized" aria-hidden="true">
  <div class="req-head">
    <div>Request product üí¨</div>
    <div class="req-controls">
      <button id="reqMin" class="small">‚Äî</button>
      <button id="reqClose" class="small">‚úï</button>
    </div>
  </div>
  <div id="reqBody" class="req-body">
    <div id="reqChat" class="chat"></div>
    <div class="req-form">
      <input id="reqName" class="input" placeholder="Your name (optional)">
      <select id="reqType" class="small"><option>Set</option><option>Figure</option><option>Box/Instructions</option><option>Other</option></select>
      <input id="reqText" class="input" placeholder="Which product or request?">
      <div style="display:flex;gap:8px">
        <button id="reqSend" class="btn">Send</button>
        <button id="reqMin2" class="small">Minimize</button>
      </div>
    </div>
  </div>
</div>
<button id="reqOpenBtn" class="req-open-btn" title="Requests">üí¨</button>

<!-- floating feedback -->
<div id="feedbackWidget" class="feedback-widget">
  <button id="feedbackOpen" class="req-open-btn small">Feedback</button>
  <div id="feedbackPanel" class="feedback-panel hidden">
    <h4>Feedback</h4>
    <textarea id="feedbackText" class="textarea" placeholder="Tell us what to improve"></textarea>
    <input id="feedbackEmail" class="input" placeholder="Email (optional)">
    <div style="display:flex;gap:8px"><button id="feedbackSend" class="btn">Send</button><button id="feedbackClose" class="small">Close</button></div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

let products = [];
let cart = JSON.parse(localStorage.getItem('cart')||'[]');
let credits = Number(localStorage.getItem('storeCredit')||0);
const mainArea = $('#mainArea');

/* ---------- load products ---------- */
async function loadProducts(){
  try{
    const r = await fetch('products.json');
    if(!r.ok) throw new Error('products.json fetch failed');
    products = await r.json();
  } catch(e){
    mainArea.innerHTML = '<p class="hint err">Failed to load products.json ‚Äî check file.</p>';
    console.error(e);
    return;
  }
  initTheme();
  renderCategoriesView();
  renderCartCount();
  attachSearch();
  initRequestWidget();
  initFeedbackWidget();
}

/* ---------- theme ----------- */
function initTheme(){
  const t = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
  $('#themeToggle').textContent = t==='dark' ? 'üåô' : '‚òÄÔ∏è';
  $('#themeToggle').onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = cur==='dark' ? 'light':'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    $('#themeToggle').textContent = next==='dark' ? 'üåô' : '‚òÄÔ∏è';
  };
}

/* ---------- categories ---------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function catIcon(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Polybags':'üßæ','Books':'üìö','Miscs':'üß∞','Books (Rent)':'üìñ'};
  return map[cat] || 'üì¶';
}

function renderCategoriesView(){
  mainArea.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className='categories-grid';
  cats.forEach((cat,i)=>{
    const btn = document.createElement('button'); btn.className='category-tile';
    const count = products.filter(p=>p.category===cat).length;
    btn.innerHTML = `<div class="cat-emoji">${catIcon(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${count} items</div>`;
    wrap.appendChild(btn);
    setTimeout(()=>btn.classList.add('show'), 50*i);
    btn.onclick = ()=> renderCategoryPage(cat);
  });
  mainArea.appendChild(wrap);
}

/* ---------- category page ---------- */
function renderCategoryPage(category){
  mainArea.innerHTML = `
    <div class="category-header">
      <button id="catBack" class="btn small">‚Üê Back</button>
      <h2>${escapeHtml(category)}</h2>
      <div class="controls-inline">
        <select id="subFilter" class="small"></select>
        <button id="clearFilter" class="small">Clear</button>
      </div>
    </div>
    <div id="categoryProducts"></div>
  `;
  $('#catBack').onclick = ()=> renderCategoriesView();
  const items = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  const sel = $('#subFilter');
  sel.innerHTML = `<option value="">All subthemes</option>` + subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  sel.onchange = ()=> renderCategoryProducts(category, sel.value);
  $('#clearFilter').onclick = ()=> { sel.value=''; renderCategoryProducts(category); };
  renderCategoryProducts(category);
}

function renderCategoryProducts(category, subfilter){
  const cont = $('#categoryProducts');
  const search = ($('#search')?$('#search').value.trim().toLowerCase():'');
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'')===subfilter);
  if(search) items = items.filter(p => (p.title + p.origin + (p.subtheme||'')).toLowerCase().includes(search));
  if(items.length===0){ cont.innerHTML = '<p class="hint">No items found.</p>'; return; }

  const view = $('#viewMode').value || 'grid';
  const grid = document.createElement('div'); grid.className = view==='grid' ? 'grid' : 'list';
  items.forEach((p,i)=>{
    const thumb = Array.isArray(p.image) ? p.image[0] : p.image || 'images/placeholder.jpg';
    const hardTag = p.hard_to_find ? '<div class="hard">Hard to find</div>' : '';
    const discount = p.price_discounted ? `<div class="discount">SAR ${p.price_discounted} <span class="small-muted">(was ${p.price_sar})</span></div>` : `<div class="price">SAR ${p.price_sar}</div>`;
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="card-media"><img loading="lazy" src="${thumb}" alt="${escapeHtml(p.title)}" onerror="this.src='images/placeholder.jpg'"></div>
      <div class="card-body">
        <h3>${escapeHtml(p.title)}</h3>
        <div class="meta small-muted">${escapeHtml(p.origin||p.subtheme||'')}</div>
        ${discount}
        ${hardTag}
        <div class="contact">
          <button class="btn view" data-id="${p.id}">View</button>
          <button class="small add" data-id="${p.id}">‚ûï</button>
        </div>
      </div>
    `;
    grid.appendChild(card);
    setTimeout(()=>card.classList.add('show'), 40*i);
  });
  cont.innerHTML = ''; cont.appendChild(grid);
  attachCardEvents();
}

/* ---------- search ---------- */
function attachSearch(){
  const s = $('#search');
  if(!s) return;
  s.addEventListener('input', ()=>{
    const catHeader = document.querySelector('.category-header');
    if(catHeader){
      const cat = catHeader.querySelector('h2').textContent;
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      renderCategoryProducts(cat, sub);
    } else {
      renderCategoriesView();
      const q = s.value.trim();
      if(!q) return;
      const results = products.filter(p=> (p.title+p.origin+(p.subtheme||'')).toLowerCase().includes(q.toLowerCase()));
      if(results.length){
        const resWrap = document.createElement('div'); resWrap.className='search-results';
        resWrap.innerHTML = `<h3 class="section-title">Quick results</h3><div class="grid"></div>`;
        results.forEach(p=> resWrap.querySelector('.grid').insertAdjacentHTML('beforeend', `<div class="card show"><img src="${Array.isArray(p.image)?p.image[0]:p.image}" alt=""><h3>${escapeHtml(p.title)}</h3><div class="meta small-muted">${escapeHtml(p.category)}</div><div class="price">SAR ${p.price_sar || ''}</div><div class="contact"><button class="btn view" data-id="${p.id}">View</button></div></div>`));
        mainArea.appendChild(resWrap);
        attachCardEvents();
      }
    }
  });
}

/* ---------- card events ---------- */
function attachCardEvents(){
  $$('.view').forEach(b=> b.onclick = ()=> openDetail(b.dataset.id));
  $$('.add').forEach(b=> b.onclick = ()=> addToCart(b.dataset.id));
}

/* ---------- modal / product detail + gallery ---------- */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image) ? p.image : [p.image || 'images/placeholder.jpg'];
  $('#modal').innerHTML = `
    <div class="modal-header">
      <h2>${escapeHtml(p.title)}</h2>
      <button id="closeModal" class="small">Close</button>
    </div>
    <div class="modal-grid">
      <div>
        <div class="gallery">
          <div class="gallery-main"><img id="galleryMain" src="${imgs[0]}" alt="${escapeHtml(p.title)}" onerror="this.src='images/placeholder.jpg'"></div>
          <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${u}" src="${u}" onerror="this.src='images/placeholder.jpg'">`).join('')}</div>
        </div>
        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count ? p.piece_count + ' pcs' : ''} ${p.figures_count ? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div>${p.notes ? `<div class="note">${escapeHtml(p.notes)}</div>` : ''}</div>
        <div class="price-row">
          ${p.price_discounted ? `<div class="discount">SAR ${p.price_discounted} <span class="small-muted">(was SAR ${p.price_sar})</span></div>` : `<div class="price">SAR ${p.price_sar}</div>`}
          <div style="margin-left:auto"><button class="btn" id="modalAdd">Add to cart</button> <button class="small" id="modalBuy">Buy now</button></div>
        </div>

        <div class="price-compare">
          <h4>Price comparisons</h4>
          ${(p.price_comparisons||[]).map(c=>`<div class="item ${c.overpriced? 'over':''}"><a href="${c.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(c.site)}</a><div>${escapeHtml(c.price)}</div></div>`).join('')}
        </div>
      </div>

      <aside>
        <div class="cart-mini">
          <h4>Quick cart</h4>
          <div id="quickCartList" class="cart-list"></div>
          <div class="order-summary" id="quickSummary"></div>
          <div style="margin-top:8px"><button class="btn" id="gotoCheckout">Go to checkout</button></div>
        </div>
      </aside>
    </div>
  `;
  document.getElementById('modalBackdrop').classList.add('show');
  setTimeout(()=> document.getElementById('modal').classList.add('show'), 10);

  $('#closeModal').onclick = closeModal;
  $('#modalAdd').onclick = ()=>{ addToCart(p.id); updateQuickCart(); }
  $('#modalBuy').onclick = ()=>{ addToCart(p.id); openCheckout(); }
  $('#gotoCheckout').onclick = openCheckout;

  $$('.gthumb').forEach(t=>{
    t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); };
  });

  updateQuickCart();
}
function closeModal(){ document.getElementById('modal').classList.remove('show'); setTimeout(()=>document.getElementById('modalBackdrop').classList.remove('show'),250); }

/* ---------- cart ---------- */
function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const item = cart.find(c=>c.id===id);
  if(item) item.qty++; else cart.push({ id:p.id, title:p.title, price:p.price_discounted || p.price_sar || 0, qty:1, image: Array.isArray(p.image)?p.image[0]:p.image });
  localStorage.setItem('cart', JSON.stringify(cart));
  renderCartCount(); updateQuickCart();
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }
function updateQuickCart(){
  const el = $('#quickCartList'); const sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${it.image}" alt=""><div style="flex:1"><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

/* ---------- checkout ---------- */
function openCheckout(){
  $('#modal').innerHTML = checkoutHtml();
  document.getElementById('modalBackdrop').classList.add('show');
  setTimeout(()=> document.getElementById('modal').classList.add('show'), 10);
  renderCheckoutCart();
  $('#closeModal2').onclick = closeModal;
  $('#cashPay').onclick = handleCashPay;
  $('#giftPay').onclick = handleGiftPay;
}
function checkoutHtml(){
  return `<div class="modal-header"><h2>Checkout</h2><button id="closeModal2" class="small">Close</button></div>
    <div class="checkout-grid">
      <div><h4>Cart</h4><div id="checkoutCart"></div><div class="order-summary" id="checkoutSummary"></div></div>
      <div>
        <h4>Pay with Cash (Reserve)</h4>
        <div class="checkout-forms">
          <input id="custName" class="input" placeholder="Full name">
          <input id="custEmail" class="input" placeholder="Email (optional)">
          <input id="custDate" class="input" type="date">
          <textarea id="custMsg" class="textarea" placeholder="Pickup notes"></textarea>
          <button class="btn" id="cashPay">Reserve with cash</button>
        </div>
        <h4 style="margin-top:12px">Pay with Giftcard</h4>
        <div class="checkout-forms">
          <input id="giftCode" class="input" placeholder="Giftcard code">
          <input id="giftAmount" class="input" placeholder="Amount (SAR)" type="number" min="0" step="0.01">
          <button class="btn" id="giftPay">Pay with giftcard</button>
        </div>
        <div class="hint">Overpay becomes in-store credit (recorded if email supplied).</div>
      </div>
    </div>`;
}
function renderCheckoutCart(){
  const el = $('#checkoutCart'); const sumEl = $('#checkoutSummary');
  el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${it.image}" alt=""><div style="flex:1"><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}
function handleCashPay(){
  const name = $('#custName').value.trim(); if(!name){ alert('Enter name'); return; }
  const date = $('#custDate').value; const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const order = {id:'order-'+Date.now(), name, date, email:$('#custEmail').value, cart, total, method:'cash', msg:$('#custMsg').value, done:false, created:Date.now()};
  let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
  alert('Cash reservation saved ‚Äî Order ID: '+order.id);
  cart = []; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategoryViewAfterOrder();
}
function handleGiftPay(){
  const code = $('#giftCode').value.trim() || ('GC-'+Math.floor(Math.random()*99999));
  const amount = Number($('#giftAmount').value) || 0; const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  if(amount < total){
    const remaining = total - amount;
    const order = {id:'order-'+Date.now(), total, paid:amount, method:'giftcard', code, remaining, done:false, created:Date.now()};
    let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    alert(`Partial paid SAR ${amount}. Remaining: SAR ${remaining.toFixed(2)}`);
  } else {
    const credit = +(amount - total);
    credits = +(credits + credit).toFixed(2); localStorage.setItem('storeCredit', credits);
    const order = {id:'order-'+Date.now(), total, paid:amount, method:'giftcard', code, storeCreditGained:credit, done:true, created:Date.now()};
    let orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    alert(`Payment saved. Gained SAR ${credit.toFixed(2)} in-store credit. Current credit: SAR ${credits.toFixed(2)}`);
  }
  cart=[]; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategoryViewAfterOrder();
}
function renderCategoryViewAfterOrder(){
  const catHeader = document.querySelector('.category-header');
  if(catHeader){ const cat = catHeader.querySelector('h2').textContent; renderCategoryProducts(cat); } else renderCategoriesView();
}

/* ---------- Request widget (minimizable) ---------- */
function initRequestWidget(){
  const widget = document.getElementById('requestWidget');
  const openBtn = document.getElementById('reqOpenBtn');
  const reqMin = document.getElementById('reqMin');
  const reqMin2 = document.getElementById('reqMin2');
  const reqClose = document.getElementById('reqClose');
  const reqSend = document.getElementById('reqSend');

  function refreshChat(){
    const mini = document.getElementById('reqChat');
    const data = JSON.parse(localStorage.getItem('requests')||'[]');
    mini.innerHTML = data.slice(-30).map(m=>`<div class="msg ${m.from==='owner'?'owner':'user'}"><strong>${m.name?m.name+': ':''}</strong>${escapeHtml(m.text)}</div>`).join('') || '<div class="meta">No requests yet.</div>';
    mini.scrollTop = mini.scrollHeight;
  }

  openBtn.onclick = ()=> {
    widget.classList.remove('minimized');
    openBtn.style.display = 'none';
  };
  reqMin.onclick = ()=> { widget.classList.add('minimized'); openBtn.style.display='block'; };
  reqMin2.onclick = ()=> { widget.classList.add('minimized'); openBtn.style.display='block'; };
  reqClose.onclick = ()=> { widget.classList.add('minimized'); openBtn.style.display='block'; };

  reqSend.onclick = ()=>{
    const name = $('#reqName').value.trim();
    const type = $('#reqType').value;
    const text = $('#reqText').value.trim();
    if(!text) return;
    const msg = {id:'r-'+Date.now(), name, type, text, from:'user', time:Date.now()};
    const arr = JSON.parse(localStorage.getItem('requests')||'[]'); arr.push(msg); localStorage.setItem('requests', JSON.stringify(arr));
    $('#reqText').value=''; refreshChat();
    setTimeout(()=>{ const reply = {id:'r-'+(Date.now()+1), name:'owner', type:'reply', text:'Thanks ‚Äî noted: '+text, from:'owner', time:Date.now()}; const a=JSON.parse(localStorage.getItem('requests')||'[]'); a.push(reply); localStorage.setItem('requests', JSON.stringify(a)); refreshChat(); }, 800);
  };

  refreshChat();
}

/* ---------- feedback widget ---------- */
function initFeedbackWidget(){
  $('#feedbackOpen').onclick = ()=> $('#feedbackPanel').classList.toggle('hidden');
  $('#feedbackClose').onclick = ()=> $('#feedbackPanel').classList.add('hidden');
  $('#feedbackSend').onclick = async ()=>{
    const text = $('#feedbackText').value.trim(); if(!text) return alert('Enter feedback');
    const email = $('#feedbackEmail').value.trim();
    // local save
    const arr = JSON.parse(localStorage.getItem('feedback')||'[]'); arr.push({id:'f-'+Date.now(), text, email, time:Date.now()}); localStorage.setItem('feedback', JSON.stringify(arr));
    // optional: post to /api/feedback if implemented
    try {
      await fetch('/api/feedback', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({text,email})}).catch(()=>null);
    } catch(e){}
    alert('Thanks for feedback');
    $('#feedbackText').value=''; $('#feedbackEmail').value='';
    $('#feedbackPanel').classList.add('hidden');
  };
}

/* ---------- admin button (opens admin separate) ---------- */
/* admin page will check password M.O.D8643 client-side */

/* ---------- attach events ---------- */
document.getElementById('cartBtn').onclick = ()=> openCheckout();

/* ---------- keyboard ---------- */
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

/* ---------- boot ---------- */
loadProducts();
</script>
</body>
</html>
