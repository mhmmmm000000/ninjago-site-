<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ninjago Marketplace</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="left-head">
      <div class="logo">Ninjago Marketplace</div>
      <div class="subtitle">Buy ‚Ä¢ Rent ‚Ä¢ Request ‚Ä¢ Feedback</div>
    </div>

    <div class="right-head">
      <div class="points" id="pointsBadge">Points: 0</div>
      <button id="themeToggle" class="btn small" title="Toggle theme">üåô</button>
      <input id="search" class="search" placeholder="Search sets, figures, books..." />
      <button id="cartBtn" class="btn">üõí <span id="cartCount">0</span></button>
      <a class="btn small" href="admin.html" target="_blank" rel="noopener noreferrer">Admin</a>
    </div>
  </header>

  <main class="container">
    <div class="top-row">
      <div class="hint">Tip: click the product box to view details. Use the categories below to browse.</div>
      <div class="mobile-actions">
        <button id="openFeedback" class="small">Feedback</button>
        <button id="openRequests" class="small">Requests</button>
      </div>
    </div>

    <div id="mainArea" class="main-area"></div>
  </main>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

  <!-- Floating request/chat (collapsible) -->
  <div class="floating" id="requestFloat" aria-hidden="false">
    <div class="floating-header">
      <div>Request / Chat</div>
      <div class="floating-controls">
        <button id="reqMin" class="small">‚Äî</button>
        <button id="reqClose" class="small">‚úï</button>
      </div>
    </div>
    <div class="floating-body" id="reqBody">
      <div id="miniChat" class="chat"></div>
      <div class="chat-inputs">
        <input id="miniName" class="input" placeholder="Your name (optional)">
        <select id="miniType" class="small">
          <option value="Set">Set</option><option value="Figure">Figure</option><option value="Box">Box/Instructions</option><option value="Other">Other</option>
        </select>
        <input id="miniReq" class="input" placeholder="What do you want to request?">
        <button id="miniSend" class="btn small">Send</button>
      </div>
    </div>
  </div>

  <!-- Feedback (collapsible) -->
  <div class="floating feedback" id="feedbackFloat" style="display:none">
    <div class="floating-header">
      <div>Feedback</div>
      <div class="floating-controls">
        <button id="fbMin" class="small">‚Äî</button>
        <button id="fbClose" class="small">‚úï</button>
      </div>
    </div>
    <div class="floating-body">
      <div id="feedbackList" class="chat"></div>
      <textarea id="fbText" class="textarea" placeholder="Tell us what you think..."></textarea>
      <div style="display:flex;gap:8px;margin-top:6px">
        <input id="fbName" class="input" placeholder="Name (optional)">
        <button id="fbSend" class="btn small">Send</button>
      </div>
    </div>
  </div>

<script>
/* ----------------- Helpers & State ----------------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
const escapeHtml = s => String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
let products = [];
const visitorIdKey = 'visitor_id';
let visitorId = localStorage.getItem(visitorIdKey);
if(!visitorId){ visitorId = 'v_' + Date.now() + '_' + Math.random().toString(36).slice(2,8); localStorage.setItem(visitorIdKey, visitorId); }
const cartKey = id => `cart_${id}`;
let cart = JSON.parse(localStorage.getItem(cartKey(visitorId)) || '[]');
let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
let points = Number(localStorage.getItem('points_'+visitorId) || 0);

/* ----------------- Load products.json ----------------- */
async function loadProducts(){
  try{
    const res = await fetch('products.json');
    products = await res.json();
  }catch(e){
    $('#mainArea').innerHTML = '<p class="hint error">Failed to load products.json ‚Äî check file.</p>';
    console.error(e);
    return;
  }
  initTheme();
  renderCategoriesView();
  renderCartCount();
  attachSearch();
  initFloatingControls();
  renderPoints();
  loadFeedbackList();
}
function initTheme(){
  const t = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
  $('#themeToggle').textContent = (t==='dark' ? 'üåô' : '‚òÄÔ∏è');
  $('#themeToggle').onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme')||'dark';
    const next = cur==='dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    $('#themeToggle').textContent = (next==='dark' ? 'üåô' : '‚òÄÔ∏è');
  };
}

/* ----------------- Categories ----------------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function catIcon(c){
  return {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Polybags':'üõçÔ∏è','Miscs':'‚öôÔ∏è','Books':'üìö','Rent':'üìñ'}[c]||'üì¶';
}
function renderCategoriesView(){
  const main = $('#mainArea'); main.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className='categories-grid';
  cats.forEach((cat,i)=>{
    const btn = document.createElement('button'); btn.className='category-tile';
    btn.innerHTML = `<div class="cat-emoji">${catIcon(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${products.filter(p=>p.category===cat).length} items</div>`;
    wrap.appendChild(btn);
    setTimeout(()=>btn.classList.add('show'), 60*i);
    btn.onclick = ()=> renderCategoryPage(cat);
  });
  main.appendChild(wrap);
}

/* ----------------- Category page & Grid ----------------- */
function renderCategoryPage(category){
  $('#mainArea').innerHTML = `
    <div class="category-header">
      <button id="catBack" class="btn small">‚Üê Back</button>
      <h2>${escapeHtml(category)}</h2>
      <div class="controls-inline">
        <select id="subFilter" class="small"></select>
        <button id="clearFilter" class="small">Clear</button>
      </div>
    </div>
    <div id="categoryProducts"></div>
  `;
  $('#catBack').onclick = renderCategoriesView;
  const items = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  const sel = $('#subFilter'); sel.innerHTML = `<option value="">All subthemes</option>` + subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  $('#clearFilter').onclick = ()=>{ sel.value=''; renderCategoryProducts(category); };
  sel.onchange = ()=> renderCategoryProducts(category, sel.value);
  renderCategoryProducts(category);
}

function renderCategoryProducts(category, subfilter){
  const cont = $('#categoryProducts'); cont.innerHTML = '';
  const search = ($('#search')?$('#search').value.trim().toLowerCase():'');
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'')===subfilter);
  if(search) items = items.filter(p=> (p.title + p.origin + (p.subtheme||'')).toLowerCase().includes(search));
  if(items.length===0){ cont.innerHTML = '<p class="hint">No items found.</p>'; return; }

  const grid = document.createElement('div'); grid.className='grid';
  items.forEach((p,i)=>{
    const thumb = Array.isArray(p.image) ? p.image[0] : p.image || 'images/placeholder.jpg';
    const hard = p.hard_to_find ? '<div class="hard">Hard to find</div>' : '';
    const rentBadge = p.category && p.category.toLowerCase().includes('rent') ? '<div class="rent-badge">RENT</div>' : '';
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="card-imgwrap">
        <img loading="lazy" src="${thumb}" alt="${escapeHtml(p.title)}">
        ${hard}${rentBadge}
      </div>
      <h3>${escapeHtml(p.title)}</h3>
      <div class="meta">${escapeHtml(p.origin||'')}</div>
      <div class="meta">${escapeHtml(p.condition||'')}</div>
      <div class="price">SAR ${p.price_sar}${p.price_discounted?` <span class="discount">SAR ${p.price_discounted}</span>`:''}</div>
      <div class="actions">
        <button class="btn add" data-id="${p.id}">Add</button>
        <button class="small view" data-id="${p.id}">Details</button>
      </div>
    `;
    // make entire card clickable to view
    card.addEventListener('click', (ev)=>{
      const target = ev.target;
      if(target.classList.contains('add')) return; // let add button handle
      if(target.classList.contains('view')) return;
      openDetail(p.id);
    });
    grid.appendChild(card);
    setTimeout(()=>card.classList.add('show'), 60*i);
  });
  cont.appendChild(grid);
  // attach simple handlers
  $$('.add').forEach(b=> b.onclick = (e)=>{ e.stopPropagation(); addToCart(b.dataset.id); });
  $$('.view').forEach(b=> b.onclick = (e)=>{ e.stopPropagation(); openDetail(b.dataset.id); });
}

/* ----------------- Search ----------------- */
function attachSearch(){
  const s = $('#search'); if(!s) return;
  s.addEventListener('input', ()=>{
    const catHeader = document.querySelector('.category-header');
    if(catHeader){
      const cat = catHeader.querySelector('h2').textContent;
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      renderCategoryProducts(cat, sub);
    } else {
      renderCategoriesView();
      const q = s.value.trim();
      if(!q) return;
      const results = products.filter(p=> (p.title+p.origin+(p.subtheme||'')).toLowerCase().includes(q.toLowerCase()));
      if(results.length){
        const resWrap = document.createElement('div'); resWrap.className='search-results';
        resWrap.innerHTML = `<h3 class="section-title">Quick results</h3><div class="grid"></div>`;
        results.forEach(p=> resWrap.querySelector('.grid').insertAdjacentHTML('beforeend', `<div class="card show"><div class="card-imgwrap"><img src="${Array.isArray(p.image)?p.image[0]:p.image}"></div><h3>${escapeHtml(p.title)}</h3><div class="meta">${escapeHtml(p.category)}</div><div class="price">SAR ${p.price_sar}</div></div>`));
        $('#mainArea').appendChild(resWrap);
      }
    }
  });
}

/* ----------------- Modal / Product Detail ----------------- */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image) ? p.image : (p.image ? [p.image] : ['images/placeholder.jpg']);
  const recHtml = (p.recommended||[]).map(rid=>{
    const r = products.find(x=>x.id===rid);
    if(!r) return '';
    return `<div class="rec"><img src="${Array.isArray(r.image)?r.image[0]:r.image}"><div><strong>${escapeHtml(r.title)}</strong><div class="meta">SAR ${r.price_sar}</div></div></div>`;
  }).join('');

  $('#modal').innerHTML = `
    <div class="modal-top">
      <h2>${escapeHtml(p.title)}</h2>
      <div><button id="closeModal" class="btn small">Close</button></div>
    </div>
    <div class="modal-grid">
      <div class="gallery">
        <div class="gallery-main"><img id="galleryMain" src="${imgs[0]}" onerror="this.src='images/placeholder.jpg'"></div>
        <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${u}" src="${u}" onerror="this.src='images/placeholder.jpg'">`).join('')}</div>
        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count? p.piece_count + ' pcs' : ''} ${p.figures_count? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="price large">SAR ${p.price_sar}${p.price_discounted?` <span class="discount">SAR ${p.price_discounted}</span>` : ''}</div>
        <div class="checkout-actions">
          <button id="cashPay" class="btn green">Pay with Cash (Reserve)</button>
          <button id="giftPay" class="btn accent">Pay with Giftcard</button>
          <button id="addCart" class="btn">Add to cart</button>
        </div>
        <div class="price-compare">${(p.price_comparisons||[]).map(c=>`<div class="item ${c.overpriced? 'over':''}"><a href="${c.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(c.site)}</a><div>${escapeHtml(c.price)}</div></div>`).join('')}</div>
      </div>

      <aside class="side">
        <div class="cart-mini">
          <h4>Quick cart</h4>
          <div id="quickCartList" class="cart-list"></div>
          <div class="order-summary" id="quickSummary"></div>
          <div style="margin-top:8px"><button class="btn" id="gotoCheckout">Go to checkout</button></div>
        </div>
        <div class="recommended-section">
          <h4>Recommended</h4>
          ${recHtml || '<div class="meta">No recommendations</div>'}
        </div>
      </aside>
    </div>
  `;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),20);
  $('#closeModal').onclick = closeModal;
  $$('.gthumb').forEach(t=> t.onclick = ()=>{ $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active');});
  $('#addCart').onclick = ()=> { addToCart(id); updateQuickCart(); };
  $('#cashPay').onclick = ()=> { if(!ensureSignedIn()) return; openCashFlow(id); };
  $('#giftPay').onclick = ()=> { if(!ensureSignedIn()) return; openGiftFlow(id); };
  $('#gotoCheckout').onclick = openCheckout;
  updateQuickCart();
}
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=>$('#modalBackdrop').classList.remove('show'),260); }

/* ----------------- Cart per visitor ----------------- */
function saveCart(){ localStorage.setItem(cartKey(visitorId), JSON.stringify(cart)); }
function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const existing = cart.find(c=>c.id===id);
  if(existing) existing.qty++; else cart.push({ id:p.id, title:p.title, price:p.price_sar, qty:1, image: Array.isArray(p.image)?p.image[0]:p.image });
  saveCart(); renderCartCount(); showToast('Added to cart');
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }
function updateQuickCart(){
  const el = $('#quickCartList'); const sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="cart-item"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

/* ----------------- Checkout flows ----------------- */
function ensureSignedIn(){
  if(currentUser && currentUser.email) return true;
  showSignInPopup();
  return false;
}
function showSignInPopup(){
  const html = `
    <div style="display:flex;justify-content:space-between;align-items:center"><h3>Sign in to continue</h3><div><button id="closeSign" class="btn small">X</button></div></div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
      <input id="signName" class="input" placeholder="Your name">
      <input id="signEmail" class="input" placeholder="Email">
      <div style="display:flex;gap:8px">
        <button id="signSubmit" class="btn">Sign in</button>
        <button id="signGuest" class="small">Continue as guest</button>
      </div>
    </div>
  `;
  $('#modal').innerHTML = html; $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  $('#closeSign').onclick = closeModal;
  $('#signGuest').onclick = ()=> { currentUser = { name:'Guest', email:null }; localStorage.setItem('currentUser', JSON.stringify(currentUser)); closeModal(); showToast('Continuing as guest'); };
  $('#signSubmit').onclick = ()=> {
    const n = $('#signName').value.trim(); const e = $('#signEmail').value.trim();
    if(!e){ alert('Please enter email'); return; }
    currentUser = { name:n||'Buyer', email:e };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    closeModal();
    showToast('Signed in as ' + (currentUser.name || currentUser.email));
  };
}
function openCashFlow(productId){
  // simple cash reservation modal
  const p = products.find(x=>x.id===productId);
  const total = p ? p.price_sar : cart.reduce((s,i)=>s+i.price*i.qty,0);
  $('#modal').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><h3>Reserve with cash</h3><div><button id="closeRes" class="btn small">X</button></div></div>
    <div style="margin-top:8px">
      <div class="meta">Name: ${escapeHtml(currentUser.name || '')} ‚Ä¢ Email: ${escapeHtml(currentUser.email || '')}</div>
      <div style="margin-top:8px">Total: <strong>SAR ${total.toFixed(2)}</strong></div>
      <label class="meta" style="margin-top:8px">Pickup date</label>
      <input id="resDate" class="input" type="date">
      <textarea id="resMsg" class="textarea" placeholder="Notes (pickup instructions)"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="confirmRes" class="btn green">Confirm reservation</button>
        <button id="cancelRes" class="small">Cancel</button>
      </div>
    </div>
  `;
  $('#closeRes').onclick = closeModal; $('#cancelRes').onclick = closeModal;
  $('#confirmRes').onclick = ()=> {
    // create order locally and award points
    const date = $('#resDate').value || '';
    const msg = $('#resMsg').value || '';
    const order = { id:'order_'+Date.now(), user:currentUser, date, msg, items: cart.length?cart:[products.find(x=>x.id===productId)], total, method:'cash', created:Date.now() };
    const orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    // award points: 1 point per SAR 10
    const gained = Math.floor(total/10);
    points = Number(points) + gained; localStorage.setItem('points_'+visitorId, points); renderPoints();
    cart = []; saveCart(); renderCartCount(); updateQuickCart(); closeModal();
    showToast('Reserved ‚Äî Order ID: '+order.id + ' ‚Ä¢ Points +' + gained);
  };
}
function openGiftFlow(productId){
  const p = products.find(x=>x.id===productId);
  const total = p ? p.price_sar : cart.reduce((s,i)=>s+i.price*i.qty,0);
  $('#modal').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><h3>Pay with Giftcard</h3><div><button id="closeGift" class="btn small">X</button></div></div>
    <div style="margin-top:8px">
      <div>Total: <strong>SAR ${total.toFixed(2)}</strong></div>
      <input id="giftCode" class="input" placeholder="Giftcard code">
      <input id="giftAmount" class="input" placeholder="Amount (SAR)" type="number" min="0" step="0.01">
      <div style="display:flex;gap:8px;margin-top:8px"><button id="confirmGift" class="btn accent">Use giftcard</button><button id="cancelGift" class="small">Cancel</button></div>
    </div>
  `;
  $('#closeGift').onclick = closeModal; $('#cancelGift').onclick = closeModal;
  $('#confirmGift').onclick = ()=> {
    const code = $('#giftCode').value.trim(); const amount = Number($('#giftAmount').value) || 0;
    // static fallback: accept giftcard as-is and produce store credit if overpay
    const used = Math.min(amount, total);
    const credit = amount > total ? +(amount - total).toFixed(2) : 0;
    if(amount <= 0){ alert('Enter amount'); return; }
    const order = { id:'order_'+Date.now(), user:currentUser, items: cart.length?cart:[products.find(x=>x.id===productId)], total, paid:amount, method:'giftcard', code, created:Date.now() };
    const orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    if(credit>0){ localStorage.setItem('storeCredit_'+(currentUser.email||visitorId), (Number(localStorage.getItem('storeCredit_'+(currentUser.email||visitorId))||0)+credit).toFixed(2)); showToast('In-store credit: SAR '+credit.toFixed(2)); }
    // award points slightly for gift use
    const gained = Math.floor(used/10);
    points = Number(points) + gained; localStorage.setItem('points_'+visitorId, points); renderPoints();
    cart = []; saveCart(); renderCartCount(); updateQuickCart(); closeModal();
    showToast('Paid with giftcard ‚Äî Order ID: '+order.id);
  };
}

/* ----------------- Checkout page (modal) ----------------- */
function openCheckout(){
  if(!ensureSignedIn()) return;
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  $('#modal').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><h3>Checkout</h3><div><button id="closeCheckout" class="btn small">X</button></div></div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
      <div style="flex:1;min-width:320px">
        <h4>Cart</h4>
        <div id="checkoutCart">${cart.map(it=>`<div class="cart-item"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart empty</div>'}</div>
        <div class="order-summary" id="checkoutSummary">Total: SAR ${total.toFixed(2)}</div>
      </div>
      <div style="width:320px">
        <h4>Pay with Cash</h4>
        <button id="checkoutCash" class="btn green">Reserve with cash</button>
        <h4 style="margin-top:12px">Pay with Giftcard</h4>
        <button id="checkoutGift" class="btn accent">Pay with giftcard</button>
      </div>
    </div>
  `;
  $('#closeCheckout').onclick = closeModal;
  $('#checkoutCash').onclick = ()=> openCashFlow(); // no product id -> uses cart
  $('#checkoutGift').onclick = ()=> openGiftFlow();
}

/* ----------------- Feedback & Requests ----------------- */
function initFloatingControls(){
  // request float minimize/close
  $('#reqMin').onclick = ()=> {
    const b = $('#reqBody');
    if(b.style.display === 'none'){ b.style.display='block'; $('#reqMin').textContent='‚Äî'; } else { b.style.display='none'; $('#reqMin').textContent='+'; }
  };
  $('#reqClose').onclick = ()=> { document.getElementById('requestFloat').style.display='none'; };
  // feedback open
  $('#openFeedback').onclick = ()=> { $('#feedbackFloat').style.display = 'block'; };
  $('#fbClose').onclick = ()=> { $('#feedbackFloat').style.display = 'none'; };
  $('#fbMin').onclick = ()=> {
    const b = $('#feedbackFloat .floating-body'); b.style.display = (b.style.display==='none' ? 'block' : 'none'); $('#fbMin').textContent = (b.style.display==='none' ? '+' : '‚Äî');
  };
  $('#openRequests').onclick = ()=> { document.getElementById('requestFloat').style.display='block'; };
  // send request
  $('#miniSend').onclick = ()=> {
    const text = $('#miniReq').value.trim(); if(!text) return;
    const obj = { id:'r_'+Date.now(), name:$('#miniName').value.trim(), type:$('#miniType').value, text, from:'user', time:Date.now() };
    const arr = JSON.parse(localStorage.getItem('requests')||'[]'); arr.push(obj); localStorage.setItem('requests', JSON.stringify(arr));
    $('#miniReq').value=''; loadMiniChat();
    setTimeout(()=> { const reply = { id:'r_'+(Date.now()+1), from:'owner', text:'Thanks ‚Äî we noted: ' + text, time:Date.now() }; const arr2 = JSON.parse(localStorage.getItem('requests')||'[]'); arr2.push(reply); localStorage.setItem('requests', JSON.stringify(arr2)); loadMiniChat(); }, 700);
  };
  loadMiniChat();
  // feedback send
  $('#fbSend').onclick = ()=> {
    const t = $('#fbText').value.trim(); if(!t) return;
    const fb = { id:'fb_'+Date.now(), name: $('#fbName').value.trim(), text:t, time:Date.now() };
    const list = JSON.parse(localStorage.getItem('feedback')||'[]'); list.push(fb); localStorage.setItem('feedback', JSON.stringify(list));
    $('#fbText').value=''; loadFeedbackList(); showToast('Thanks for feedback!');
  };
  loadFeedbackList();
}
function loadMiniChat(){
  const mini = $('#miniChat'); const list = JSON.parse(localStorage.getItem('requests')||'[]');
  if(!mini) return;
  mini.innerHTML = list.slice(-12).map(m=>`<div class="msg ${m.from==='user'?'user':'owner'}">${escapeHtml((m.name?m.name+': ':'')+m.text)}</div>`).join('') || '<div class="meta">No requests yet.</div>';
  mini.scrollTop = mini.scrollHeight;
}
function loadFeedbackList(){
  const el = $('#feedbackList'); if(!el) return;
  const list = JSON.parse(localStorage.getItem('feedback')||'[]');
  el.innerHTML = list.slice().reverse().map(f=>`<div class="msg owner"><strong>${escapeHtml(f.name||'Anonymous')}</strong><div class="meta">${new Date(f.time).toLocaleString()}</div><div style="margin-top:6px">${escapeHtml(f.text)}</div></div>`).join('') || '<div class="meta">No feedback yet.</div>';
}

/* ----------------- Admin quick login note ----------------- */
function fetchAdminPwd(){
  // admin.html uses admin.json; we keep this fetch for future checks if needed
  return fetch('admin.json').then(r=>r.json()).catch(()=>({admin_password:''}));
}

/* ----------------- Utilities ----------------- */
function showToast(msg){
  let t = document.getElementById('toast');
  if(!t){ t = document.createElement('div'); t.id='toast'; document.body.appendChild(t); }
  t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000);
}
function renderPoints(){ $('#pointsBadge').textContent = 'Points: ' + (points || 0); }

/* ----------------- Init and keyboard ----------------- */
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

loadProducts();
</script>
</body>
</html>
