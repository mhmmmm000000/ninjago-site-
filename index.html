<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Marketplace</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">Ninjago Marketplace</div>
      <div class="subtitle">Browse ‚Ä¢ Request ‚Ä¢ Reserve ‚Ä¢ Giftcard</div>
    </div>

    <div class="controls">
      <input id="search" class="search" placeholder="Search sets, figures, books...">
      <button id="themeToggle" class="btn small">üåô</button>
      <button id="cartBtn" class="btn">üõí <span id="cartCount">0</span></button>
      <a class="btn small" href="admin.html" target="_blank" rel="noopener noreferrer">Admin</a>
    </div>
  </header>

  <main class="container">
    <div class="top-row">
      <div class="hint">Tip: Click a product box/image to view details ‚Äî tap the cart to reserve or pay with giftcard.</div>
      <div class="actions">
        <button id="showFeedback" class="btn small">Feedback</button>
      </div>
    </div>

    <div id="mainArea" class="main-area"></div>
  </main>

  <!-- modal -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

  <!-- floating request (minimizable) -->
  <div id="requestBox" class="chat-floating">
    <div class="chat-head">
      <span>Request product üí¨</span>
      <button id="reqMin" class="small">‚Äî</button>
    </div>
    <div class="chat-body" id="chatBody">
      <div id="miniChat" class="chat"></div>
      <div class="chat-form">
        <input id="miniName" class="input" placeholder="Your name (optional)">
        <select id="miniType" class="small">
          <option>Set</option><option>Figure</option><option>Box/Instructions</option><option>Other</option>
        </select>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="miniReq" class="input" placeholder="What would you like to request?">
          <button id="miniSend" class="btn small">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- feedback modal -->
  <div id="feedbackModal" class="modal-backdrop" style="display:none">
    <div class="modal" role="dialog">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Send Feedback</h3>
        <button id="closeFeedback" class="btn small">Close</button>
      </div>
      <div style="margin-top:10px">
        <input id="fbName" class="input" placeholder="Your name (optional)">
        <input id="fbEmail" class="input" placeholder="Email (optional)">
        <textarea id="fbText" class="textarea" placeholder="Tell us what to improve"></textarea>
        <div style="display:flex;gap:8px">
          <button id="fbSend" class="btn">Send Feedback</button>
          <button id="fbClear" class="small">Clear</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- Helpers ---------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function uid(len=10){ const a='abcdefghijklmnopqrstuvwxyz0123456789'; let s=''; for(let i=0;i<len;i++) s+=a[Math.floor(Math.random()*a.length)]; return s; }

/* ---------- Client id + cart isolation ---------- */
let clientId = localStorage.getItem('nm_clientId');
if(!clientId){ clientId = uid(12); localStorage.setItem('nm_clientId', clientId); }
const cartKey = `nm_cart_${clientId}`;
let cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
let credits = Number(localStorage.getItem('nm_storeCredit_'+clientId) || 0);

/* ---------- Theme ---------- */
function initTheme(){
  const t = localStorage.getItem('nm_theme') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
  $('#themeToggle').textContent = t==='dark' ? 'üåô' : '‚òÄÔ∏è';
  $('#themeToggle').onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = cur==='dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('nm_theme', next);
    $('#themeToggle').textContent = next==='dark' ? 'üåô' : '‚òÄÔ∏è';
  };
}

/* ---------- Load products.json ---------- */
let products = [];
const mainArea = $('#mainArea');

async function loadProducts(){
  try {
    const res = await fetch('products.json');
    if(!res.ok) throw new Error('products.json not found');
    products = await res.json();
  } catch(e){
    mainArea.innerHTML = `<p class="hint" style="color:salmon">Failed to load products.json ‚Äî check file.</p>`;
    console.error(e);
    return;
  }
  initTheme();
  renderCategories();
  renderCartCount();
  attachSearch();
  loadChat();
}

/* ---------- UI renderers ---------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function categoryIcon(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Polybags':'üì¶','Books':'üìö','Miscs':'üßæ','Books (Rent)':'üìñ'};
  return map[cat] || 'üì¶';
}

function renderCategories(){
  mainArea.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className='categories-grid';
  cats.forEach((cat,i)=>{
    const tile = document.createElement('button'); tile.className='category-tile';
    tile.innerHTML = `<div class="cat-emoji">${categoryIcon(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${products.filter(p=>p.category===cat).length} items</div>`;
    tile.onclick = ()=> openCategory(cat);
    wrap.appendChild(tile);
    setTimeout(()=> tile.classList.add('show'), 60*i);
  });
  mainArea.appendChild(wrap);
}

function openCategory(cat){
  mainArea.innerHTML = `
    <div class="category-header">
      <button id="catBack" class="btn small">‚Üê Back</button>
      <h2>${escapeHtml(cat)}</h2>
      <div class="controls-inline">
        <select id="subFilter" class="small"></select>
        <button id="clearFilter" class="small">Clear</button>
      </div>
    </div>
    <div id="categoryProducts"></div>
  `;
  $('#catBack').onclick = renderCategories;
  const items = products.filter(p=>p.category===cat);
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  $('#subFilter').innerHTML = `<option value="">All subthemes</option>` + subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  $('#subFilter').onchange = ()=> renderCategoryProducts(cat, $('#subFilter').value);
  $('#clearFilter').onclick = ()=> { $('#subFilter').value=''; renderCategoryProducts(cat); };
  renderCategoryProducts(cat);
}

function renderCategoryProducts(category, subfilter){
  const cont = $('#categoryProducts');
  const s = ($('#search')?$('#search').value.trim().toLowerCase():'');
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'') === subfilter);
  if(s) items = items.filter(p => (p.title + p.origin + (p.subtheme||'')).toLowerCase().includes(s));
  if(items.length===0){ cont.innerHTML = '<p class="hint">No items found.</p>'; return; }

  const grid = document.createElement('div'); grid.className='grid';
  items.forEach((p,i)=>{
    const thumb = Array.isArray(p.image) ? p.image[0] : p.image;
    const hardTag = p.hard_to_find ? `<div class="hard">Hard to find</div>` : '';
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="card-img" data-id="${p.id}">
        <img src="${thumb}" alt="${escapeHtml(p.title)}" loading="lazy">
        ${hardTag}
      </div>
      <h3>${escapeHtml(p.title)}</h3>
      <div class="meta">${escapeHtml(p.origin||'')}</div>
      <div class="meta">${escapeHtml(p.condition||'')}</div>
      <div class="price">SAR ${p.price_sar}${p.price_discounted?'<span class="old"> SAR '+p.price_sar+'</span>':''}</div>
      <div class="card-actions">
        <button class="btn add" data-id="${p.id}">Add</button>
      </div>
    `;
    grid.appendChild(card);
    setTimeout(()=> card.classList.add('show'), 40*i);

    // click image/box to open details
    card.querySelector('.card-img').onclick = ()=> openDetail(p.id);
  });
  cont.innerHTML = ''; cont.appendChild(grid);
}

/* ---------- search ---------- */
function attachSearch(){
  const el = $('#search');
  if(!el) return;
  el.addEventListener('input', ()=>{
    const catHeader = document.querySelector('.category-header');
    if(catHeader){
      const cat = catHeader.querySelector('h2').textContent;
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      renderCategoryProducts(cat, sub);
    } else {
      renderCategories();
      const s = el.value.trim();
      if(!s) return;
      const results = products.filter(p=> (p.title+p.origin+(p.subtheme||'')).toLowerCase().includes(s.toLowerCase()));
      if(results.length){
        const wrap = document.createElement('div'); wrap.className='search-results';
        wrap.innerHTML = `<h3 class="section-title">Results</h3><div class="grid"></div>`;
        results.forEach(p=> wrap.querySelector('.grid').insertAdjacentHTML('beforeend', `<div class="card show"><div class="card-img"><img src="${Array.isArray(p.image)?p.image[0]:p.image}"></div><h3>${escapeHtml(p.title)}</h3><div class="meta">${escapeHtml(p.category)}</div><div class="price">SAR ${p.price_sar}</div></div>`));
        mainArea.appendChild(wrap);
      }
    }
  });
}

/* ---------- Product detail modal ---------- */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image)? p.image : [p.image];
  $('#modal').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>${escapeHtml(p.title)}</h2>
      <div><button id="closeModal" class="btn small">Close</button></div>
    </div>
    <div class="modal-grid">
      <div>
        <div class="gallery">
          <div class="gallery-main"><img id="galleryMain" src="${imgs[0]}" alt="${escapeHtml(p.title)}" onerror="this.src='images/placeholder.jpg'"></div>
          <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${u}" src="${u}" onerror="this.src='images/placeholder.jpg'">`).join('')}</div>
        </div>
        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count? p.piece_count + ' pcs' : ''} ${p.figures_count? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="price">SAR ${p.price_sar}${p.price_discounted? `<span class="discount"> SAR ${p.price_discounted}</span>` : ''}</div>
        <div style="margin-top:8px">
          <button class="btn" id="modalAdd">Add to cart</button>
          <button class="small" id="modalBuy">Buy now</button>
        </div>
        <div class="recommended">
          <h4>Recommended</h4>
          ${(p.recommended||[]).map(id=>{
            const r = products.find(x=>x.id===id);
            return r ? `<div class="rec"><img src="${Array.isArray(r.image)?r.image[0]:r.image}"><div><strong>${escapeHtml(r.title)}</strong><div class="meta">SAR ${r.price_sar}</div></div></div>` : '';
          }).join('')}
        </div>
      </div>
      <aside>
        <div class="cart-mini">
          <h4>Quick cart</h4>
          <div id="quickCartList" class="cart-list"></div>
          <div class="order-summary" id="quickSummary"></div>
          <div style="margin-top:8px"><button class="btn" id="gotoCheckout">Checkout</button></div>
        </div>
      </aside>
    </div>
  `;
  $('#modalBackdrop').classList.add('show');
  setTimeout(()=> $('#modal').classList.add('show'), 10);
  $('#closeModal').onclick = closeModal;
  $('#modalAdd').onclick = ()=> { addToCart(p.id); updateQuickCart(); };
  $('#modalBuy').onclick = ()=> { addToCart(p.id); openCheckout(); };
  $('#gotoCheckout').onclick = openCheckout;
  $$('.gthumb').forEach(t=> t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); });
  updateQuickCart();
}

function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=> $('#modalBackdrop').classList.remove('show'), 220); }

/* ---------- Cart (per client) ---------- */
function addToCart(id){
  const p = products.find(x=>x.id===id); if(!p) return;
  const item = cart.find(c=>c.id===id);
  if(item) item.qty++; else cart.push({id:p.id,title:p.title,price:p.price_sar,qty:1,image: Array.isArray(p.image)?p.image[0]:p.image});
  localStorage.setItem(cartKey, JSON.stringify(cart));
  renderCartCount(); updateQuickCart();
}

function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }

function updateQuickCart(){
  const el = $('#quickCartList'); const sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="cart-item"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

/* ---------- Checkout (local only) ---------- */
function openCheckout(){
  $('#modal').innerHTML = checkoutHtml();
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  renderCheckoutCart();
  $('#closeModal2').onclick = closeModal;
  $('#cashPay').onclick = handleCashPay;
  $('#giftPay').onclick = handleGiftPay;
}

function checkoutHtml(){
  return `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Checkout</h2><div><button id="closeModal2" class="btn small">Close</button></div></div>
    <div style="display:flex;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:320px"><h4>Cart</h4><div id="checkoutCart"></div><div class="order-summary" id="checkoutSummary"></div></div>
      <div style="width:340px">
        <h4>Pay with Cash (Reserve)</h4>
        <div class="checkout-forms">
          <input id="custName" class="input" placeholder="Full name">
          <input id="custEmail" class="input" placeholder="Email (optional)">
          <input id="custDate" class="input" type="date">
          <textarea id="custMsg" class="textarea" placeholder="Pickup notes"></textarea>
          <button class="btn" id="cashPay">Reserve with cash</button>
        </div>
        <h4 style="margin-top:12px">Pay with Giftcard</h4>
        <div class="checkout-forms">
          <input id="giftCode" class="input" placeholder="Giftcard code (demo)"><input id="giftAmount" class="input" placeholder="Amount (SAR)" type="number" min="0" step="0.01"><button class="btn" id="giftPay">Pay with giftcard</button>
        </div><div class="hint">If you overpay, remainder becomes in-store credit (local demo).</div>
      </div>
    </div>`;
}

function renderCheckoutCart(){
  const el = $('#checkoutCart'); const sumEl = $('#checkoutSummary');
  el.innerHTML = cart.map(it=>`<div class="checkout-item"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

function handleCashPay(){
  const name = $('#custName').value.trim(); if(!name){ alert('Enter name'); return; }
  const date = $('#custDate').value; const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const order = {id:'order-'+Date.now(),name,date,email:$('#custEmail').value,cart,total,method:'cash',msg:$('#custMsg').value,created:Date.now()};
  let orders = JSON.parse(localStorage.getItem('nm_orders')||'[]'); orders.push(order); localStorage.setItem('nm_orders', JSON.stringify(orders));
  alert('Cash reservation saved ‚Äî Order ID: '+order.id);
  cart=[]; localStorage.setItem(cartKey, JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategories();
}

function handleGiftPay(){
  const code = $('#giftCode').value.trim() || ('GC-'+Math.floor(Math.random()*99999));
  const amount = Number($('#giftAmount').value) || 0;
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  let orders = JSON.parse(localStorage.getItem('nm_orders')||'[]');
  if(amount < total){
    const remaining = total - amount;
    const order = {id:'order-'+Date.now(), total, paid:amount, method:'giftcard', code, remaining, created:Date.now()};
    orders.push(order); localStorage.setItem('nm_orders', JSON.stringify(orders));
    alert(`Partial paid SAR ${amount}. Remaining: SAR ${remaining.toFixed(2)}`);
  } else {
    const credit = +(amount - total);
    credits = +(credits + credit).toFixed(2); localStorage.setItem('nm_storeCredit_'+clientId, credits);
    const order = {id:'order-'+Date.now(), total, paid:amount, method:'giftcard', code, storeCreditGained:credit, created:Date.now()};
    orders.push(order); localStorage.setItem('nm_orders', JSON.stringify(orders));
    alert(`Payment successful. You gained SAR ${credit.toFixed(2)} in-store credit. Current credit: SAR ${credits.toFixed(2)}`);
  }
  cart=[]; localStorage.setItem(cartKey, JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategories();
}

/* ---------- Request mini-chat (minimizable) ---------- */
function loadChat(){
  const miniChat = $('#miniChat');
  $('#reqMin').onclick = ()=> {
    const body = $('#chatBody');
    if(body.style.display === 'none'){ body.style.display='block'; $('#reqMin').textContent='‚Äî'; }
    else { body.style.display='none'; $('#reqMin').textContent='+'; }
  };
  $('#miniSend').onclick = ()=>{
    const text = $('#miniReq').value.trim(); if(!text) return;
    const msg = {id:'r-'+Date.now(), name:$('#miniName').value.trim(), type:$('#miniType').value, text, from:'user', time:Date.now()};
    const arr = JSON.parse(localStorage.getItem('nm_requests')||'[]'); arr.push(msg); localStorage.setItem('nm_requests', JSON.stringify(arr));
    $('#miniReq').value=''; renderMiniChat();
    setTimeout(()=>{ const bot = {id:'r-'+(Date.now()+1), from:'owner', text:'Thanks ‚Äî we noted: '+text, time:Date.now()}; const a = JSON.parse(localStorage.getItem('nm_requests')||'[]'); a.push(bot); localStorage.setItem('nm_requests', JSON.stringify(a)); renderMiniChat(); },700);
  };
  renderMiniChat();
}
function renderMiniChat(){
  const mini = $('#miniChat'); const all = JSON.parse(localStorage.getItem('nm_requests')||'[]');
  mini.innerHTML = all.slice(-10).map(m=>`<div class="msg ${m.from==='user'?'user':'owner'}">${m.name?('<strong>'+escapeHtml(m.name)+'</strong> ‚Äî '):''}${escapeHtml(m.text)}</div>`).join('') || '<div class="meta">No requests yet</div>';
}

/* ---------- Feedback modal ---------- */
$('#showFeedback').onclick = ()=> { $('#feedbackModal').style.display='flex'; };
$('#closeFeedback').onclick = ()=> { $('#feedbackModal').style.display='none'; };
$('#fbSend').onclick = ()=> {
  const fb = {id:'fb-'+Date.now(), name:$('#fbName').value.trim(), email:$('#fbEmail').value.trim(), text:$('#fbText').value.trim(), time:Date.now()};
  const arr = JSON.parse(localStorage.getItem('nm_feedback')||'[]'); arr.push(fb); localStorage.setItem('nm_feedback', JSON.stringify(arr));
  alert('Thanks ‚Äî feedback saved locally.');
  $('#fbText').value=''; $('#feedbackModal').style.display='none';
};
$('#fbClear').onclick = ()=> { $('#fbName').value=''; $('#fbEmail').value=''; $('#fbText').value=''; };

/* ---------- Sign-in popup on first visit ---------- */
if(!localStorage.getItem('nm_seen_welcome')){
  const d = document.createElement('div'); d.id='welcomePopup'; d.className='modal-backdrop'; d.innerHTML = `<div class="modal"><div style="display:flex;justify-content:space-between"><h3>Welcome</h3><button id="closeWelcome" class="btn small">X</button></div><p style="margin-top:8px">Sign in for faster checkout (optional). You can close this and continue browsing.</p><div style="display:flex;gap:8px;margin-top:10px"><input id="wjEmail" class="input" placeholder="Your email (optional)"><button id="wjSign" class="btn">Sign in</button></div></div>`; document.body.appendChild(d);
  $('#closeWelcome').onclick = ()=> { document.getElementById('welcomePopup').remove(); localStorage.setItem('nm_seen_welcome','1'); };
  $('#wjSign').onclick = ()=> { localStorage.setItem('nm_user_email', $('#wjEmail').value.trim()); alert('Signed in locally'); document.getElementById('welcomePopup').remove(); localStorage.setItem('nm_seen_welcome','1'); };
}

/* ---------- Init ---------- */
$('#cartBtn').onclick = ()=> openCheckout();
loadProducts();

/* ---------- keyboard close ---------- */
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeModal(); } });

</script>
</body>
</html>
