<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ninjago Marketplace</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">Ninjago Marketplace</div>
      <div class="subtitle">Sets ‚Ä¢ Figures ‚Ä¢ Polybags ‚Ä¢ Blind Bags ‚Ä¢ Books ‚Ä¢ Miscs</div>
    </div>

    <div class="controls">
      <input id="search" class="search" placeholder="Search sets, figures, subthemes..." aria-label="Search">
      <button id="themeToggle" class="btn small" title="Toggle theme">üåô</button>
      <button id="feedbackBtn" class="btn small">Feedback</button>
      <button id="cartBtn" class="btn">üõí <span id="cartCount">0</span></button>
      <a id="adminLink" class="btn small" href="admin.html" target="_blank" rel="noopener noreferrer">Admin</a>
    </div>
  </header>

  <main class="container">
    <div id="mainArea" class="main-area"></div>
  </main>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

  <!-- Floating request chat (minimizable) -->
  <div id="floatingRequest" class="chat-floating minimized" aria-hidden="false">
    <div class="chat-head">
      <span>Request product üí¨</span>
      <div class="chat-controls">
        <button id="toggleChat" class="small">‚ñæ</button>
        <button id="closeChat" class="small">‚úï</button>
      </div>
    </div>
    <div class="chat-body">
      <div id="miniChat" class="chat"></div>
      <div class="chat-form">
        <select id="miniType" class="small">
          <option>Set</option><option>Figure</option><option>Box/Instructions</option><option>Other</option>
        </select>
        <input id="miniReq" class="input" placeholder="Request details (e.g., set # or figure name)">
        <button id="miniSend" class="btn small">Send</button>
      </div>
    </div>
  </div>

  <!-- Sign-in / marketing popup (shows once unless closed) -->
  <div id="signinPopup" class="signin-popup hidden" role="dialog" aria-modal="true">
    <div class="signin-content">
      <button id="closeSignin" class="close-x">‚úï</button>
      <h2>Welcome to Ninjago Marketplace</h2>
      <p>Sign in to get faster checkout and store credit. You can also browse without signing in.</p>
      <input id="signinEmail" class="input" placeholder="Your email (optional)">
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="signinContinue" class="btn">Continue (no password)</button>
        <button id="signinSkip" class="small">Skip for now</button>
      </div>
    </div>
  </div>

<script>
/* ----------------- Helpers & State ----------------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

let products = [];
// session-based cart (unique per visitor)
let sessionId = localStorage.getItem('ninjago_session') || ('s_' + Math.random().toString(36).slice(2,10));
localStorage.setItem('ninjago_session', sessionId);
const cartKey = `cart_${sessionId}`;
let cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
let credits = JSON.parse(localStorage.getItem('store_credits')|| '{}'); // { email: amount }
const mainArea = $('#mainArea');

/* ----------------- Load products.json ----------------- */
async function loadProducts(){
  try{
    const res = await fetch('products.json');
    products = await res.json();
  } catch(e){
    mainArea.innerHTML = '<p class="hint error">Failed to load products.json ‚Äî check file.</p>';
    console.error('Failed to load products.json', e);
    return;
  }
  initTheme();
  renderHome();
  attachGlobalHandlers();
  showSigninIfNeeded();
  initFloatingRequest();
  renderCartCount();
}

/* ----------------- Theme ----------------- */
function initTheme(){
  const t = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
  $('#themeToggle').textContent = t==='dark' ? 'üåô' : '‚òÄÔ∏è';
  $('#themeToggle').onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = cur==='dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    $('#themeToggle').textContent = next==='dark' ? 'üåô' : '‚òÄÔ∏è';
  };
}

/* ----------------- UI: categories / tiles ----------------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function categoryEmoji(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Polybags':'üõçÔ∏è','Blind Bags':'üéÅ','Books':'üìö','Miscs':'üîß','Books (Rent)':'üìñ'};
  return map[cat] || 'üì¶';
}
function renderHome(){
  mainArea.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className='categories-grid';
  cats.forEach((cat,i)=>{
    const count = products.filter(p=>p.category===cat).length;
    const btn = document.createElement('button'); btn.className='category-tile';
    btn.innerHTML = `<div class="cat-emoji">${categoryEmoji(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${count} items</div>`;
    wrap.appendChild(btn);
    setTimeout(()=>btn.classList.add('show'), 60*i);
    btn.onclick = ()=> renderCategory(cat);
  });
  mainArea.appendChild(wrap);
}

/* ----------------- Category page & product grid ----------------- */
function renderCategory(cat){
  mainArea.innerHTML = `
    <div class="category-header">
      <button id="backBtn" class="btn small">‚Üê Back</button>
      <h2>${escapeHtml(cat)}</h2>
      <div class="controls-inline">
        <select id="subFilter" class="small"></select>
        <button id="clearFilter" class="small">Clear</button>
      </div>
    </div>
    <div id="productsGrid" class="grid"></div>
  `;
  $('#backBtn').onclick = renderHome;
  const items = products.filter(p=>p.category===cat);
  const subs = Array.from(new Set(items.map(x=>x.subtheme||'Misc')));
  const sel = $('#subFilter');
  sel.innerHTML = `<option value="">All subthemes</option>` + subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  sel.onchange = ()=> renderGrid(cat, sel.value);
  $('#clearFilter').onclick = ()=> { sel.value = ''; renderGrid(cat); };
  renderGrid(cat);
}

function renderGrid(cat, sub){
  const grid = $('#productsGrid');
  grid.innerHTML = '';
  const q = ($('#search')?$('#search').value.trim().toLowerCase():'');
  let items = products.filter(p=>p.category===cat);
  if(sub) items = items.filter(p=> (p.subtheme||'') === sub);
  if(q) items = items.filter(p=> (p.title + p.origin + (p.subtheme||'')).toLowerCase().includes(q));
  if(items.length === 0){ grid.innerHTML = '<p class="hint">No items found.</p>'; return; }

  items.forEach((p,i)=>{
    const thumb = Array.isArray(p.image) ? p.image[0] : p.image || 'images/placeholder.jpg';
    const hard = p.hard_to_find ? '<span class="hard">Hard to find</span>' : '';
    const html = `
      <div class="card" data-id="${p.id}">
        <div class="imgWrap" data-id="${p.id}">
          <img loading="lazy" src="${thumb}" alt="${escapeHtml(p.title)}" />
          ${hard}
        </div>
        <div class="card-body">
          <h3 class="card-title">${escapeHtml(p.title)}</h3>
          <div class="meta">${escapeHtml(p.origin||'')}</div>
          <div class="meta small">${escapeHtml(p.condition||'')}</div>
          <div class="price">SAR ${p.price_sar}</div>
          <div class="card-actions">
            <button class="btn add" data-id="${p.id}">Add</button>
            <button class="small view" data-id="${p.id}">Details</button>
          </div>
        </div>
      </div>`;
    grid.insertAdjacentHTML('beforeend', html);
    setTimeout(()=> grid.lastElementChild.classList.add('show'), 60*i);
  });

  // clicking the image box opens detail (user requested)
  $$('.imgWrap').forEach(el => el.onclick = e => openDetail(el.dataset.id));
  $$('.view').forEach(b => b.onclick = e => openDetail(b.dataset.id));
  $$('.add').forEach(b => b.onclick = e => addToCart(b.dataset.id));
}

/* ----------------- Search ----------------- */
$('#search')?.addEventListener('input', ()=> {
  const catHeader = document.querySelector('.category-header');
  if(catHeader) {
    const cat = catHeader.querySelector('h2').textContent;
    const sub = $('#subFilter') ? $('#subFilter').value : '';
    renderGrid(cat, sub);
  } else {
    renderHome();
    const s = $('#search').value.trim();
    if(!s) return;
    // show quick results under categories
    const results = products.filter(p => (p.title + p.origin + (p.subtheme||'')).toLowerCase().includes(s.toLowerCase()));
    if(results.length){
      const resWrap = document.createElement('div'); resWrap.className='search-results';
      resWrap.innerHTML = `<h3 class="section-title">Quick results</h3><div class="grid quick"></div>`;
      results.forEach(p => resWrap.querySelector('.grid').insertAdjacentHTML('beforeend',
        `<div class="card show"><div class="imgWrap" data-id="${p.id}"><img src="${Array.isArray(p.image)?p.image[0]:p.image}"></div><h3>${escapeHtml(p.title)}</h3><div class="meta">${escapeHtml(p.category)}</div><div class="price">SAR ${p.price_sar}</div><div class="card-actions"><button class="btn view" data-id="${p.id}">Details</button></div></div>`));
      mainArea.appendChild(resWrap);
      $$('.imgWrap').forEach(el => el.onclick = e => openDetail(el.dataset.id));
      $$('.view').forEach(b => b.onclick = e => openDetail(b.dataset.id));
    }
  }
});

/* ----------------- Product detail modal (gallery, recommended, price compares) ----------------- */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image) ? p.image : [p.image||'images/placeholder.jpg'];
  $('#modal').innerHTML = `
    <div class="modal-header">
      <h2>${escapeHtml(p.title)}</h2>
      <button id="closeModal" class="small">Close</button>
    </div>
    <div class="modal-grid">
      <div class="left">
        <div class="gallery-main"><img id="galleryMain" src="${imgs[0]}" alt="${escapeHtml(p.title)}"></div>
        <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${u}" src="${u}">`).join('')}</div>
        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count? p.piece_count + ' pcs' : ''} ${p.figures_count? ' ‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="price big">SAR ${p.price_sar}</div>
        <div class="checkout-row">
          <button id="cashReserve" class="btn green">Reserve with cash</button>
          <button id="giftPayBtn" class="btn">Pay with giftcard</button>
        </div>
      </div>
      <aside class="right">
        <div class="cart-mini">
          <h4>Quick cart</h4>
          <div id="quickCart" class="cart-list"></div>
          <div class="order-summary" id="quickTotal"></div>
          <div style="margin-top:10px"><button id="gotoCheckout" class="btn">Open Checkout</button></div>
        </div>

        <div class="recommended">
          <h4>Recommended</h4>
          ${(p.recommended||[]).map(rid => {
            const r = products.find(x=>x.id===rid);
            if(!r) return '';
            return `<div class="rec">
              <img src="${Array.isArray(r.image)?r.image[0]:r.image}" alt="${escapeHtml(r.title)}">
              <div><strong>${escapeHtml(r.title)}</strong><div class="meta">SAR ${r.price_sar}</div></div>
            </div>`;
          }).join('')}
        </div>
      </aside>
    </div>
  `;
  $('#modalBackdrop').classList.add('show');
  setTimeout(()=> $('#modal').classList.add('show'), 10);
  $('#closeModal').onclick = closeModal;
  $$('.gthumb').forEach(t => t.onclick = ()=> {
    $('#galleryMain').src = t.dataset.src;
    $$('.gthumb').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
  });
  updateQuickMini();
  $('#cashReserve').onclick = ()=> openCashForm(id);
  $('#giftPayBtn').onclick = ()=> openGiftForm(id);
  $('#gotoCheckout').onclick = ()=> { closeModal(); openCheckout(); };
}
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=>$('#modalBackdrop').classList.remove('show'), 220); }

/* ----------------- Cart per session ----------------- */
function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const item = cart.find(c=>c.id===id);
  if(item) item.qty++; else cart.push({ id:p.id, title:p.title, price:p.price_sar, qty:1, image: Array.isArray(p.image)?p.image[0]:p.image });
  saveCart();
  renderCartCount();
  updateQuickMini();
}
function saveCart(){ localStorage.setItem(cartKey, JSON.stringify(cart)); }
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }
function updateQuickMini(){
  const el = $('#quickCart'); const totalEl = $('#quickTotal');
  if(!el) return;
  if(cart.length===0){ el.innerHTML = '<div class="meta">Cart is empty</div>'; totalEl.innerHTML=''; return; }
  el.innerHTML = cart.map(it=>`<div class="mini-item"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('');
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  totalEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

/* ----------------- Checkout flows (separate) ----------------- */
function openCashForm(productId){
  const p = products.find(x=>x.id===productId);
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0) || (p? p.price_sar:0);
  $('#modal').innerHTML = `
    <div class="modal-header"><h2>Reserve with cash</h2><button id="closeModal2" class="small">Close</button></div>
    <div class="checkout-forms">
      <div class="order-summary">Total: <strong>SAR ${total.toFixed(2)}</strong></div>
      <input id="custName" class="input" placeholder="Full name">
      <input id="custEmail" class="input" placeholder="Email (optional)">
      <input id="custDate" class="input" type="date">
      <textarea id="custMsg" class="textarea" placeholder="Pickup notes"></textarea>
      <div style="display:flex;gap:8px"><button id="confirmCash" class="btn green">Confirm Reserve</button><button id="cancelCash" class="small">Cancel</button></div>
    </div>
  `;
  $('#closeModal2').onclick = closeModal;
  $('#cancelCash').onclick = closeModal;
  $('#confirmCash').onclick = ()=> {
    const name = $('#custName').value.trim();
    if(!name){ alert('Enter your name'); return; }
    const email = $('#custEmail').value.trim();
    const date = $('#custDate').value;
    const msg = $('#custMsg').value;
    const order = { id: 'order-'+Date.now(), method:'cash', name, email, date, msg, cart, total, created: Date.now() };
    saveOrder(order);
    cart = []; saveCart(); renderCartCount(); alert('Reservation saved ‚Äî ID: '+order.id);
    closeModal();
  };
}

function openGiftForm(productId){
  const p = products.find(x=>x.id===productId);
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0) || (p? p.price_sar:0);
  $('#modal').innerHTML = `
    <div class="modal-header"><h2>Pay with Giftcard</h2><button id="closeModal2" class="small">Close</button></div>
    <div class="checkout-forms">
      <div class="order-summary">Total: <strong>SAR ${total.toFixed(2)}</strong></div>
      <input id="giftCode" class="input" placeholder="Giftcard code">
      <input id="giftAmount" class="input" type="number" placeholder="Amount to use (SAR)">
      <input id="giftEmail" class="input" placeholder="Your email (for store credit)">
      <div style="display:flex;gap:8px"><button id="confirmGift" class="btn">Confirm Payment</button><button id="cancelGift" class="small">Cancel</button></div>
      <div class="hint">If amount > total, remainder becomes store credit (requires email).</div>
    </div>
  `;
  $('#closeModal2').onclick = closeModal;
  $('#cancelGift').onclick = closeModal;
  $('#confirmGift').onclick = async ()=> {
    const code = $('#giftCode').value.trim();
    const amount = Number($('#giftAmount').value) || 0;
    const email = $('#giftEmail').value.trim().toLowerCase() || null;
    if(!code){ alert('Enter giftcard code'); return; }
    // attempt server redeem if available ‚Äî else fallback local simulation
    try{
      const res = await fetch('/api/giftcards', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'redeem', code, amount, total, email })
      });
      const j = await res.json();
      if(res.ok){
        // j: { ok:true, deducted, remainingBalance, creditGiven }
        const order = { id:'order-'+Date.now(), method:'giftcard', code, paid:j.deducted, creditGiven:j.creditGiven || 0, email, cart, total, created:Date.now() };
        saveOrder(order);
        if(j.creditGiven && email){
          const sc = JSON.parse(localStorage.getItem('store_credits')||'{}');
          sc[email] = +( (sc[email]||0) + j.creditGiven ).toFixed(2);
          localStorage.setItem('store_credits', JSON.stringify(sc));
        }
        cart = []; saveCart(); renderCartCount(); alert('Payment saved ‚Äî Order ID: '+order.id);
        closeModal();
        return;
      } else {
        throw new Error(j.error || 'redeem failed');
      }
    } catch(e){
      // fallback local: naive validate code 'GC-TEST' for demo
      if(code === 'GC-TEST'){
        const deducted = Math.min(amount, total, 9999);
        let creditGiven = 0;
        if(amount > total) creditGiven = +(amount - total).toFixed(2);
        const order = { id:'order-'+Date.now(), method:'giftcard', code, paid:deducted, creditGiven, email, cart, total, created:Date.now() };
        saveOrder(order);
        if(creditGiven && email){
          const sc = JSON.parse(localStorage.getItem('store_credits')||'{}');
          sc[email] = +( (sc[email]||0) + creditGiven ).toFixed(2);
          localStorage.setItem('store_credits', JSON.stringify(sc));
        }
        cart = []; saveCart(); renderCartCount(); alert('Payment recorded (demo) ‚Äî Order ID: '+order.id);
        closeModal();
      } else {
        alert('Giftcard redeem failed (demo) ‚Äî try code GC-TEST or configure server API.');
      }
    }
  };
}

/* ----------------- Orders storage (local fallback) ----------------- */
function saveOrder(order){
  const arr = JSON.parse(localStorage.getItem('orders') || '[]');
  arr.push(order);
  localStorage.setItem('orders', JSON.stringify(arr));
}

/* ----------------- Checkout page (full) ----------------- */
function openCheckout(){
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  $('#modal').innerHTML = `
    <div class="modal-header"><h2>Checkout</h2><button id="closeModal2" class="small">Close</button></div>
    <div class="checkout-grid">
      <div>
        <h4>Your cart</h4>
        <div id="checkoutItems"></div>
        <div class="order-summary">Total: <strong>SAR ${total.toFixed(2)}</strong></div>
      </div>
      <div class="pay-panel">
        <h4>Payment options</h4>
        <button id="checkoutCash" class="btn green big">Reserve with cash</button>
        <button id="checkoutGift" class="btn big">Pay with giftcard</button>
      </div>
    </div>
  `;
  $('#closeModal2').onclick = closeModal;
  renderCheckoutItems();
  $('#checkoutCash').onclick = ()=> openCashForm();
  $('#checkoutGift').onclick = ()=> openGiftForm();
}
function renderCheckoutItems(){
  const el = $('#checkoutItems');
  if(!el) return;
  if(cart.length === 0) { el.innerHTML = '<div class="meta">Cart empty</div>'; return; }
  el.innerHTML = cart.map(it => `<div class="mini-item"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('');
}

/* ----------------- Feedback modal ----------------- */
$('#feedbackBtn').onclick = ()=> openFeedback();
function openFeedback(){
  $('#modal').innerHTML = `
    <div class="modal-header"><h2>Feedback</h2><button id="closeFb" class="small">Close</button></div>
    <div class="checkout-forms">
      <input id="fbName" class="input" placeholder="Your name (optional)">
      <input id="fbEmail" class="input" placeholder="Email (optional)">
      <textarea id="fbMsg" class="textarea" placeholder="Tell us what we can improve"></textarea>
      <div style="display:flex;gap:8px"><button id="sendFb" class="btn">Send Feedback</button><button id="cancelFb" class="small">Cancel</button></div>
    </div>
  `;
  $('#closeFb').onclick = closeModal;
  $('#cancelFb').onclick = closeModal;
  $('#sendFb').onclick = ()=> {
    const msg = $('#fbMsg').value.trim();
    if(!msg){ alert('Type feedback'); return; }
    const list = JSON.parse(localStorage.getItem('feedback') || '[]');
    list.push({ id:'fb-'+Date.now(), name: $('#fbName').value.trim(), email: $('#fbEmail').value.trim(), msg, created: Date.now() });
    localStorage.setItem('feedback', JSON.stringify(list));
    // optional: post to /api/feedback if available
    fetch('/api/feedback', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name:$('#fbName').value,email:$('#fbEmail').value,msg}) }).catch(()=>{});
    alert('Thanks for your feedback!');
    closeModal();
  };
}

/* ----------------- Floating request chat (minimizable) ----------------- */
function initFloatingRequest(){
  const el = $('#floatingRequest');
  if(!el) return;
  const miniChat = $('#miniChat');
  function loadChat(){ const items = JSON.parse(localStorage.getItem('requests')||'[]'); miniChat.innerHTML = items.slice(-30).map(m => `<div class="msg ${m.from==='owner'?'owner':'user'}">${escapeHtml(m.type?('['+m.type+'] ':'')+m.text)}</div>`).join('') || '<div class="meta">No requests</div>'; }
  $('#miniSend').onclick = ()=> {
    const text = $('#miniReq').value.trim(); if(!text) return;
    const type = $('#miniType').value;
    const arr = JSON.parse(localStorage.getItem('requests')||'[]'); arr.push({ id:'req-'+Date.now(), from:'user', type, text, time:Date.now() }); localStorage.setItem('requests', JSON.stringify(arr));
    $('#miniReq').value = '';
    loadChat();
    // auto owner reply for UX
    setTimeout(()=>{ const arr2 = JSON.parse(localStorage.getItem('requests')||'[]'); arr2.push({ id:'req-'+(Date.now()+1), from:'owner', type:'note', text:'Thanks ‚Äî noted: '+text }); localStorage.setItem('requests', JSON.stringify(arr2)); loadChat(); }, 700);
  };
  $('#toggleChat').onclick = ()=> {
    el.classList.toggle('minimized');
    $('#toggleChat').textContent = el.classList.contains('minimized') ? '‚ñæ' : '‚ñ¥';
  };
  $('#closeChat').onclick = ()=> { el.classList.add('minimized'); localStorage.setItem('chat_minimized', '1'); };
  if(localStorage.getItem('chat_minimized') === '1') el.classList.add('minimized');
  loadChat();
}

/* ----------------- Sign-in popup ----------------- */
function showSigninIfNeeded(){
  if(localStorage.getItem('hide_signin') === '1') return;
  const popup = $('#signinPopup');
  popup.classList.remove('hidden');
  $('#closeSignin').onclick = ()=> { popup.classList.add('hidden'); localStorage.setItem('hide_signin','1'); };
  $('#signinSkip').onclick = ()=> { popup.classList.add('hidden'); localStorage.setItem('hide_signin','1'); };
  $('#signinContinue').onclick = ()=> {
    const email = $('#signinEmail').value.trim();
    if(email) localStorage.setItem('user_email', email);
    popup.classList.add('hidden');
    localStorage.setItem('hide_signin','1');
  };
}

/* ----------------- Utility / global handlers ----------------- */
function attachGlobalHandlers(){
  $('#cartBtn').onclick = ()=> openCheckout();
  document.addEventListener('keydown', e => { if(e.key === 'Escape') closeModal(); });
}

/* ----------------- Admin helpers ----------------- */
/* Admin UI is separate (admin.html). We only store orders locally here. */

/* ----------------- Init ----------------- */
loadProducts();
</script>
</body>
</html>
