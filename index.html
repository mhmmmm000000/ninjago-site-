<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ninjago Marketplace</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">Ninjago Marketplace</div>
      <div class="subtitle">Browse ‚Ä¢ Request ‚Ä¢ Reserve ‚Ä¢ Giftcard</div>
    </div>
    <div class="controls">
      <input id="search" class="search" placeholder="Search sets, figures, books..." />
      <button id="themeToggle" class="btn small">üåô</button>
      <button id="signupBtn" class="btn small">Sign up / Log in</button>
      <button id="cartBtn" class="btn">üõí <span id="cartCount">0</span></button>
      <a class="btn small" href="admin.html" target="_blank" rel="noopener noreferrer">Admin</a>
    </div>
  </header>

  <main class="container">
    <div class="top-row">
      <div class="hint">Click a category tile to enter. Click the product box to view details. Sign in is required to order.</div>
    </div>

    <div id="mainArea" class="main-area"></div>
  </main>

  <!-- Modals and overlays -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

  <!-- Login / Signup Modal template -->
  <template id="loginTpl">
    <div class="auth-card">
      <h2>Sign up / Log in</h2>
      <p class="meta">Only email is stored for orders. Enter your email to continue.</p>
      <input id="authEmail" class="input" placeholder="you@example.com" type="email" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="authDo" class="btn">Continue</button>
        <button id="authCancel" class="small">Cancel</button>
      </div>
      <div class="meta" style="margin-top:8px">Already have an account? Just enter the same email to continue.</div>
    </div>
  </template>

  <!-- Signup quick UI in header fallback -->
  <div id="userBadge" class="user-badge" aria-hidden="true" style="display:none">
    <div id="userEmail" class="user-email"></div>
    <div class="user-points" id="userPoints"></div>
    <button id="logoutBtn" class="small">Log out</button>
  </div>

<script>
/* ---------- Utilities ---------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
const escapeHtml = s => String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
let products = [];
let currentUser = JSON.parse(localStorage.getItem('nm_user')||'null'); // {email, points}
let cart = []; // will become per-user cart loaded when user logs in
const mainArea = $('#mainArea');

/* ---------- Load products ---------- */
async function loadProducts(){
  try{
    const res = await fetch('products.json');
    if(!res.ok) throw new Error('bad');
    products = await res.json();
  }catch(e){
    mainArea.innerHTML = '<p class="hint error">Failed to load products.json ‚Äî check file.</p>';
    console.error(e);
    return;
  }
  initTheme();
  renderHeaderUser();
  renderCategoriesView();
  attachSearch();
  initFloatingRequest();
}

/* ---------- Theme ---------- */
function initTheme(){
  const t = localStorage.getItem('nm_theme') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
  $('#themeToggle').textContent = t==='dark' ? 'üåô' : '‚òÄÔ∏è';
  $('#themeToggle').onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = cur==='dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('nm_theme', next);
    $('#themeToggle').textContent = next==='dark' ? 'üåô' : '‚òÄÔ∏è';
  };
}

/* ---------- Auth / user ---------- */
function renderHeaderUser(){
  const badge = $('#userBadge');
  if(currentUser && currentUser.email){
    $('#userEmail').textContent = currentUser.email;
    $('#userPoints').textContent = `Points: ${currentUser.points||0}`;
    badge.style.display = 'flex';
    $('#signupBtn').style.display = 'none';
    loadCartForUser();
  } else {
    badge.style.display = 'none';
    $('#signupBtn').style.display = 'inline-block';
    $('#cartCount').textContent = '0';
  }
}
function openAuth(){
  const tpl = document.getElementById('loginTpl').content.cloneNode(true);
  $('#modal').innerHTML = ''; $('#modal').appendChild(tpl);
  openModal();
  $('#authCancel').onclick = closeModal;
  $('#authDo').onclick = ()=>{
    const em = $('#authEmail').value.trim().toLowerCase();
    if(!em || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em)){ alert('Enter a valid email'); return; }
    // save user minimal data (email only)
    currentUser = { email: em, points: Number(localStorage.getItem('nm_points_'+em) || 0) };
    localStorage.setItem('nm_user', JSON.stringify(currentUser));
    renderHeaderUser();
    closeModal();
    alert('Signed in as ' + em);
  };
}
$('#signupBtn').onclick = openAuth;
$('#logoutBtn').onclick = ()=>{
  if(!currentUser) return;
  // persist points
  localStorage.setItem('nm_points_'+currentUser.email, currentUser.points||0);
  currentUser = null;
  localStorage.removeItem('nm_user');
  renderHeaderUser();
  cart = [];
  localStorage.removeItem('nm_cart'); // optional
  alert('Logged out');
};

/* ---------- per-user cart ---------- */
function cartKey(){
  return currentUser ? 'nm_cart_'+currentUser.email : 'nm_cart_guest';
}
function loadCartForUser(){
  const k = cartKey();
  cart = JSON.parse(localStorage.getItem(k) || '[]');
  renderCartCount();
}
function saveCart(){
  localStorage.setItem(cartKey(), JSON.stringify(cart));
}

/* ---------- Categories view ---------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function categoryIcon(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Books':'üìö','Polybags':'üëú','Miscs':'‚öôÔ∏è','Books (Rent)':'üìñ'};
  return map[cat] || 'üì¶';
}
function renderCategoriesView(){
  mainArea.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className='categories-grid';
  cats.forEach((cat,i)=>{
    const btn = document.createElement('button'); btn.className='category-tile';
    const count = products.filter(p=>p.category===cat).length;
    btn.innerHTML = `<div class="cat-emoji">${categoryIcon(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${count} items</div>`;
    wrap.appendChild(btn);
    setTimeout(()=>btn.classList.add('show'), 50*i);
    btn.onclick = ()=> renderCategoryPage(cat);
  });
  mainArea.appendChild(wrap);

  // optional: show quick signup CTA
  const promo = document.createElement('div'); promo.className='home-cta';
  promo.innerHTML = `<button class="btn signup-cta" id="homeSignupBtn">Create account to order</button>`;
  mainArea.appendChild(promo);
  $('#homeSignupBtn').onclick = ()=> openAuth();
}

/* ---------- Category page ---------- */
function renderCategoryPage(category){
  mainArea.innerHTML = `
    <div class="category-header">
      <button id="catBack" class="btn small">‚Üê Back</button>
      <h2>${escapeHtml(category)}</h2>
      <div class="controls-inline">
        <select id="subFilter" class="small"></select>
        <button id="clearFilter" class="small">Clear</button>
      </div>
    </div>
    <div id="categoryProducts"></div>
  `;
  $('#catBack').onclick = renderCategoriesView;
  const items = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  $('#subFilter').innerHTML = `<option value="">All</option>` + subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  $('#subFilter').onchange = ()=> renderCategoryProducts(category, $('#subFilter').value);
  $('#clearFilter').onclick = ()=> { $('#subFilter').value=''; renderCategoryProducts(category); };
  renderCategoryProducts(category);
}
function renderCategoryProducts(category, subfilter){
  const cont = $('#categoryProducts'); cont.innerHTML = '';
  const search = ($('#search')?$('#search').value.trim().toLowerCase():'');
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'')===subfilter);
  if(search) items = items.filter(p => (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(search));
  if(items.length===0){ cont.innerHTML = '<p class="hint">No items found.</p>'; return; }
  const grid = document.createElement('div'); grid.className='grid';
  items.forEach((p,i)=>{
    const card = document.createElement('div'); card.className='card';
    const img = Array.isArray(p.image) ? p.image[0] : p.image;
    const hard = p.hard_to_find ? `<div class="hard" title="Hard to find">Hard to find</div>` : '';
    card.innerHTML = `
      <div class="box" data-id="${p.id}">
        <img src="${img}" alt="${escapeHtml(p.title)}" loading="lazy">
      </div>
      <h3>${escapeHtml(p.title)}</h3>
      <div class="meta">${escapeHtml(p.origin||'')}</div>
      <div class="meta">${escapeHtml(p.condition||'')}</div>
      <div class="price">SAR ${p.price_sar}${p.price_discounted ? ' <small class="old">SAR '+p.price_sar+'</small>' : ''}</div>
      ${hard}
      <div class="contact">
        <button class="btn view" data-id="${p.id}">View</button>
        <button class="small add" data-id="${p.id}">Add</button>
      </div>
    `;
    grid.appendChild(card);
    setTimeout(()=>card.classList.add('show'), 40*i);
  });
  cont.appendChild(grid);

  // make the whole .box clickable and open product modal
  $$('.box').forEach(b => b.onclick = ()=> openDetail(b.dataset.id));
  attachCardEvents();
}

/* ---------- Search ---------- */
function attachSearch(){
  $('#search').addEventListener('input', ()=> {
    const catHeader = document.querySelector('.category-header');
    if(catHeader){
      const cat = catHeader.querySelector('h2').textContent;
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      renderCategoryProducts(cat, sub);
    } else {
      renderCategoriesView();
      const s = $('#search').value.trim();
      if(!s) return;
      const results = products.filter(p=> (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(s.toLowerCase()));
      if(results.length){
        const resWrap = document.createElement('div'); resWrap.className='search-results';
        resWrap.innerHTML = `<h3 class="section-title">Quick results</h3><div class="grid"></div>`;
        results.forEach(p=> resWrap.querySelector('.grid').insertAdjacentHTML('beforeend', `<div class="card show"><div class="box" data-id="${p.id}"><img src="${Array.isArray(p.image)?p.image[0]:p.image}"></div><h3>${escapeHtml(p.title)}</h3><div class="meta">${escapeHtml(p.category)}</div><div class="price">SAR ${p.price_sar}</div><div class="contact"><button class="btn view" data-id="${p.id}">View</button></div></div>`));
        mainArea.appendChild(resWrap);
        $$('.box').forEach(b => b.onclick = ()=> openDetail(b.dataset.id));
        attachCardEvents();
      }
    }
  });
}

/* ---------- Card events ---------- */
function attachCardEvents(){
  $$('.view').forEach(b=> b.onclick = ()=> openDetail(b.dataset.id));
  $$('.add').forEach(b=> b.onclick = ()=> addToCart(b.dataset.id));
}

/* ---------- Modal / Product detail ---------- */
function openModal(){ $('#modalBackdrop').classList.add('show'); setTimeout(()=> $('#modal').classList.add('show'), 20); }
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=> $('#modalBackdrop').classList.remove('show'), 200); }

function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image) ? p.image : [p.image];
  $('#modal').innerHTML = `
    <div class="modal-header">
      <h2>${escapeHtml(p.title)}</h2>
      <div><button id="closeModal" class="btn small">Close</button></div>
    </div>
    <div class="modal-grid">
      <div class="left">
        <div class="gallery">
          <div class="gallery-main"><img id="galleryMain" src="${imgs[0]}" onerror="this.src='images/placeholder.jpg'"></div>
          <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${u}" src="${u}" onerror="this.src='images/placeholder.jpg'">`).join('')}</div>
        </div>

        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count? p.piece_count + ' pcs' : ''} ${p.figures_count? ' ‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="price">SAR ${p.price_sar}${p.price_discounted ? ` <small class="old">SAR ${p.price_sar}</small> <span class="discount">SAR ${p.price_discounted}</span>` : ''}</div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn" id="modalAdd">Add to cart</button>
          <button class="small" id="modalBuy">Buy now</button>
        </div>

        <div class="price-compare">
          <h4>Price comparisons</h4>
          ${ (p.price_comparisons||[]).map(c=>`<div class="item ${c.overpriced? 'over':''}"><a href="${c.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(c.site)}</a><div>${escapeHtml(c.price)}</div></div>`).join('') }
        </div>

        <div class="recommended">
          <h4>Recommended</h4>
          ${(p.recommended||[]).map(id=>{
            const r = products.find(x=>x.id===id);
            return r ? `<div class="rec"><img src="${Array.isArray(r.image)?r.image[0]:r.image}"><div><strong>${escapeHtml(r.title)}</strong><div class="meta">SAR ${r.price_sar}</div></div></div>` : '';
          }).join('')}
        </div>
      </div>

      <aside class="right">
        <div class="cart-mini">
          <h4>Quick cart</h4>
          <div id="quickCartList" class="cart-list"></div>
          <div class="order-summary" id="quickSummary"></div>
          <div style="margin-top:8px"><button class="btn" id="gotoCheckout">Go to checkout</button></div>
        </div>
      </aside>
    </div>
  `;
  openModal();
  $('#closeModal').onclick = closeModal;
  $('#modalAdd').onclick = ()=> { addToCart(p.id); updateQuickCart(); };
  $('#modalBuy').onclick = ()=> { addToCart(p.id); openCheckout(); };
  $('#gotoCheckout').onclick = openCheckout;
  $$('.gthumb').forEach(t=> t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); });
  updateQuickCart();
}

/* ---------- Cart ---------- */
function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const key = cartKey();
  let c = cart.find(x=>x.id===id);
  if(c) c.qty++; else cart.push({ id: p.id, title: p.title, price: p.price_discounted || p.price_sar, qty: 1, image: Array.isArray(p.image)?p.image[0]:p.image });
  saveCart(); renderCartCount(); updateQuickCart();
}
function cartKey(){ return currentUser ? 'nm_cart_'+currentUser.email : 'nm_cart_guest'; }
function renderCartCount(){ $('#cartCount').textContent = cart.reduce((s,i)=>s+i.qty,0); }
function updateQuickCart(){
  const el = $('#quickCartList'); const sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

/* ---------- Checkout ---------- */
function openCheckout(){
  if(!currentUser){ // require login
    alert('Please sign in to place an order.');
    openAuth();
    return;
  }
  $('#modal').innerHTML = checkoutHtml();
  openModal();
  renderCheckoutCart();
  $('#closeModal2').onclick = closeModal;
  $('#cashPay').onclick = handleCashPay;
  $('#giftPay').onclick = handleGiftPay;
}
function checkoutHtml(){
  return `
    <div class="modal-header">
      <h2>Checkout</h2>
      <div><button id="closeModal2" class="btn small">Close</button></div>
    </div>
    <div class="checkout-grid">
      <div>
        <h4>Cart</h4>
        <div id="checkoutCart"></div>
        <div class="order-summary" id="checkoutSummary"></div>
      </div>
      <div class="checkout-actions">
        <h4>Payment options</h4>
        <p class="meta">Choose a payment option. Signing in is required (we only store your email).</p>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn pay-cash" id="cashPay">Pay with Cash (Reserve)</button>
          <button class="btn pay-gift" id="giftPay">Pay with Giftcard</button>
        </div>
        <div style="margin-top:10px">
          <label>Pickup date</label>
          <input id="custDate" class="input" type="date">
        </div>
        <div style="margin-top:10px">
          <label>Message</label>
          <textarea id="custMsg" class="textarea" placeholder="Pickup instructions (optional)"></textarea>
        </div>
      </div>
    </div>
  `;
}
function renderCheckoutCart(){
  const el = $('#checkoutCart'); const sumEl = $('#checkoutSummary');
  el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}
function handleCashPay(){
  if(!currentUser){ alert('Sign in first'); openAuth(); return; }
  const date = $('#custDate').value;
  const msg = $('#custMsg').value || '';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const order = { id:'order-'+Date.now(), email: currentUser.email, cart, total, method:'cash', date, msg, created: Date.now() };
  // save to local orders list
  let orders = JSON.parse(localStorage.getItem('nm_orders')||'[]'); orders.push(order); localStorage.setItem('nm_orders', JSON.stringify(orders));
  // user points: 1 point per SAR
  currentUser.points = (currentUser.points || 0) + Math.round(total);
  localStorage.setItem('nm_user', JSON.stringify(currentUser));
  localStorage.setItem('nm_points_'+currentUser.email, currentUser.points);
  saveCart();
  cart = []; saveCart();
  renderCartCount();
  closeModal();
  alert('Cash reservation saved. Order ID: ' + order.id + '\nYou earned ' + Math.round(total) + ' points.');
  renderHeaderUser();
}
function handleGiftPay(){
  if(!currentUser){ alert('Sign in first'); openAuth(); return; }
  const code = prompt('Enter giftcard code (demo):');
  if(!code){ alert('No code'); return; }
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  // For demo, we accept any code and treat it as full payment (you can implement server check)
  const order = { id:'order-'+Date.now(), email: currentUser.email, cart, total, method:'giftcard', code, created: Date.now() };
  let orders = JSON.parse(localStorage.getItem('nm_orders')||'[]'); orders.push(order); localStorage.setItem('nm_orders', JSON.stringify(orders));
  currentUser.points = (currentUser.points || 0) + Math.round(total);
  localStorage.setItem('nm_user', JSON.stringify(currentUser));
  localStorage.setItem('nm_points_'+currentUser.email, currentUser.points);
  cart = []; saveCart(); renderCartCount();
  closeModal();
  alert('Giftcard recorded. Order ID: '+order.id + '\nYou earned ' + Math.round(total) + ' points.');
  renderHeaderUser();
}

/* ---------- Requests (floating chat) ---------- */
function initFloatingRequest(){
  // ensure single instance
  if(document.querySelector('.chat-floating')) return;
  const wrap = document.createElement('div'); wrap.className='chat-floating collapsed';
  wrap.innerHTML = `<div class="chat-head"><span>Request product</span><div class="chat-controls"><button id="chatToggle" class="small">_</button></div></div>
    <div class="chat-body"><div id="miniChat" class="chat"></div>
    <div class="chat-input"><input id="miniReq" class="input" placeholder="Request a set/figure"><button id="miniSend" class="btn small">Send</button></div></div>`;
  document.body.appendChild(wrap);
  $('#chatToggle').onclick = ()=> { wrap.classList.toggle('collapsed'); $('#miniChat').scrollTop = 9999; };
  $('#miniSend').onclick = ()=> {
    const text = $('#miniReq').value.trim(); if(!text) return;
    const entry = { id:'req-'+Date.now(), from: currentUser ? currentUser.email : 'guest', text, time: Date.now() };
    const existing = JSON.parse(localStorage.getItem('nm_requests')||'[]'); existing.push(entry); localStorage.setItem('nm_requests', JSON.stringify(existing));
    $('#miniReq').value = '';
    loadMiniChat();
  };
  loadMiniChat();
}
function loadMiniChat(){
  const mini = $('#miniChat'); if(!mini) return;
  const list = JSON.parse(localStorage.getItem('nm_requests')||'[]');
  mini.innerHTML = list.slice(-30).map(m=>`<div class="msg ${m.from==='guest'?'user':'owner'}"><strong>${escapeHtml(m.from)}</strong>: ${escapeHtml(m.text)}</div>`).join('') || '<div class="meta">No requests yet.</div>';
}

/* ---------- Quick cart UI ---------- */
function updateQuickCart(){
  const el = $('#quickCartList'), sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  if(sumEl) sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}

/* ---------- Admin sign-in gating for checkout / admin will be simple client-side password check in admin.html ---------- */

/* ---------- Init & events ---------- */
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });
$('#cartBtn').onclick = ()=> openCheckout();
$('#cartCount').textContent = '0';
$('#signupBtn').onclick = openAuth; // header signup
loadProducts();

</script>
</body>
</html>
