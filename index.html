<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Vault ‚Äî Marketplace</title>

<!-- Tailwind micro (optional) -->
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

<style>
  :root{
    --bg:#0b0f13; --surface:#0f1720; --card:#0f1720; --muted:#9aa4b2; --text:#e6eef6; --accent:#00c853; --price:#ff6b6b; --glass:rgba(255,255,255,0.03);
  }
  :root[data-theme="light"]{ --bg:#fff; --surface:#f6f7f9; --card:#fff; --muted:#6b7280; --text:#111827; --accent:#0b8f5b; --price:#d22b2b; --glass:rgba(0,0,0,0.04); }
  html,body{height:100%}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;transition:background .25s,color .25s}
  /* header */
  .site-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--surface);border-bottom:1px solid rgba(255,255,255,0.04);position:sticky;top:0;z-index:40}
  .brand{display:flex;flex-direction:column}
  .logo{font-weight:900;font-size:18px;cursor:pointer;user-select:none}
  .subtitle{color:var(--muted);font-size:13px}
  .header-right{display:flex;align-items:center;gap:10px}
  .search{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);min-width:200px}
  .btn{background:#111827;color:#fff;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn.small{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;font-weight:700;color:var(--text)}
  .container{max-width:1200px;margin:18px auto;padding:0 16px}
  .hint{color:var(--muted);margin-bottom:12px}

  /* nav */
  .main-nav{display:flex;gap:8px;align-items:center;padding:8px 16px;overflow-x:auto;border-bottom:1px solid rgba(255,255,255,0.02);background:linear-gradient(0deg, rgba(0,0,0,0.02), transparent)}
  .nav-item{background:transparent;border:0;color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
  .nav-item.active{color:var(--text);background:rgba(255,255,255,0.02);transform:translateY(-2px)}

  /* landing hero */
  .hero { display:flex;align-items:center;justify-content:center;gap:24px;padding:48px 16px;min-height:60vh; }
  .hero-card { background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:28px;border-radius:16px;max-width:900px;width:100%;display:grid;grid-template-columns:1fr 320px;gap:18px;align-items:center;box-shadow:0 8px 40px rgba(0,0,0,0.4) }
  .hero-left h1{font-size:44px;margin:0 0 8px}
  .hero-left p{color:var(--muted);margin:0 0 18px}
  .hero-actions{display:flex;gap:12px;flex-wrap:wrap}
  .big-btn{padding:14px 20px;border-radius:12px;font-weight:800;cursor:pointer;transition:transform .18s ease,box-shadow .18s;display:inline-flex;gap:10px;align-items:center}
  .big-btn.primary{background:linear-gradient(90deg,#0bb852,#00c853);color:#042a10}
  .big-btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .big-btn:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.45)}

  /* cards & grid */
  .categories-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-top:12px}
  .category-tile{background:var(--card);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:8px;transform:translateY(8px);opacity:0;transition:all .45s cubic-bezier(.2,.9,.2,1)}
  .category-tile.show{opacity:1;transform:none}
  .cat-emoji{font-size:32px}
  .cat-title{font-weight:700}
  .cat-count{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .card{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);opacity:0;transform:translateY(14px);transition:all .45s cubic-bezier(.2,.9,.2,1);display:flex;flex-direction:column;gap:6px}
  .card.show{opacity:1;transform:none}
  .card .card-image{position:relative;cursor:pointer;border-radius:8px;overflow:hidden}
  .card img{width:100%;height:180px;object-fit:cover;display:block;transition:transform .35s ease}
  .card:hover img{transform:scale(1.03)}
  .card h3{margin:6px 0 4px;font-size:16px;color:var(--text)}
  .meta{color:var(--muted);font-size:13px}
  .price{font-weight:800;color:var(--price);margin-top:6px}
  .contact{display:flex;gap:8px;margin-top:10px;align-items:center}
  .hard{position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.65);padding:6px;border-radius:6px;font-weight:700;font-size:12px;color:#fff}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:80}
  .modal-backdrop.show{display:flex}
  .modal{background:var(--card);width:92%;max-width:980px;border-radius:12px;padding:18px;color:var(--text);box-shadow:0 10px 40px rgba(0,0,0,0.4);transform:scale(.98) translateY(8px);opacity:0;transition:all .22s ease}
  .modal.show{transform:none;opacity:1}
  .modal-grid{display:grid;grid-template-columns:1fr 320px;gap:20px}
  .gallery-main img{width:100%;height:320px;object-fit:contain;border-radius:8px;background:var(--glass)}
  .gallery-thumbs{display:flex;gap:8px;margin-top:8px;overflow:auto}
  .gallery-thumbs img{width:72px;height:56px;object-fit:cover;border-radius:6px;cursor:pointer;opacity:.9}
  .gthumb.active{outline:2px solid var(--accent)}
  .rec{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .rec img{width:64px;height:48px;object-fit:cover;border-radius:6px}

  .cart-mini{background:var(--surface);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .cart-list{max-height:220px;overflow:auto;margin-top:8px}
  .order-summary{background:var(--glass);padding:12px;border-radius:8px;margin-top:10px}
  .checkout-forms{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .input,.textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
  .textarea{min-height:80px}
  .cart-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .cart-row img{width:48px;height:40px;object-fit:cover;border-radius:6px}

  /* chat */
  .chat-floating{position:fixed;right:18px;bottom:18px;width:300px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:var(--card);z-index:90;box-shadow:0 8px 30px rgba(0,0,0,0.4)}
  .chat-head{padding:8px 10px;background:var(--surface);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.02)}
  .chat-body{padding:10px}
  .chat{height:160px;overflow:auto;padding:8px;border-radius:8px;background:var(--glass);display:flex;flex-direction:column;gap:8px}
  .msg{max-width:78%;padding:8px 10px;border-radius:8px}
  .msg.user{align-self:flex-end;background:#111827;color:#fff}
  .msg.owner{align-self:flex-start;background:rgba(255,255,255,0.06);color:var(--text)}

  /* small screens */
  @media(max-width:920px){
    .modal-grid{grid-template-columns:1fr}
    .gallery-main img{height:220px}
    .card img{height:160px}
    .categories-grid{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
    .hero-card{grid-template-columns:1fr; padding:20px}
  }

  /* animations */
  @keyframes fadeUp { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:none} }
  .fade-up{animation:fadeUp .45s cubic-bezier(.2,.9,.2,1) forwards}
  .bump { animation: bump .36s cubic-bezier(.2,.9,.2,1); }
  @keyframes bump { 0%{transform:scale(1)} 50%{transform:scale(1.08)} 100%{transform:scale(1)} }

  /* toast */
  .toast-wrap{position:fixed;right:18px;top:18px;z-index:150;display:flex;flex-direction:column;gap:8px}
  .toast{background:#111;padding:10px 12px;border-radius:10px;color:#fff;box-shadow:0 8px 30px rgba(0,0,0,0.4);opacity:0;transform:translateY(-8px);animation:toastIn .28s forwards}
  @keyframes toastIn{to{opacity:1;transform:none}}
  .toast.success{background:linear-gradient(90deg,#0bb852,#0bce7b)}
  .toast.warn{background:linear-gradient(90deg,#f6b93b,#f0932b)}
</style>
</head>
<body>

  <!-- header -->
  <header class="site-header">
    <div class="brand">
      <div id="siteLogo" class="logo">Ninjago Vault</div>
      <div id="subtitle" class="subtitle">Browse ‚Ä¢ Request ‚Ä¢ Reserve</div>
    </div>

    <div class="header-right">
      <input id="search" class="search" placeholder="Search sets, figures, books...">
      <button id="themeToggle" class="btn small">üåì</button>
      <button id="signupBtn" class="btn small">Sign up / Sign in</button>
      <button id="cartBtn" class="btn">üõí <span id="cartCount">0</span></button>
    </div>
  </header>

  <!-- nav -->
  <nav class="main-nav">
    <button class="nav-item active" data-view="home">Home</button>
    <button class="nav-item" data-view="catalog">Shop</button>
    <button class="nav-item" data-view="game">Game</button>
    <button class="nav-item" data-view="rewards">Rewards</button>
    <button class="nav-item" data-view="requests">Requests</button>
    <button class="nav-item" data-view="feedback">Feedback</button>
  </nav>

  <main class="container">
    <div id="mainArea" class="main-area"></div>
  </main>

  <!-- modal -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

  <!-- sign-in modal -->
  <div id="signinBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="signinModal" class="modal" role="dialog" aria-modal="true" style="max-width:420px;">
      <h2>Sign up / Sign in</h2>
      <p class="meta">Only email is required. We store only your email locally (no passwords) to improve checkout.</p>
      <input id="inputEmail" class="input" placeholder="Your email">
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="btnSaveEmail" class="btn">Save & Continue</button>
        <button id="btnCloseSignin" class="btn small">Close</button>
      </div>
    </div>
  </div>

  <!-- chat floating -->
  <div id="chatFloating" class="chat-floating" aria-hidden="false">
    <div class="chat-head">
      <span>Request product üí¨</span>
      <div style="display:flex;gap:6px;align-items:center">
        <button id="minimizeChat" class="small">‚Äî</button>
      </div>
    </div>
    <div id="chatBody" class="chat-body">
      <div id="miniChat" class="chat"></div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <input id="miniReq" class="input" placeholder="Request a set or figure">
        <button id="miniSend" class="btn small">Send</button>
      </div>
    </div>
  </div>

  <div id="toastWrap" class="toast-wrap"></div>

<script>
/* ---------- Utilities ---------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- Toast ---------- */
function showToast(text, type='') {
  const wrap = $('#toastWrap');
  if(!wrap) return;
  const t = document.createElement('div');
  t.className = 'toast ' + (type || '');
  t.innerText = text;
  wrap.appendChild(t);
  setTimeout(()=> { t.style.opacity = '1'; }, 10);
  setTimeout(()=> { t.style.opacity = '0'; t.style.transform = 'translateY(-6px)'; }, 3500);
  setTimeout(()=> { if(t.parentNode) t.parentNode.removeChild(t); }, 4000);
}

/* ---------- State ---------- */
let products = [];
let currentView = 'home';
let cart = [];
let userEmail = localStorage.getItem('nm_user_email') || '';
const mainArea = $('#mainArea');

/* ---------- Load products ---------- */
async function loadProducts(){
  try{
    const res = await fetch('products.json');
    products = await res.json();
  }catch(e){
    // show basic home if products fail to load
    products = [];
    console.error('Failed to load products.json', e);
  }
  renderView();
  renderCartCount();
  attachSearch();
  loadChat();
}
loadProducts();

/* ---------- Theme ---------- */
function initTheme(){
  const saved = localStorage.getItem('nm_theme') || 'dark';
  setTheme(saved);
  $('#themeToggle').onclick = () => {
    const t = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
    setTheme(t);
  };
}
function setTheme(t){ document.documentElement.dataset.theme = t; localStorage.setItem('nm_theme', t); }
initTheme();

/* ---------- Admin shortcut (Ctrl+Shift + click logo) ---------- */
$('#siteLogo').addEventListener('click', (ev) => {
  if(ev.ctrlKey && ev.shiftKey){
    // open admin page in new tab (if present)
    const url = 'admin.html';
    window.open(url, '_blank', 'noopener');
    showToast('Admin: opened admin.html (new tab)', 'success');
    return;
  }
  // default homepage behavior: go home
  currentView = 'home';
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelector('.nav-item[data-view="home"]').classList.add('active');
  renderView();
});

/* ---------- Navigation ---------- */
$$('.nav-item').forEach(b => b.addEventListener('click', (ev) => {
  const view = b.dataset.view;
  currentView = view;
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  b.classList.add('active');
  renderView();
}));

function renderView(){
  if(currentView === 'home') renderHome();
  else if(currentView === 'catalog' || currentView === 'shop') renderCategoriesView();
  else if(currentView === 'game') renderGameView();
  else if(currentView === 'rewards') renderRewardsView();
  else if(currentView === 'requests') renderRequestsView();
  else if(currentView === 'feedback') renderFeedbackView();
}

/* ---------- HOME (hero with big actions) ---------- */
function renderHome(){
  mainArea.innerHTML = `
    <div class="hero fade-up">
      <div class="hero-card fade-up">
        <div class="hero-left">
          <h1>Ninjago Vault</h1>
          <p>Official-style fan marketplace ‚Äî sets, figures, polybags, books and more. Animated, lightweight, and built for collectors.</p>
          <div class="hero-actions">
            <button id="enterVault" class="big-btn primary">Enter Vault ‚Äî Shop</button>
            <button id="playGame" class="big-btn ghost">Game ‚Äî Coming soon</button>
            <button id="discover" class="big-btn ghost">Discover ‚Äî Vault Highlights</button>
          </div>
        </div>
        <div class="hero-right" style="display:flex;flex-direction:column;gap:12px;align-items:center">
          <img src="https://www.lego.com/cdn/cs/set/assets/bltb076164b9c1ce28d/5009966_Prod.jpg" alt="Shatterspin" style="width:260px;border-radius:10px;object-fit:cover">
          <div style="color:var(--muted);font-size:13px">Featured: Shatterspin ‚Äî Book & Extras</div>
        </div>
      </div>
    </div>
    <div id="homeExtras" style="margin-top:18px"></div>
  `;

  $('#enterVault').onclick = ()=> {
    currentView = 'catalog';
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelector('.nav-item[data-view="catalog"]').classList.add('active');
    renderView();
    window.scrollTo({top:0,behavior:'smooth'});
  };
  $('#playGame').onclick = ()=> {
    // show coming soon modal
    $('#modal').innerHTML = `<div style="text-align:center"><h2>Game ‚Äî Coming Soon</h2><p class="meta">We are building this ‚Äî follow the project for updates.</p><div style="margin-top:12px"><button id="closeComing" class="btn">Close</button></div></div>`;
    $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
    $('#closeComing').onclick = closeModal;
  };
  $('#discover').onclick = ()=> {
    showToast('Vault Highlights coming ‚Äî use catalog for full browsing', 'success');
  };
}

/* ---------- Categories (Shop) ---------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))).filter(Boolean); }
function categoryIcon(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Polybags':'üõçÔ∏è','Miscs':'üì¶','Books':'üìö'}; return map[cat]||'üì¶';
}
function renderCategoriesView(){
  mainArea.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className = 'categories-grid';
  if(cats.length === 0){
    wrap.innerHTML = `<div class="hint">No categories found in products.json ‚Äî add items to products.json</div>`;
  }else{
    cats.forEach((cat,i)=>{
      const tile = document.createElement('button'); tile.className='category-tile';
      tile.innerHTML = `<div class="cat-emoji">${categoryIcon(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${products.filter(p=>p.category===cat).length} items</div>`;
      tile.onclick = ()=> renderCategoryPage(cat);
      wrap.appendChild(tile);
      setTimeout(()=>tile.classList.add('show'), 70*i);
    });
  }
  mainArea.appendChild(wrap);
}

/* ---------- Category page ---------- */
function renderCategoryPage(category){
  mainArea.innerHTML = `
    <div class="category-header">
      <button id="catBack" class="btn small">‚Üê Back</button>
      <h2>${escapeHtml(category)}</h2>
      <div class="controls-inline">
        <select id="subFilter" class="small"></select>
        <button id="clearFilter" class="small">Clear</button>
      </div>
    </div>
    <div id="categoryProducts"></div>
  `;
  $('#catBack').onclick = ()=> renderCategoriesView();
  const items = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  $('#subFilter').innerHTML = `<option value="">All subthemes</option>` + subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  $('#subFilter').onchange = ()=> renderCategoryProducts(category, $('#subFilter').value);
  $('#clearFilter').onclick = ()=> { $('#subFilter').value=''; renderCategoryProducts(category); };
  renderCategoryProducts(category);
}
function renderCategoryProducts(category, subfilter){
  const cont = $('#categoryProducts');
  if(!cont) return;
  const search = ($('#search')? $('#search').value.trim().toLowerCase() : '');
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'')===subfilter);
  if(search) items = items.filter(p=> (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(search));
  if(items.length === 0){ cont.innerHTML = '<p class="hint">No items found.</p>'; return; }

  const grid = document.createElement('div'); grid.className = 'grid';
  items.forEach((p,i)=>{
    const img = Array.isArray(p.image) ? p.image[0] : p.image;
    const hard = p.hard_to_find ? `<div class="hard">Hard to find</div>` : '';
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="card-image" data-id="${p.id}">
        <img src="${img}" alt="${escapeHtml(p.title)}">
        ${hard}
      </div>
      <h3>${escapeHtml(p.title)}</h3>
      <div class="meta">${escapeHtml(p.origin||'')}</div>
      <div class="meta">${escapeHtml(p.condition||'')}</div>
      <div class="price">SAR ${p.price_sar ? p.price_sar : '-'}</div>
      <div class="contact">
        <button class="small add" data-id="${p.id}">‚ûï Add</button>
        <button class="btn view" data-id="${p.id}">View</button>
      </div>
    `;
    grid.appendChild(card);
    setTimeout(()=>card.classList.add('show'), 40*i);

    card.querySelector('.card-image').onclick = ()=> openDetail(p.id);
  });

  cont.innerHTML = ''; cont.appendChild(grid);
  attachCardEvents();
}

/* ---------- Events on cards ---------- */
function attachCardEvents(){
  $$('.view').forEach(b => b.onclick = e => openDetail(e.currentTarget.dataset.id));
  $$('.add').forEach(b => b.onclick = e => {
    const id = e.currentTarget.dataset.id;
    addToCart(id, e.currentTarget);
  });
}

/* ---------- Search ---------- */
function attachSearch(){
  const s = $('#search'); if(!s) return;
  s.addEventListener('input', ()=> {
    const header = document.querySelector('.category-header');
    if(header) {
      const cat = header.querySelector('h2').textContent;
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      renderCategoryProducts(cat, sub);
    } else {
      renderHome(); // keep home visible when searching from home - then filter to categories if needed
      const q = s.value.trim();
      if(!q) return;
      const results = products.filter(p => (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(q.toLowerCase()));
      if(results.length) {
        const resWrap = document.createElement('div'); resWrap.className = 'search-results';
        resWrap.innerHTML = `<h3 class="section-title">Quick results</h3><div class="grid"></div>`;
        results.forEach(p=> resWrap.querySelector('.grid').insertAdjacentHTML('beforeend', `
          <div class="card show">
            <div class="card-image"><img src="${Array.isArray(p.image)?p.image[0]:p.image}"></div>
            <h3>${escapeHtml(p.title)}</h3><div class="meta">${escapeHtml(p.category)}</div><div class="price">SAR ${p.price_sar}</div>
            <div class="contact"><button class="btn view" data-id="${p.id}">View</button></div>
          </div>`));
        mainArea.appendChild(resWrap);
        attachCardEvents();
      }
    }
  });
}

/* ---------- Modal / Detail ---------- */
function openDetail(id){
  const p = products.find(x => x.id === id);
  if(!p) return;
  const imgs = Array.isArray(p.image) ? p.image : [p.image];
  $('#modal').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>${escapeHtml(p.title)}</h2>
      <div><button id="closeModal" class="btn small">Close</button></div>
    </div>
    <div class="modal-grid">
      <div>
        <div class="gallery">
          <div class="gallery-main"><img id="galleryMain" src="${imgs[0]}" alt="${escapeHtml(p.title)}"></div>
          <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${u}" src="${u}" alt="thumb">`).join('')}</div>
        </div>

        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count? p.piece_count + ' pcs' : ''} ${p.figures_count? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="price">SAR ${p.price_sar ? p.price_sar : '-'}</div>

        <p class="desc">${escapeHtml(p.description || p.notes || '')}</p>

        <div style="margin-top:8px">
          <button class="btn" id="modalAdd">Add to cart</button>
          <button class="small" id="modalBuy">Buy now</button>
        </div>

        <div class="recommended">
          <h4>Recommended</h4>
          ${(p.recommended||[]).map(id=>{ const r = products.find(x=>x.id===id); return r ? `<div class="rec"><img src="${Array.isArray(r.image)?r.image[0]:r.image}"><div><strong>${escapeHtml(r.title)}</strong><div class="meta">SAR ${r.price_sar}</div></div></div>` : '' }).join('')}
        </div>
      </div>

      <aside>
        <div class="cart-mini">
          <h4>Quick cart</h4>
          <div id="quickCartList" class="cart-list"></div>
          <div class="order-summary" id="quickSummary"></div>
          <div style="margin-top:8px"><button class="btn" id="gotoCheckout">Go to checkout</button></div>
        </div>
      </aside>
    </div>
  `;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  $('#closeModal').onclick = closeModal;
  $('#modalAdd').onclick = ()=>{ addToCart(p.id); updateQuickCart(); }
  $('#modalBuy').onclick = ()=>{ addToCart(p.id); openCheckout(); }
  $('#gotoCheckout').onclick = openCheckout;

  $$('.gthumb').forEach(t=> t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); });
  updateQuickCart();
}
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=>$('#modalBackdrop').classList.remove('show'),200); }

/* ---------- Cart ---------- */
function loadCart(){ if(!userEmail) { cart = []; return; } cart = JSON.parse(localStorage.getItem('cart_' + userEmail) || '[]'); }
function saveCart(){ if(!userEmail) return; localStorage.setItem('cart_' + userEmail, JSON.stringify(cart)); }
function addToCart(id, triggerElt){
  if(!userEmail){ promptSignin('You must sign in to add items to your cart.'); return; }
  const p = products.find(x=>x.id===id); if(!p) return;
  const it = cart.find(i=>i.id===id);
  if(it) it.qty++; else cart.push({ id:p.id, title:p.title, price:p.price_sar||0, qty:1, image: Array.isArray(p.image)?p.image[0]:p.image });
  saveCart(); renderCartCount(); updateQuickCart();
  // animations
  const cartBtn = $('#cartBtn'); cartBtn.classList.add('bump'); setTimeout(()=>cartBtn.classList.remove('bump'), 360);
  if(triggerElt){ const card = triggerElt.closest('.card'); if(card){ card.classList.add('bump'); setTimeout(()=>card.classList.remove('bump'),360); } }
  showToast('Added to cart', 'success');
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }
function updateQuickCart(){
  const el = $('#quickCartList'), sumEl = $('#quickSummary'); if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>';
  const total = cart.reduce((s,i)=>s + i.price * i.qty, 0);
  sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}
$('#cartBtn').onclick = ()=> { if(!userEmail) promptSignin('You must sign in to view your cart and checkout.'); else openCheckout(); };

/* ---------- Checkout ---------- */
function openCheckout(){
  if(!userEmail){ promptSignin('You must sign in to checkout.'); return; }
  $('#modal').innerHTML = checkoutHtml(); $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  renderCheckoutCart(); $('#closeModal2').onclick = closeModal; $('#cashPay').onclick = handleCashPay;
}
function checkoutHtml(){ return `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Checkout</h2><div><button id="closeModal2" class="btn small">Close</button></div></div>
    <div style="display:flex;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:320px">
        <h4>Cart</h4><div id="checkoutCart"></div><div class="order-summary" id="checkoutSummary"></div>
      </div>
      <div style="width:340px">
        <h4>Complete Reservation</h4>
        <div class="checkout-forms">
          <input id="custDate" class="input" type="date" placeholder="Pickup date">
          <textarea id="custMsg" class="textarea" placeholder="Message / pickup instructions"></textarea>
          <button class="btn" id="cashPay" style="background:green">Reserve</button>
        </div>
      </div>
    </div>`; }
function renderCheckoutCart(){ const el = $('#checkoutCart'), sumEl = $('#checkoutSummary'); el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart empty</div>'; const total = cart.reduce((s,i)=>s+i.price*i.qty,0); sumEl.innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`; }
function handleCashPay(){
  const date = $('#custDate').value || ''; const msg = $('#custMsg').value || ''; const total = cart.reduce((s,i)=>s + i.price * i.qty, 0);
  if(total <= 0){ showToast('Cart is empty', 'warn'); return; }
  const order = { id:'order-'+Date.now(), email:userEmail, method:'cash', total, date, msg, items:cart.slice(), created:Date.now(), status:'new' };
  const all = JSON.parse(localStorage.getItem('orders_all') || '[]'); all.push(order); localStorage.setItem('orders_all', JSON.stringify(all));
  addPointsFor(userEmail, total);
  cart = []; saveCart(); renderCartCount(); closeModal(); showToast('Reservation saved. Order ID: ' + order.id, 'success');
}

/* ---------- Sign-in ---------- */
$('#signupBtn').onclick = ()=> openSignin();
function openSignin(){ $('#signinBackdrop').classList.add('show'); setTimeout(()=>$('#signinModal').classList.add('show'),10); $('#inputEmail').focus(); }
$('#btnCloseSignin').onclick = ()=> closeSignin();
function closeSignin(){ $('#signinModal').classList.remove('show'); setTimeout(()=>$('#signinBackdrop').classList.remove('show'),200); }
$('#btnSaveEmail').onclick = ()=> {
  const em = $('#inputEmail').value.trim().toLowerCase();
  if(!em || !em.includes('@')){ showToast('Enter a valid email', 'warn'); return; }
  userEmail = em; localStorage.setItem('nm_user_email', userEmail); loadCart(); renderCartCount(); closeSignin(); showToast('Signed in as ' + userEmail, 'success');
};
function promptSignin(msg){ $('#signinBackdrop').classList.add('show'); setTimeout(()=>$('#signinModal').classList.add('show'),10); if(msg) showToast(msg, 'warn'); }
if(userEmail) loadCart();

/* ---------- Chat / requests ---------- */
function loadChat(){ const msgs = JSON.parse(localStorage.getItem('requests') || '[]'); if(!document.querySelector('#chatFloating')) return;
  $('#miniSend').onclick = ()=> { const text = $('#miniReq').value.trim(); if(!text) return; const m = {from:'user', text, time:Date.now()}; const existing = JSON.parse(localStorage.getItem('requests')||'[]'); existing.push(m); localStorage.setItem('requests', JSON.stringify(existing)); $('#miniReq').value=''; setTimeout(()=> { const reply = {from:'owner', text:'Thanks ‚Äî we noted: ' + text, time:Date.now()}; const e2 = JSON.parse(localStorage.getItem('requests')||'[]'); e2.push(reply); localStorage.setItem('requests', JSON.stringify(e2)); renderMiniChat(); }, 700); renderMiniChat(); };
  $('#minimizeChat').onclick = ()=> { const body = $('#chatBody'); if(body.style.display === 'none'){ body.style.display = ''; $('#minimizeChat').innerText = '‚Äî'; } else { body.style.display = 'none'; $('#minimizeChat').innerText = '+'; } };
  renderMiniChat(); }
function renderMiniChat(){ const mini = $('#miniChat'); const all = JSON.parse(localStorage.getItem('requests')||'[]'); mini.innerHTML = all.map(m=>`<div class="msg ${m.from==='user'?'user':'owner'}">${escapeHtml(m.text)}</div>`).join('') || '<div class="meta">No requests yet.</div>'; }
loadChat();

/* ---------- Rewards / misc views ---------- */
function addPointsFor(email, amountSAR){ const add = +(amountSAR * 0.5).toFixed(2); const key = 'points_' + email; const cur = Number(localStorage.getItem(key) || 0); localStorage.setItem(key, (cur + add).toFixed(2)); }
function getPoints(email){ return Number(localStorage.getItem('points_' + email) || 0); }
function renderRewardsView(){ const points = getPoints(userEmail || '') || 0; mainArea.innerHTML = `<div class="rewards-header"><h2>Rewards & Milestones</h2><div class="meta">You earn 0.5 points per SAR spent. Sign in to collect and redeem.</div></div><div class="timeline"><div class="timeline-item"><div class="t-left">100 points</div><div class="t-right">Dragon Rising blind bag</div></div><div class="timeline-item"><div class="t-left">250 points</div><div class="t-right">Blind bag of your choice</div></div><div class="timeline-item"><div class="t-left">500 points</div><div class="t-right">30070 polybag</div></div></div><div style="margin-top:18px"><div class="meta">Your points: <strong>${points}</strong></div></div>`; }
function renderRequestsView(){ const all = JSON.parse(localStorage.getItem('requests')||'[]'); mainArea.innerHTML = `<h2>Requests</h2><div class="requests-list">${all.map(r=>`<div class="req-item"><div class="msg ${r.from==='user'?'user':'owner'}">${escapeHtml(r.text)}</div></div>`).join('') || '<div class="meta">No requests yet.</div>'}</div>`; }
function renderFeedbackView(){ mainArea.innerHTML = `<h2>Feedback</h2><div class="meta">Feedback form coming soon.</div>`; }

/* ---------- Game view (coming soon) ---------- */
function renderGameView(){
  mainArea.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;min-height:50vh"><div style="text-align:center"><h2>Game ‚Äî Coming Soon</h2><p class="meta">We're building this ‚Äî check back later. Follow repo for updates.</p></div></div>`;
}

/* ---------- Keyboard close modal ---------- */
document.addEventListener('keydown', e=> { if(e.key === 'Escape'){ closeModal(); closeSignin(); } });

</script>
</body>
</html>
