<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Market ‚Äî Marketplace</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">Ninjago Market</div>
      <div class="subtitle">Collect ‚Ä¢ Request ‚Ä¢ Reserve</div>
    </div>
    <div class="controls">
      <div class="left-controls">
        <input id="search" class="search" placeholder="Search sets, figures, books...">
        <button id="themeToggle" class="btn small" title="Toggle theme">üåô</button>
      </div>
      <div class="right-controls">
        <div class="points">Points: <span id="points">0</span></div>
        <button id="signupBtn" class="btn">Sign up / Login</button>
        <button id="cartBtn" class="btn cart">üõí <span id="cartCount">0</span></button>
        <a class="btn small" href="admin.html" target="_blank" rel="noopener noreferrer">Admin</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Welcome to Ninjago Market</h1>
      <p class="hero-sub">Authentic sets, minifigures, blind bags, polybags and more. Reserve with cash or use giftcards.</p>
      <div class="hero-actions">
        <button id="enterShop" class="btn big">Enter Shop</button>
        <button id="ctaSignup" class="btn outline">Create account</button>
      </div>
    </section>

    <section id="mainArea" class="main-area"></section>
  </main>

  <!-- Modal backdrop -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

  <!-- Floating request/chat (minimizable) -->
  <div id="requestFloat" class="chat-floating">
    <div class="chat-head">
      Request product üí¨
      <button id="minimizeChat" class="small">‚Äî</button>
    </div>
    <div id="chatBody" class="chat-body">
      <div id="miniChat" class="chat"></div>
      <div class="chat-controls">
        <input id="miniReq" class="input" placeholder="Request a set, figure, box...">
        <button id="miniSend" class="btn small">Send</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Helpers & state ---------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
let products = [];
let cart = []; // will be loaded per-user
let currentUser = localStorage.getItem('nm_user_email') || null;
let points = Number(localStorage.getItem('nm_points_'+(currentUser||'guest'))||0);

/* ---------- Load products.json ---------- */
async function loadProducts(){
  try {
    const res = await fetch('products.json');
    products = await res.json();
  } catch(e){
    $('#mainArea').innerHTML = '<p class="hint error">Failed to load products.json ‚Äî check file.</p>';
    console.error(e);
    return;
  }
  initUI();
}

/* ---------- Theme ---------- */
function initTheme(){
  const cur = localStorage.getItem('nm_theme') || 'dark';
  document.documentElement.setAttribute('data-theme', cur);
  $('#themeToggle').textContent = cur === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  $('#themeToggle').onclick = () => {
    const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('nm_theme', t);
    $('#themeToggle').textContent = t === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  };
}

/* ---------- UI boot ---------- */
function initUI(){
  initTheme();
  renderCategoriesView();
  renderHeader();
  attachSearch();
  initRequestChat();
  loadUserSession();
  $('#enterShop').onclick = ()=> window.scrollTo({top: document.querySelector('.categories-grid').offsetTop - 20, behavior:'smooth'});
  $('#ctaSignup').onclick = () => openAuthModal();
  $('#signupBtn').onclick = () => openAuthModal();
  $('#cartBtn').onclick = () => openCheckout();
  $('#points').textContent = points;
}

/* ---------- Header/cart ---------- */
function loadUserSession(){
  if(currentUser){
    // per-user cart stored as nm_cart_<email>
    try { cart = JSON.parse(localStorage.getItem('nm_cart_'+currentUser)||'[]'); } catch(e){ cart = []; }
  } else {
    cart = JSON.parse(localStorage.getItem('nm_cart_guest')||'[]');
  }
  renderCartCount();
}
function saveCart(){
  if(currentUser) localStorage.setItem('nm_cart_'+currentUser, JSON.stringify(cart));
  else localStorage.setItem('nm_cart_guest', JSON.stringify(cart));
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }

/* ---------- Categories view ---------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function iconFor(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Polybags':'üõçÔ∏è','Miscs':'‚ú®','Books':'üìö','Books (Rent)':'üìñ'};
  return map[cat] || 'üì¶';
}
function renderCategoriesView(){
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className = 'categories-grid';
  cats.forEach((cat,i)=>{
    const btn = document.createElement('button'); btn.className='category-tile';
    btn.innerHTML = `<div class="cat-emoji">${iconFor(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${products.filter(p=>p.category===cat).length} items</div>`;
    wrap.appendChild(btn);
    setTimeout(()=> btn.classList.add('show'), 60*i);
    btn.onclick = ()=> renderCategoryPage(cat);
  });
  $('#mainArea').innerHTML = '';
  $('#mainArea').appendChild(wrap);
}

/* ---------- Category page ---------- */
function renderCategoryPage(category){
  const items = products.filter(p=>p.category === category);
  const uniqueSubs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  const header = document.createElement('div'); header.className='category-header';
  header.innerHTML = `<button id="catBack" class="btn small">‚Üê Back</button><h2>${escapeHtml(category)}</h2>
    <div class="controls-inline"><select id="subFilter" class="small"></select><button id="clearFilter" class="small">Clear</button></div>`;
  $('#mainArea').innerHTML = ''; $('#mainArea').appendChild(header);
  $('#catBack').onclick = renderCategoriesView;
  const sel = $('#subFilter');
  sel.innerHTML = `<option value="">All subthemes</option>` + uniqueSubs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  sel.onchange = ()=> renderCategoryProducts(category, sel.value);
  $('#clearFilter').onclick = ()=> { sel.value=''; renderCategoryProducts(category); };
  renderCategoryProducts(category);
}
function renderCategoryProducts(category, subfilter){
  const cont = document.createElement('div'); cont.id = 'categoryProducts';
  const search = ($('#search')?$('#search').value.trim().toLowerCase():'');
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'') === subfilter);
  if(search) items = items.filter(p => (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(search));
  if(items.length === 0) { cont.innerHTML = '<p class="hint">No items found.</p>'; $('#mainArea').appendChild(cont); return; }

  const grid = document.createElement('div'); grid.className='grid';
  items.forEach((p,i)=>{
    const card = document.createElement('div'); card.className='card';
    const thumb = Array.isArray(p.image)? p.image[0] : p.image;
    const hard = p.hard_to_find ? '<span class="hard">Hard to find</span>' : '';
    card.innerHTML = `<div class="card-image" data-id="${p.id}"><img loading="lazy" src="${thumb}" alt="${escapeHtml(p.title)}"></div>
      <div class="card-body"><h3>${escapeHtml(p.title)}</h3><div class="meta">${escapeHtml(p.origin||'')}</div><div class="meta">${escapeHtml(p.condition || '')}</div><div class="price">SAR ${p.price_sar}${hard}</div>
      <div class="card-actions"><button class="btn view" data-id="${p.id}">View</button><button class="small add" data-id="${p.id}">‚ûï</button></div></div>`;
    grid.appendChild(card);
    setTimeout(()=> card.classList.add('show'), 40*i);
  });
  cont.appendChild(grid);
  $('#mainArea').appendChild(cont);

  // click image to open detail
  $$('.card-image').forEach(el => el.onclick = (e) => openDetail(el.dataset.id));
  attachCardEvents();
}

/* ---------- Search ---------- */
function attachSearch(){
  const s = $('#search');
  if(!s) return;
  s.addEventListener('input', ()=> {
    const catHeader = document.querySelector('.category-header');
    if(catHeader){
      const cat = catHeader.querySelector('h2').textContent;
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      renderCategoryProducts(cat, sub);
    } else renderCategoriesView();
  });
}

/* ---------- Card events ---------- */
function attachCardEvents(){
  $$('.view').forEach(b=> b.onclick = ()=> openDetail(b.dataset.id));
  $$('.add').forEach(b=> b.onclick = ()=> addToCart(b.dataset.id));
}

/* ---------- Detail modal & gallery ---------- */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image)? p.image : [p.image];
  $('#modal').innerHTML = `
    <div class="modal-header"><h2>${escapeHtml(p.title)}</h2><button id="closeModal" class="btn small">Close</button></div>
    <div class="modal-grid">
      <div class="mg-left">
        <div class="gallery">
          <img id="galleryMain" class="gallery-main-img" src="${imgs[0]}" alt="${escapeHtml(p.title)}" onerror="this.src='images/placeholder.jpg'">
          <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${u}" src="${u}">`).join('')}</div>
        </div>
        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count? p.piece_count + ' pcs' : ''} ${p.figures_count? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="notes">${escapeHtml(p.notes||'')}</div>
      </div>
      <aside class="mg-right">
        <div class="price-block"><div class="price">SAR ${p.price_sar}</div>
          ${p.hard_to_find ? '<div class="hint small">Hard to find</div>' : ''}
        </div>
        <div class="detail-actions">
          <button class="btn green" id="buyCash">Reserve ‚Äî Cash</button>
          <button class="btn blue" id="buyGift">Pay with Giftcard</button>
        </div>
        <div class="recommend">
          <h4>Recommended</h4>
          ${ (p.recommended||[]).map(id=>{ const r=products.find(x=>x.id===id); return r ? `<div class="rec"><img src="${Array.isArray(r.image)?r.image[0]:r.image}"><div>${escapeHtml(r.title)}<div class="meta">SAR ${r.price_sar}</div></div></div>` : '' }).join('') }
        </div>
      </aside>
    </div>
  `;
  document.getElementById('modalBackdrop').classList.add('show');
  setTimeout(()=> $('#modal').classList.add('show'), 10);
  $('#closeModal').onclick = closeModal;
  $$('.gthumb').forEach(t => t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); });
  $('#buyCash').onclick = () => {
    if(!currentUser) { popupSignInRequired(); return; }
    addToCart(id); openCheckout('cash');
  };
  $('#buyGift').onclick = () => {
    if(!currentUser) { popupSignInRequired(); return; }
    addToCart(id); openCheckout('gift');
  };
}
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=> document.getElementById('modalBackdrop').classList.remove('show'),180); }

/* ---------- Cart ---------- */
function addToCart(id){
  if(!currentUser) { popupSignInRequired(); return; }
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const existing = cart.find(c=>c.id===id);
  if(existing) existing.qty++;
  else cart.push({id:p.id, title:p.title, price:p.price_sar, qty:1, image: Array.isArray(p.image)?p.image[0]:p.image});
  saveCart(); renderCartCount();
}

/* ---------- Checkout UI (split flows) ---------- */
function openCheckout(prefer){
  // Build checkout modal (separate cash and gift flows)
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  $('#modal').innerHTML = `
    <div class="modal-header"><h2>Checkout</h2><button id="closeModal2" class="btn small">Close</button></div>
    <div class="checkout-grid">
      <div class="checkout-left">
        <h4>Cart</h4>
        <div id="checkoutCart">${cart.map(it=>`<div class="checkout-item"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart is empty</div>'}</div>
        <div class="order-summary">Total: SAR ${total.toFixed(2)}</div>
      </div>
      <div class="checkout-right">
        <div class="pay-block">
          <h4>Pay with Cash (Reserve)</h4>
          <div class="field"><input id="custDate" type="date" class="input"><input id="custMsg" placeholder="Pickup notes (optional)" class="input"></div>
          <button id="cashPay" class="btn green big">Reserve with cash</button>
        </div>
        <div class="pay-block">
          <h4>Pay with Giftcard</h4>
          <input id="giftCode" class="input" placeholder="Giftcard code">
          <input id="giftAmount" class="input" placeholder="Amount (SAR)" type="number" min="0" step="0.01">
          <button id="giftPay" class="btn blue big">Pay with giftcard</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('modalBackdrop').classList.add('show');
  setTimeout(()=> $('#modal').classList.add('show'), 10);
  $('#closeModal2').onclick = closeModal;
  $('#cashPay').onclick = handleCashPay;
  $('#giftPay').onclick = handleGiftPay;
  if(prefer === 'cash') { /* focus cash */ }
  if(prefer === 'gift') { /* focus gift */ }
}

/* separate handlers */
function handleCashPay(){
  if(!currentUser) { popupSignInRequired(); return; }
  const date = $('#custDate').value;
  const notes = $('#custMsg').value;
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const order = { id:'order-'+Date.now(), email: currentUser, cart, total, method:'cash', date, notes, created: Date.now() };
  saveOrderLocal(order);
  // reward points
  addPoints(Math.floor(total));
  alert('Cash reservation saved ‚Äî Order ID: ' + order.id);
  cart = []; saveCart(); renderCartCount(); closeModal();
}
function handleGiftPay(){
  if(!currentUser) { popupSignInRequired(); return; }
  const code = $('#giftCode').value.trim() || ('GC-'+Math.floor(Math.random()*999999));
  const amount = Number($('#giftAmount').value) || 0;
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const order = { id:'order-'+Date.now(), email: currentUser, cart, total, method:'giftcard', code, paid:amount, created: Date.now() };
  // Note: we store the order locally. If you add server APIs later we will call them.
  saveOrderLocal(order);
  if(amount >= total) addPoints(Math.floor(total));
  else addPoints(Math.floor(amount));
  alert('Giftcard payment recorded locally ‚Äî Order ID: ' + order.id);
  cart = []; saveCart(); renderCartCount(); closeModal();
}

/* save order to localStorage list */
function saveOrderLocal(order){
  const arr = JSON.parse(localStorage.getItem('nm_orders')||'[]');
  arr.push(order);
  localStorage.setItem('nm_orders', JSON.stringify(arr));
}

/* ---------- Simple points stored by email ---------- */
function addPoints(n){
  if(!currentUser) return;
  points = Number(localStorage.getItem('nm_points_'+currentUser) || 0);
  points += n;
  localStorage.setItem('nm_points_'+currentUser, points);
  $('#points').textContent = points;
}

/* ---------- Auth (email only) ---------- */
function openAuthModal(){
  $('#modal').innerHTML = `
    <div class="modal-header"><h2>Sign up / Login</h2><button id="closeAuth" class="btn small">Close</button></div>
    <div class="auth">
      <p>Enter your email to sign in. We only store your email to manage orders and credits.</p>
      <input id="authEmail" class="input" placeholder="email@example.com" type="email">
      <div style="display:flex;gap:8px;margin-top:8px"><button id="doAuth" class="btn big">Sign in</button><button id="guestAuth" class="small">Continue as guest</button></div>
    </div>
  `;
  document.getElementById('modalBackdrop').classList.add('show');
  setTimeout(()=> $('#modal').classList.add('show'), 10);
  $('#closeAuth').onclick = closeModal;
  $('#doAuth').onclick = () => {
    const e = $('#authEmail').value.trim().toLowerCase();
    if(!e || !e.includes('@')) { alert('Enter a valid email'); return; }
    currentUser = e;
    localStorage.setItem('nm_user_email', currentUser);
    points = Number(localStorage.getItem('nm_points_'+currentUser) || 0);
    $('#points').textContent = points;
    loadUserSession();
    closeModal();
    alert('Signed in as ' + currentUser);
  };
  $('#guestAuth').onclick = () => {
    currentUser = null;
    localStorage.removeItem('nm_user_email');
    loadUserSession();
    closeModal();
  };
}

/* popup for sign-in required */
function popupSignInRequired(){
  $('#modal').innerHTML = `<div class="modal-header"><h2>Sign in required</h2></div>
    <div style="padding:12px"><p>You must sign in to place an order. Signing in keeps your orders & points safe.</p>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="goSign" class="btn">Sign in</button><button id="closePop" class="small">Close</button></div></div>`;
  document.getElementById('modalBackdrop').classList.add('show');
  setTimeout(()=> $('#modal').classList.add('show'), 10);
  $('#goSign').onclick = () => { closeModal(); openAuthModal(); };
  $('#closePop').onclick = closeModal;
}

/* ---------- Request chat (minimizable) ---------- */
function initRequestChat(){
  const minBtn = $('#minimizeChat');
  const chatBody = $('#chatBody');
  let minimized = false;
  minBtn.onclick = () => {
    minimized = !minimized;
    chatBody.style.display = minimized ? 'none' : 'block';
    minBtn.textContent = minimized ? '+' : '‚Äî';
  };
  $('#miniSend').onclick = ()=> {
    const text = $('#miniReq').value.trim();
    if(!text) return;
    const arr = JSON.parse(localStorage.getItem('nm_requests')||'[]');
    arr.push({id:'req-'+Date.now(), text, from: currentUser || 'guest', time: Date.now()});
    localStorage.setItem('nm_requests', JSON.stringify(arr));
    $('#miniReq').value = '';
    loadMiniChat();
    // auto owner reply (simulate)
    setTimeout(()=> {
      const arr2 = JSON.parse(localStorage.getItem('nm_requests')||'[]');
      arr2.push({id:'req-'+Date.now(), text: 'Thanks ‚Äî noted: ' + text, from: 'owner', time: Date.now()});
      localStorage.setItem('nm_requests', JSON.stringify(arr2));
      loadMiniChat();
    }, 800);
  };
  loadMiniChat();
}
function loadMiniChat(){
  const list = JSON.parse(localStorage.getItem('nm_requests')||'[]').slice(-20);
  $('#miniChat').innerHTML = list.map(m => `<div class="msg ${m.from==='owner' ? 'owner' : 'user'}">${escapeHtml(m.text)}</div>`).join('') || '<div class="meta">No requests yet</div>';
}

/* ---------- Admin helper (only client-side) ---------- */
function adminRequirePassword(pass){
  // only used on admin.html page; included here for completeness if needed.
  return pass === 'M.O.D8643';
}

/* ---------- Init load ---------- */
loadProducts();

</script>
</body>
</html>
