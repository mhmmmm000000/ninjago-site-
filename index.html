<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Market ‚Äî Collector Sets & Minifigs</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<header class="site-header">
  <div class="brand">
    <div class="logo">Ninjago Market</div>
    <div class="tag">Collector-grade sets, figures & more</div>
  </div>

  <div class="header-right">
    <div class="search-wrap">
      <input id="search" class="search" placeholder="Search sets, figures, books...">
    </div>
    <button id="themeToggle" class="btn small">üåô</button>
    <button id="cartBtn" class="btn cart">üõí <span id="cartCount">0</span></button>
    <a href="admin.html" class="btn small admin-link" target="_blank" rel="noopener noreferrer">Admin</a>
  </div>
</header>

<main class="container">
  <section class="hero">
    <div class="hero-left">
      <h1>Official & collector Ninjago sets, figures, blind bags and books</h1>
      <p class="muted">Curated picks, condition notes, rent options for books, subscriptions and secure giftcards (server-backed optional).</p>
      <div class="hero-cta">
        <button class="btn" id="browseSetsBtn">Browse sets</button>
        <button class="btn small" id="subscribeBtn">Subscribe ‚Äî save</button>
      </div>
    </div>
    <div class="hero-right">
      <div class="hero-card">
        <h3>Ninjago</h3>
        <p class="muted">Collector selection</p>
      </div>
    </div>
  </section>

  <nav class="category-nav" id="categoryNav"></nav>

  <section id="mainArea" class="main-area">
    <!-- categories view / category content will be injected here -->
  </section>
</main>

<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
</div>

<!-- floating request widget -->
<div id="floatingRequestContainer"></div>

<script>
/* ---------- helpers ---------- */
const $ = q=> document.querySelector(q);
const $$ = q=> Array.from(document.querySelectorAll(q));
function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- state ---------- */
let products = [];
let cart = JSON.parse(localStorage.getItem('cart')||'[]');
let credits = Number(localStorage.getItem('storeCredit')||0);

/* ---------- load products.json ---------- */
async function load(){
  try{
    const res = await fetch('products.json');
    products = await res.json();
  } catch(e){
    $('#mainArea').innerHTML = '<p class="hint" style="color:salmon">Failed to load products.json ‚Äî check file.</p>';
    console.error(e); return;
  }
  buildCategoryNav();
  renderCategoriesView();
  attachSearch();
  attachUI();
  renderCartCount();
  initFloatingRequest();
}

/* ---------- theme toggle ---------- */
function attachUI(){
  const tgl = $('#themeToggle');
  const cur = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', cur);
  tgl.textContent = cur === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  tgl.onclick = ()=> {
    const now = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', now);
    localStorage.setItem('theme', now);
    tgl.textContent = now === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  };
  $('#browseSetsBtn').onclick = ()=> renderCategoryPage('Sets');
  $('#subscribeBtn').onclick = ()=> openSubscribe();
  $('#cartBtn').onclick = ()=> openCheckout();
}

/* ---------- categories nav ---------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))); }
function buildCategoryNav(){
  const nav = $('#categoryNav'); nav.innerHTML = '';
  getCategories().forEach(cat=>{
    const b = document.createElement('button'); b.className='nav-pill';
    b.innerHTML = `<span>${esc(cat)}</span>`;
    b.onclick = ()=> renderCategoryPage(cat);
    nav.appendChild(b);
  });
}

/* ---------- categories view ---------- */
function renderCategoriesView(){
  const main = $('#mainArea'); main.innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className='categories-grid';
  cats.forEach((cat,i)=>{
    const count = products.filter(p=>p.category===cat).length;
    const tile = document.createElement('div'); tile.className='category-card';
    tile.innerHTML = `<div class="cat-title">${esc(cat)}</div><div class="cat-count">${count} items</div>`;
    tile.onclick = ()=> renderCategoryPage(cat);
    wrap.appendChild(tile);
    setTimeout(()=> tile.classList.add('enter'), 80*i);
  });
  main.appendChild(wrap);
}

/* ---------- category page ---------- */
function renderCategoryPage(category){
  const main = $('#mainArea'); main.innerHTML = `
    <div class="category-header">
      <button id="backBtn" class="btn small">‚Üê Back</button>
      <h2>${esc(category)}</h2>
      <div class="category-controls">
        <select id="subFilter" class="small"></select>
        <select id="sortBy" class="small"><option value="popular">Popular</option><option value="price-asc">Price ‚Üë</option><option value="price-desc">Price ‚Üì</option></select>
      </div>
    </div>
    <div id="categoryProducts"></div>
  `;
  $('#backBtn').onclick = ()=> renderCategoriesView();
  // populate subthemes
  const items = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(items.map(x=>x.subtheme||'Misc')));
  $('#subFilter').innerHTML = '<option value="">All subthemes</option>' + subs.map(s=>`<option>${esc(s)}</option>`).join('');
  $('#subFilter').onchange = ()=> renderCategoryProducts(category, $('#subFilter').value);
  $('#sortBy').onchange = ()=> renderCategoryProducts(category, $('#subFilter').value);
  renderCategoryProducts(category);
}
function renderCategoryProducts(category, subfilter){
  const cont = $('#categoryProducts');
  const search = ($('#search')?$('#search').value.trim().toLowerCase():'');
  let items = products.filter(p=>p.category === category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'') === subfilter);
  if(search) items = items.filter(p => (p.title + p.origin + (p.subtheme||'')).toLowerCase().includes(search));
  // sort
  const sort = $('#sortBy') ? $('#sortBy').value : 'popular';
  if(sort === 'price-asc') items.sort((a,b)=> (a.price_sar||0)-(b.price_sar||0));
  if(sort === 'price-desc') items.sort((a,b)=> (b.price_sar||0)-(a.price_sar||0));
  cont.innerHTML = '';
  if(items.length === 0){
    cont.innerHTML = '<p class="hint">No items found in this category.</p>'; return;
  }
  const grid = document.createElement('div'); grid.className='grid grid-large';
  items.forEach((p,i)=>{
    const img = Array.isArray(p.image) ? p.image[0] : p.image;
    const card = document.createElement('article'); card.className='product-card';
    card.innerHTML = `
      <div class="img-wrap"><img loading="lazy" src="${esc(img)}" alt="${esc(p.title)}" onerror="this.src='images/placeholder.jpg'"></div>
      <div class="prod-body">
        <h3>${esc(p.title)}</h3>
        <div class="meta">${esc(p.origin || '')}</div>
        <div class="meta small">${esc(p.condition || '')}</div>
        <div class="price-row">
          <div class="price">SAR ${p.price_sar}</div>
          <div class="actions">
            <button class="btn view" data-id="${p.id}">View</button>
            <button class="small add" data-id="${p.id}">Add</button>
          </div>
        </div>
      </div>
    `;
    grid.appendChild(card);
    setTimeout(()=> card.classList.add('enter'), 50*i);
  });
  cont.appendChild(grid);
  attachCardEvents();
}

/* ---------- card events ---------- */
function attachCardEvents(){
  $$('.view').forEach(b=> b.onclick = ()=> openDetail(b.dataset.id));
  $$('.add').forEach(b=> b.onclick = ()=> addToCart(b.dataset.id));
}

/* ---------- product modal ---------- */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image)? p.image : [p.image];
  $('#modal').innerHTML = `
    <div class="modal-header"><h2>${esc(p.title)}</h2><button id="closeModal" class="btn small">Close</button></div>
    <div class="modal-grid">
      <div class="modal-left">
        <div class="gallery-main"><img id="galleryMain" src="${esc(imgs[0])}" onerror="this.src='images/placeholder.jpg'"></div>
        <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${esc(u)}" src="${esc(u)}" onerror="this.src='images/placeholder.jpg'">`).join('')}</div>
        <p class="muted">${esc(p.notes||'')}</p>
      </div>
      <aside class="modal-right">
        <div class="meta">Origin: ${esc(p.origin||'')}</div>
        <div class="meta">Condition: ${esc(p.condition||'')}</div>
        <div class="meta">${p.piece_count ? p.piece_count + ' pcs' : ''} ${p.figures_count? ' ‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="price">SAR ${p.price_sar}</div>
        <div style="margin-top:12px"><button id="modalAdd" class="btn">Add to cart</button> <button id="modalBuy" class="btn small">Buy now</button></div>
        <div class="price-compare"></div>
        <div class="recommended"><h4>Recommended</h4><div id="recList"></div></div>
      </aside>
    </div>
  `;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=> $('#modal').classList.add('show'), 10);
  $('#closeModal').onclick = ()=> closeModal();
  $('#modalAdd').onclick = ()=> { addToCart(p.id); updateQuickCart(); };
  $('#modalBuy').onclick = ()=> { addToCart(p.id); openCheckout(); };

  $$('.gthumb').forEach(t=> t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); });

  // recommended
  const rec = (p.recommended||[]).map(id=> products.find(r=>r.id===id)).filter(Boolean);
  $('#recList').innerHTML = rec.map(r=>`<div class="rec-item"><img src="${esc(Array.isArray(r.image)?r.image[0]:r.image)}" onerror="this.src='images/placeholder.jpg'"><div><strong>${esc(r.title)}</strong><div class="meta">SAR ${r.price_sar}</div></div></div>`).join('');
}

/* ---------- modal close ---------- */
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=> $('#modalBackdrop').classList.remove('show'), 250); }

/* ---------- cart ---------- */
function addToCart(id){
  const p = products.find(x=>x.id===id); if(!p) return;
  const it = cart.find(c=>c.id===id);
  if(it) it.qty++; else cart.push({id:p.id,title:p.title,price:p.price_sar,qty:1,image:Array.isArray(p.image)?p.image[0]:p.image});
  localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); updateQuickCart();
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }
function updateQuickCart(){
  const el = document.getElementById('quickCartList'); if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="mini-row"><img src="${esc(it.image)}" onerror="this.src='images/placeholder.jpg'"><div><strong>${esc(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart empty</div>';
}

/* ---------- checkout ---------- */
function openCheckout(){ 
  $('#modal').innerHTML = checkoutHtml(); $('#modalBackdrop').classList.add('show'); setTimeout(()=> $('#modal').classList.add('show'), 10);
  $('#closeModal2').onclick = ()=> closeModal();
  $('#cashPay').onclick = handleCashPay;
  $('#giftPay').onclick = handleGiftPay;
  renderCheckoutCart();
}
function checkoutHtml(){
  return `<div class="modal-header"><h2>Checkout</h2><button id="closeModal2" class="btn small">Close</button></div>
  <div class="checkout-grid">
    <div><h4>Cart</h4><div id="checkoutCart"></div><div class="order-summary" id="checkoutSummary"></div></div>
    <aside>
      <h4>Reserve (Cash)</h4>
      <input id="custName" class="input" placeholder="Full name">
      <input id="custEmail" class="input" placeholder="Email (optional)">
      <input id="custDate" class="input" type="date">
      <textarea id="custMsg" class="textarea" placeholder="Pickup notes"></textarea>
      <button id="cashPay" class="btn">Reserve with cash</button>

      <h4 style="margin-top:12px">Giftcard</h4>
      <input id="giftCode" class="input" placeholder="Giftcard code">
      <input id="giftAmount" class="input" placeholder="Amount to use (SAR)" type="number" min="0" step="0.01">
      <button id="giftPay" class="btn">Pay with giftcard</button>
      <div class="hint">If you overpay and provide an email, extra becomes in-store credit.</div>
    </aside>
  </div>`;
}
function renderCheckoutCart(){
  $('#checkoutCart').innerHTML = cart.map(it=>`<div class="mini-row"><img src="${esc(it.image)}"><div><strong>${esc(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart empty</div>';
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  $('#checkoutSummary').innerHTML = `<div>Total: SAR ${total.toFixed(2)}</div>`;
}
function handleCashPay(){
  const name = $('#custName').value.trim(); if(!name){ alert('Enter name'); return; }
  const date = $('#custDate').value; const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const order = {id:'order-'+Date.now(),name,date,email:$('#custEmail').value,cart,total,method:'cash',msg:$('#custMsg').value,created:Date.now()};
  // fallback local storage persistence
  const list = JSON.parse(localStorage.getItem('orders')||'[]'); list.push(order); localStorage.setItem('orders', JSON.stringify(list));
  alert('Reserved ‚Äî Order ID: '+order.id);
  cart = []; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategoryView();
}
function handleGiftPay(){
  const code = $('#giftCode').value.trim() || ('GC-'+Math.floor(Math.random()*99999));
  const amount = Number($('#giftAmount').value) || 0;
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  if(amount < total){
    const remaining = (total - amount).toFixed(2);
    const o = {id:'order-'+Date.now(), total, paid:amount, method:'giftcard', code, remaining, created:Date.now()};
    const list = JSON.parse(localStorage.getItem('orders')||'[]'); list.push(o); localStorage.setItem('orders', JSON.stringify(list));
    alert('Partial paid. Remaining: SAR '+remaining);
  } else {
    const credit = +(amount - total);
    credits = +(credits + credit).toFixed(2); localStorage.setItem('storeCredit', credits);
    const o = {id:'order-'+Date.now(), total, paid:amount, method:'giftcard', code, creditGained:credit, created:Date.now()};
    const list = JSON.parse(localStorage.getItem('orders')||'[]'); list.push(o); localStorage.setItem('orders', JSON.stringify(list));
    alert('Payment complete. In-store credit added: SAR '+credit.toFixed(2));
  }
  cart = []; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); renderCategoryView();
}

/* ---------- search ---------- */
function attachSearch(){
  const s = $('#search'); if(!s) return;
  s.addEventListener('input', ()=>{
    const header = document.querySelector('.category-header');
    if(header){
      const cat = header.querySelector('h2').textContent;
      renderCategoryProducts(cat, $('#subFilter') ? $('#subFilter').value : '');
    } else {
      renderCategoriesView();
      const q = s.value.trim();
      if(!q) return;
      const results = products.filter(p=> (p.title + p.origin + (p.subtheme||'')).toLowerCase().includes(q.toLowerCase()));
      const wrap = document.createElement('div'); wrap.className='grid grid-large';
      results.forEach(p=>{
        const img = Array.isArray(p.image)? p.image[0] : p.image;
        const el = document.createElement('div'); el.className='product-card entry';
        el.innerHTML = `<div class="img-wrap"><img src="${esc(img)}" onerror="this.src='images/placeholder.jpg'"></div><div><h3>${esc(p.title)}</h3><div class="meta">${esc(p.category)}</div><div class="price">SAR ${p.price_sar}</div><div><button class="btn view" data-id="${p.id}">View</button></div></div>`;
        wrap.appendChild(el);
      });
      $('#mainArea').appendChild(wrap);
      attachCardEvents();
    }
  });
}

/* ---------- subscribe popup (simple) ---------- */
function openSubscribe(){
  const percent = 100 - Math.round((15 / 32) * 100);
  $('#modal').innerHTML = `<div class="modal-header"><h2>Subscription</h2><button id="closeModal" class="btn small">Close</button></div>
  <div style="padding:12px">
    <p>Get a subscription for <strong>SAR 15</strong> (was SAR 32 ‚Äî save ${percent}%!). Includes one random Ninjago set pick and early leak folder (official links only). Monthly auto-renew when you enable server payments.</p>
    <div><button id="subBuy" class="btn">Subscribe ‚Äî SAR 15</button></div>
  </div>`;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  $('#closeModal').onclick = closeModal;
  $('#subBuy').onclick = ()=> { alert('Subscription registered locally (demo).'); closeModal(); };
}

/* ---------- floating request chat ---------- */
function initFloatingRequest(){
  // placeholder loader if missing
  const wrap = document.getElementById('floatingRequestContainer');
  wrap.innerHTML = `<div class="chat-floating"><div class="chat-head">Request product üí¨</div><div class="chat-body"><div id="miniChat" class="chat"></div><div style="display:flex;gap:8px;margin-top:6px"><input id="miniReq" class="input" placeholder="Request a set or figure"><button id="miniSend" class="btn small">Send</button></div></div></div>`;
  $('#miniSend').onclick = ()=> {
    const text = $('#miniReq').value.trim(); if(!text) return;
    const arr = JSON.parse(localStorage.getItem('requests')||'[]'); arr.push({from:'user',text,time:Date.now()}); localStorage.setItem('requests', JSON.stringify(arr));
    $('#miniReq').value=''; loadMiniChat();
    setTimeout(()=>{ const arr2 = JSON.parse(localStorage.getItem('requests')||'[]'); arr2.push({from:'owner',text:'Noted ‚Äî adding to list.' ,time:Date.now()}); localStorage.setItem('requests', JSON.stringify(arr2)); loadMiniChat(); },700);
  };
  loadMiniChat();
}
function loadMiniChat(){
  const mini = $('#miniChat'); if(!mini) return;
  const arr = JSON.parse(localStorage.getItem('requests')||'[]');
  mini.innerHTML = arr.slice(-8).map(m=>`<div class="msg ${m.from==='user'?'user':'owner'}">${esc(m.text)}</div>`).join('') || '<div class="meta">No requests</div>';
}

/* ---------- helper: render categories view ---------- */
function renderCategoryView(){ renderCategoriesView(); buildCategoryNav(); }

/* ---------- init ---------- */
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });
load();

/* ---------- export for debugging ---------- */
window.__nm = { products, addToCart, openCheckout };

</script>
</body>
</html>
