<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Bazaar ‚Äî marketplace</title>
<link rel="stylesheet" href="styles.css">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">Ninjago Bazaar</div>
      <div class="tag">collectibles ‚Ä¢ sets ‚Ä¢ books ‚Ä¢ blind bags</div>
    </div>

    <div class="header-actions">
      <input id="search" class="search" placeholder="Search sets, figures, books..." autocomplete="off">
      <button id="cartBtn" class="btn cart">üõí <span id="cartCount">0</span></button>
      <a class="btn ghost" href="admin.html" target="_blank" rel="noopener noreferrer">Admin</a>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Rare Ninjago finds ‚Äî buy, request, or reserve</h1>
      <p class="hero-sub">Click a category to explore sets, figures, blind bags and books. Reserve with cash or pay with giftcards (demo).</p>
    </section>

    <section id="mainArea" class="main-area"></section>
  </main>

  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

<script>
/*
  Frontend-only site (production-ready UI).
  Images are loaded from your GitHub raw URLs by default; change RAW_BASE if your repo/branch differ.
*/
const RAW_BASE = 'https://raw.githubusercontent.com/mhmmmm000000/ninjago-site-/main/images/'; // adjust if repo/branch different

// helpers
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
const escapeHtml = s => String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
function prefImage(i){ // i may be local path or url
  if(!i) return 'images/placeholder.jpg';
  if(i.startsWith('http') || i.startsWith('//')) return i;
  // if already just filename, prefix RAW_BASE
  if(i.startsWith('images/')) return RAW_BASE + i.replace(/^images\//,'');
  return RAW_BASE + i;
}

/* state */
let products = [];
let cart = JSON.parse(localStorage.getItem('cart')||'[]');
let credits = Number(localStorage.getItem('storeCredit')||0);

/* boot */
async function loadProducts(){
  try {
    const res = await fetch('products.json');
    if(!res.ok) throw new Error('local products.json not found');
    products = await res.json();
  } catch(e){
    // fallback: try to fetch remote JSON from your GitHub raw URL
    try {
      const url = 'https://raw.githubusercontent.com/mhmmmm000000/ninjago-site-/main/products.json';
      const r2 = await fetch(url);
      products = await r2.json();
    } catch(err){
      console.error('failed loading products.json', err);
      products = [];
      $('#mainArea').innerHTML = `<div class="empty">Products failed to load. Check products.json in repo.</div>`;
      return;
    }
  }
  renderCategories();
  attachSearch();
  renderCartCount();
  initFloatingRequest();
}

/* categories */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))).filter(Boolean); }
const ICONS = { 'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Books':'üìö','Books (Rent)':'üìñ' };

function renderCategories(){
  const main = $('#mainArea'); main.innerHTML = '';
  const cats = getCategories();
  const wrapper = document.createElement('div'); wrapper.className = 'categories-grid';
  cats.forEach((c,i)=>{
    const tile = document.createElement('button'); tile.className='category-tile';
    tile.innerHTML = `<div class="cat-emoji">${ICONS[c]||'üì¶'}</div><div class="cat-title">${escapeHtml(c)}</div><div class="cat-count">${products.filter(p=>p.category===c).length} items</div>`;
    wrapper.appendChild(tile);
    setTimeout(()=> tile.classList.add('show'), 80*i);
    tile.addEventListener('click', ()=> openCategory(c));
  });
  main.appendChild(wrapper);
}

/* category page */
function openCategory(category){
  const main = $('#mainArea');
  main.innerHTML = `
    <div class="category-header">
      <button id="backBtn" class="btn ghost small">‚Üê Back</button>
      <div class="category-title">${escapeHtml(category)}</div>
      <div class="category-controls">
        <select id="subFilter" class="small"></select>
        <button id="clearFilter" class="small ghost">Clear</button>
      </div>
    </div>
    <div id="catProducts" class="grid-wrap"></div>
  `;
  $('#backBtn').onclick = () => renderCategories();
  const items = products.filter(p=>p.category===category);
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  const sel = $('#subFilter');
  sel.innerHTML = `<option value="">All subthemes</option>${subs.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('')}`;
  sel.onchange = ()=> renderCategoryProducts(category, sel.value);
  $('#clearFilter').onclick = ()=> { sel.value=''; renderCategoryProducts(category); };
  renderCategoryProducts(category);
}
function renderCategoryProducts(category, subfilter=''){
  const cont = $('#catProducts'); cont.innerHTML = '';
  const search = ($('#search') && $('#search').value.trim().toLowerCase()) || '';
  let items = products.filter(p=>p.category===category);
  if(subfilter) items = items.filter(p=> (p.subtheme||'') === subfilter);
  if(search) items = items.filter(p => (p.title+p.origin+(p.subtheme||'')).toLowerCase().includes(search));
  if(!items.length) { cont.innerHTML = '<div class="empty">No items found</div>'; return; }

  const grid = document.createElement('div'); grid.className='grid cards';
  items.forEach((p,idx)=>{
    const thumb = Array.isArray(p.image) ? p.image[0] : p.image;
    const img = prefImage(thumb);
    const card = document.createElement('article'); card.className='card';
    card.innerHTML = `
      <div class="imgwrap"><img src="${img}" alt="${escapeHtml(p.title)}"></div>
      <div class="card-body">
        <h3>${escapeHtml(p.title)}</h3>
        <div class="meta small">${escapeHtml(p.origin||'')}</div>
        <div class="meta small">${escapeHtml(p.condition||'')}</div>
        <div class="card-footer"><div class="price">SAR ${p.price_sar}</div><div class="actions"><button class="btn view" data-id="${p.id}">View</button><button class="small add" data-id="${p.id}">Add</button></div></div>
      </div>
    `;
    grid.appendChild(card);
    setTimeout(()=>card.classList.add('show'), 70*idx);
  });
  cont.appendChild(grid);
  attachCardEvents();
}

/* search */
function attachSearch(){
  const s = $('#search');
  if(!s) return;
  s.addEventListener('input', ()=> {
    const catHeader = document.querySelector('.category-header');
    if(catHeader){
      const cat = catHeader.querySelector('.category-title').textContent;
      const sub = $('#subFilter') ? $('#subFilter').value : '';
      renderCategoryProducts(cat, sub);
    } else {
      // quick search across all
      renderCategories();
      const q = s.value.trim();
      if(!q) return;
      const results = products.filter(p=> (p.title+p.origin+(p.subtheme||'')).toLowerCase().includes(q.toLowerCase()));
      if(results.length){
        const wrap = document.createElement('div'); wrap.className='search-results';
        wrap.innerHTML = `<h3 class="section-title">Quick results</h3><div class="grid cards"></div>`;
        results.forEach(p=> {
          const thumb = prefImage(Array.isArray(p.image)?p.image[0]:p.image);
          wrap.querySelector('.grid').insertAdjacentHTML('beforeend', `<article class="card show"><div class="imgwrap"><img src="${thumb}"></div><div class="card-body"><h3>${escapeHtml(p.title)}</h3><div class="meta small">${escapeHtml(p.category)}</div><div class="price">SAR ${p.price_sar}</div><div class="actions"><button class="btn view" data-id="${p.id}">View</button></div></div></article>`);
        });
        $('#mainArea').appendChild(wrap);
        attachCardEvents();
      }
    }
  });
}

/* card events */
function attachCardEvents(){
  $$('.view').forEach(b=> b.onclick = ()=> openDetail(b.dataset.id));
  $$('.add').forEach(b=> b.onclick = ()=> addToCart(b.dataset.id));
}

/* product modal */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image) ? p.image : [p.image];
  const imgHtml = imgs.map((u,i)=> `<img class="gthumb ${i===0?'active':''}" data-src="${prefImage(u)}" src="${prefImage(u)}">`).join('');
  $('#modal').innerHTML = `
    <div class="modal-head">
      <h2>${escapeHtml(p.title)}</h2>
      <div><button id="closeModal" class="btn small ghost">Close</button></div>
    </div>
    <div class="modal-grid">
      <div class="modal-left">
        <div class="gallery-main"><img id="galleryMain" src="${prefImage(imgs[0])}" alt=""></div>
        <div class="gallery-thumbs">${imgHtml}</div>
        <div class="product-meta">
          <div>Origin: ${escapeHtml(p.origin||'‚Äî')}</div>
          <div>Condition: ${escapeHtml(p.condition||'‚Äî')}</div>
          <div>${p.piece_count? p.piece_count + ' pcs' : ''} ${p.figures_count? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        </div>
        <div class="price big">SAR ${p.price_sar}</div>
        <div class="modal-cta"><button class="btn" id="modalAdd">Add to cart</button><button class="small" id="modalBuy">Buy now</button></div>
      </div>
      <aside class="modal-side">
        <div class="cart-mini">
          <h4>Quick cart</h4>
          <div id="quickCartList" class="cart-list"></div>
          <div id="quickSummary" class="order-summary"></div>
          <div><button id="gotoCheckout" class="btn">Checkout</button></div>
        </div>
      </aside>
    </div>
  `;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=> $('#modal').classList.add('show'), 10);
  $('#closeModal').onclick = closeModal;
  $('#modalAdd').onclick = ()=> { addToCart(p.id); updateQuickCart(); };
  $('#modalBuy').onclick = ()=> { addToCart(p.id); openCheckout(); };
  $('#gotoCheckout').onclick = openCheckout;
  $$('.gthumb').forEach(t => t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); });
  updateQuickCart();
}
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=> $('#modalBackdrop').classList.remove('show'), 220); }

/* cart */
function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const item = cart.find(c=>c.id===id);
  if(item) item.qty++; else cart.push({ id:p.id, title:p.title, price:p.price_sar, qty:1, image: Array.isArray(p.image)?p.image[0]:p.image });
  localStorage.setItem('cart', JSON.stringify(cart));
  renderCartCount(); updateQuickCart();
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }
function updateQuickCart(){
  const el = $('#quickCartList'); const sumEl = $('#quickSummary');
  if(!el) return;
  el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${prefImage(it.image)}"><div class="cart-cell"><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart empty</div>';
  const total = cart.reduce((s,i)=>s + (i.price * i.qty),0);
  sumEl.innerHTML = `<div><strong>Total: SAR ${total.toFixed(2)}</strong></div>`;
}

/* checkout (simple local/demo) */
function openCheckout(){
  $('#modal').innerHTML = checkoutHtml();
  $('#modalBackdrop').classList.add('show'); setTimeout(()=> $('#modal').classList.add('show'), 10);
  $('#closeModal2').onclick = closeModal;
  $('#cashPay').onclick = handleCashPay;
  $('#giftPay').onclick = handleGiftPay;
  renderCheckoutCart();
}
function checkoutHtml(){
  return `
    <div class="modal-head"><h2>Checkout</h2><div><button id="closeModal2" class="btn small ghost">Close</button></div></div>
    <div class="checkout-grid">
      <div class="checkout-left">
        <h4>Cart</h4><div id="checkoutCart"></div><div id="checkoutSummary" class="order-summary"></div>
      </div>
      <div class="checkout-right">
        <h4>Reserve with Cash</h4>
        <div class="checkout-forms">
          <input id="custName" class="input" placeholder="Full name">
          <input id="custEmail" class="input" placeholder="Email (optional)">
          <input id="custDate" class="input" type="date">
          <textarea id="custMsg" class="textarea" placeholder="Pickup notes"></textarea>
          <button id="cashPay" class="btn">Reserve with cash</button>
        </div>
        <h4 style="margin-top:12px">Pay with Giftcard</h4>
        <div class="checkout-forms">
          <input id="giftCode" class="input" placeholder="Giftcard code">
          <input id="giftAmount" class="input" placeholder="Amount (SAR)" type="number" min="0" step="0.01">
          <button id="giftPay" class="btn">Pay with giftcard</button>
        </div>
        <div class="hint">Overpay becomes store credit (demo).</div>
      </div>
    </div>
  `;
}
function renderCheckoutCart(){
  const el = $('#checkoutCart'); const sumEl = $('#checkoutSummary');
  el.innerHTML = cart.map(it=>`<div class="cart-row"><img src="${prefImage(it.image)}"><div class="cart-cell"><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div></div>`).join('') || '<div class="meta">Cart empty</div>';
  const total = cart.reduce((s,i)=>s + (i.price * i.qty),0);
  sumEl.innerHTML = `<div><strong>Total: SAR ${total.toFixed(2)}</strong></div>`;
}
function handleCashPay(){
  const name = $('#custName').value.trim(); if(!name){ alert('Enter your name'); return; }
  const date = $('#custDate').value; const total = cart.reduce((s,i)=>s + (i.price * i.qty),0);
  const order = { id:'order-'+Date.now(), name, date, email:$('#custEmail').value, cart, total, method:'cash', msg:$('#custMsg').value, created:Date.now() };
  const orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
  alert('Reservation saved ‚Äî Order ID: ' + order.id);
  cart = []; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal(); // remain in same category
}
function handleGiftPay(){
  const code = $('#giftCode').value.trim() || ('GC-'+Math.floor(Math.random()*99999));
  const amount = Number($('#giftAmount').value) || 0;
  const total = cart.reduce((s,i)=>s + (i.price * i.qty),0);
  if(amount < total){
    const remaining = total - amount;
    const order = { id:'order-'+Date.now(), total, paid:amount, method:'giftcard', code, remaining, created:Date.now() };
    const orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    alert(`Partial paid SAR ${amount}. Remaining: SAR ${remaining.toFixed(2)}`);
  } else {
    const credit = +(amount - total);
    credits = +(credits + credit).toFixed(2); localStorage.setItem('storeCredit', credits);
    const order = { id:'order-'+Date.now(), total, paid:amount, method:'giftcard', code, storeCreditGained: credit, created:Date.now() };
    const orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));
    alert(`Payment saved. You gained SAR ${credit.toFixed(2)} in-store credit. Current credit: SAR ${credits.toFixed(2)}`);
  }
  cart = []; localStorage.setItem('cart', JSON.stringify(cart)); renderCartCount(); closeModal();
}

/* floating request widget */
function initFloatingRequest(){
  if(document.querySelector('.chat-floating')) return;
  const wrap = document.createElement('div'); wrap.className='chat-floating';
  wrap.innerHTML = `<div class="chat-head">Request product üí¨</div><div class="chat-body"><div id="miniChat" class="chat"></div><div style="display:flex;gap:8px;margin-top:6px"><input id="miniReq" class="input" placeholder="Request (e.g. Set 71799)"><button id="miniSend" class="btn small">Send</button></div></div>`;
  document.body.appendChild(wrap);
  $('#miniSend').onclick = ()=>{
    const text = $('#miniReq').value.trim(); if(!text) return;
    const msg = { from:'user', text, time:Date.now() };
    const arr = JSON.parse(localStorage.getItem('requests')||'[]'); arr.push(msg); localStorage.setItem('requests', JSON.stringify(arr));
    $('#miniReq').value=''; loadMiniChat();
    setTimeout(()=>{ const reply = { from:'owner', text: 'Thanks! We saw: ' + text, time: Date.now() }; const a = JSON.parse(localStorage.getItem('requests')||'[]'); a.push(reply); localStorage.setItem('requests', JSON.stringify(a)); loadMiniChat(); }, 700);
  };
  loadMiniChat();
}
function loadMiniChat(){
  const mini = $('#miniChat');
  if(!mini) return;
  const arr = JSON.parse(localStorage.getItem('requests')||'[]');
  mini.innerHTML = arr.slice(-12).map(m=>`<div class="msg ${m.from==='user'?'user':'owner'}">${escapeHtml(m.text)}</div>`).join('') || '<div class="meta">No requests yet</div>';
}

/* UI helpers */
document.addEventListener('keydown', e=>{ if(e.key === 'Escape'){ $('#modalBackdrop').classList.remove('show'); $('#modal').classList.remove('show'); }});
$('#cartBtn').onclick = ()=> openCheckout();

/* initial load */
loadProducts();
function initFloatingRequest(){ initFloatingRequest = initFloatingRequest; } // no-op for bundling safety
initFloatingRequest();

/* utility for debug */
window.__debug = { products, cart };
</script>
</body>
</html>
