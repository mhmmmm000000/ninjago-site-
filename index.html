<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ninjago Market ‚Äî Launch</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">Ninjago Market</div>
      <div class="subtitle">Browse ‚Ä¢ Request ‚Ä¢ Reserve</div>
    </div>

    <div class="controls">
      <input id="search" class="search" placeholder="Search sets, figures, books...">
      <button id="themeToggle" class="btn small" title="Toggle theme">üåì</button>
      <button id="createAccountBtn" class="btn small">Create account</button>
      <button id="signinBtn" class="btn small">Sign in</button>
      <div id="userBadge" class="user-badge hidden"></div>
      <div id="cartBtn" class="btn">üõí <span id="cartCount">0</span></div>
      <a id="adminLink" class="btn small" href="admin.html">Admin</a>
    </div>
  </header>

  <main class="container">
    <div class="top-row">
      <div class="hint">Tip: click a category (e.g., Sets). Click the box image to enter product detail.</div>
      <div class="cta">
        <button id="joinNowHome" class="btn">Create account</button>
      </div>
    </div>

    <div id="mainArea" class="main-area"></div>
  </main>

  <!-- modal backdrop -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true"></div>
  </div>

  <!-- feedback / request floating - minimizable -->
  <div id="feedbackWidget" class="feedback-widget">
    <div class="feedback-head">
      <span>Feedback / Request</span>
      <div class="feedback-controls">
        <button id="feedbackMinimize" class="small">‚Äî</button>
      </div>
    </div>
    <div id="feedbackBody" class="feedback-body">
      <div id="feedbackList" class="feedback-list"></div>
      <textarea id="feedbackInput" class="input" placeholder="Tell us what to add or improve"></textarea>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="feedbackSend" class="btn small">Send</button>
        <button id="feedbackClear" class="small">Clear</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Helpers ---------- */
const $ = q => document.querySelector(q);
const $$ = q => Array.from(document.querySelectorAll(q));
const escapeHtml = s => String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const STORAGE = window.localStorage;

/* ---------- State ---------- */
let products = [];
let currentUser = STORAGE.getItem('nm_user') || null;
let cart = [];
let credits = {}; // email -> credit
let points = {}; // email -> points

/* ---------- Load products.json ---------- */
async function loadProducts(){
  try{
    const res = await fetch('products.json');
    products = await res.json();
  }catch(e){
    $('#mainArea').innerHTML = '<p class="error">Failed to load products.json ‚Äî check file.</p>';
    console.error(e);
    return;
  }
  renderHome();
  restoreSession();
}

/* ---------- Session / User ---------- */
function restoreSession(){
  // load credits/points
  credits = JSON.parse(STORAGE.getItem('nm_credits') || '{}');
  points = JSON.parse(STORAGE.getItem('nm_points') || '{}');

  if(currentUser){
    showUser(currentUser);
    loadCartFor(currentUser);
  } else {
    $('#userBadge').classList.add('hidden');
    $('#signinBtn').classList.remove('hidden');
    $('#createAccountBtn').classList.remove('hidden');
  }
}
function signIn(email){
  currentUser = email;
  STORAGE.setItem('nm_user', email);
  showUser(email);
  loadCartFor(email);
}
function signOut(){
  currentUser = null;
  STORAGE.removeItem('nm_user');
  cart = [];
  renderCartCount();
  $('#userBadge').classList.add('hidden');
  $('#signinBtn').classList.remove('hidden');
  $('#createAccountBtn').classList.remove('hidden');
}
function showUser(email){
  $('#signinBtn').classList.add('hidden');
  $('#createAccountBtn').classList.add('hidden');
  $('#userBadge').classList.remove('hidden');
  $('#userBadge').innerText = email + ' ‚Ä¢ Points: ' + (points[email] || 0);
}

/* ---------- Cart per-user ---------- */
function cartKeyFor(email){ return 'nm_cart_' + email; }
function loadCartFor(email){
  cart = JSON.parse(STORAGE.getItem(cartKeyFor(email)) || '[]');
  renderCartCount();
}
function saveCartFor(email){
  STORAGE.setItem(cartKeyFor(email), JSON.stringify(cart));
}
function addToCart(id){
  if(!currentUser){ openLoginModal(true); return; }
  const item = cart.find(c=>c.id===id);
  const p = products.find(x=>x.id===id);
  if(!p) return;
  if(item) item.qty++; else cart.push({id:p.id,title:p.title,price:p.price_sar||0,qty:1,image: Array.isArray(p.image)?p.image[0]:p.image});
  saveCartFor(currentUser);
  renderCartCount();
  showToast('Added to cart');
}
function removeFromCart(id){
  cart = cart.filter(c=>c.id!==id);
  saveCartFor(currentUser);
  renderCartCount();
}
function renderCartCount(){ $('#cartCount').innerText = cart.reduce((s,i)=>s+i.qty,0); }

/* ---------- UI: Categories / Home ---------- */
function getCategories(){ return Array.from(new Set(products.map(p=>p.category))).filter(Boolean); }
function categoryIcon(cat){
  const map = {'Sets':'üèóÔ∏è','Figures':'üßç','Blind Bags':'üéÅ','Polybags':'üéí','Books':'üìö','Miscs':'üßæ','Books (Rent)':'üìñ'};
  return map[cat]||'üì¶';
}
function renderHome(){
  $('#mainArea').innerHTML = '';
  const cats = getCategories();
  const wrap = document.createElement('div'); wrap.className='categories-grid';
  cats.forEach((cat, i)=>{
    const tile = document.createElement('button'); tile.className='category-tile';
    tile.innerHTML = `<div class="cat-emoji">${categoryIcon(cat)}</div><div class="cat-title">${escapeHtml(cat)}</div><div class="cat-count">${products.filter(p=>p.category===cat).length} items</div>`;
    tile.onclick = ()=> renderCategory(cat);
    wrap.appendChild(tile);
    setTimeout(()=> tile.classList.add('show'), 70*i);
  });
  $('#mainArea').appendChild(wrap);
}

/* ---------- Category view ---------- */
function renderCategory(cat){
  const items = products.filter(p=>p.category===cat);
  $('#mainArea').innerHTML = `
    <div class="category-header"><button id="backBtn" class="btn small">‚Üê Back</button><h2>${escapeHtml(cat)}</h2><div class="controls-inline"><select id="filterSub" class="small"></select><button id="clearSub" class="small">Clear</button></div></div>
    <div id="catProducts"></div>
  `;
  $('#backBtn').onclick = ()=> renderHome();
  const subs = Array.from(new Set(items.map(i=>i.subtheme||'Misc')));
  const sel = $('#filterSub');
  sel.innerHTML = '<option value="">All subthemes</option>' + subs.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  $('#clearSub').onclick = ()=> { sel.value=''; renderProductsGrid(items); };
  sel.onchange = ()=> renderProductsGrid(items.filter(p=> (p.subtheme||'')===sel.value));
  renderProductsGrid(items);
}

function renderProductsGrid(items){
  const cont = $('#catProducts');
  if(!cont) return;
  if(items.length===0){ cont.innerHTML = '<p class="hint">No items</p>'; return; }
  const grid = document.createElement('div'); grid.className='grid';
  items.forEach((p,i)=>{
    const img = Array.isArray(p.image)?p.image[0]:p.image;
    const hard = p.hard_to_find ? `<div class="hard">Hard to find</div>` : '';
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="card-thumb" data-id="${p.id}" title="Open ${escapeHtml(p.title)}">
        <img src="${img}" alt="${escapeHtml(p.title)}">
      </div>
      <h3>${escapeHtml(p.title)}</h3>
      <div class="meta">${escapeHtml(p.origin||p.subtheme||'')}</div>
      <div class="price">SAR ${p.price_sar !== undefined ? p.price_sar : '-'}</div>
      <div class="card-actions">
        <button class="btn add" data-id="${p.id}">Add</button>
        <button class="small view" data-id="${p.id}">View</button>
      </div>
      ${hard}
    `;
    grid.appendChild(card);
    setTimeout(()=>card.classList.add('show'), 40*i);
  });
  cont.innerHTML = ''; cont.appendChild(grid);
  // events: click on box -> open detail
  $$('.card-thumb').forEach(el=> el.onclick = ()=> openDetail(el.dataset.id));
  $$('.view').forEach(b => b.onclick = ()=> openDetail(b.dataset.id));
  $$('.add').forEach(b => b.onclick = ()=> addToCart(b.dataset.id));
}

/* ---------- Product modal ---------- */
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const imgs = Array.isArray(p.image)?p.image:p.image?[p.image]:['images/placeholder.jpg'];
  $('#modal').innerHTML = `
    <div class="modal-head"><h2>${escapeHtml(p.title)}</h2><button id="closeModal" class="btn small">Close</button></div>
    <div class="modal-grid">
      <div class="gallery">
        <div class="gallery-main"><img id="galleryMain" src="${imgs[0]}"></div>
        <div class="gallery-thumbs">${imgs.map((u,i)=>`<img class="gthumb ${i===0?'active':''}" data-src="${u}" src="${u}">`).join('')}</div>
      </div>

      <aside class="product-info">
        <div class="meta">Origin: ${escapeHtml(p.origin||'')}</div>
        <div class="meta">Condition: ${escapeHtml(p.condition||'')}</div>
        <div class="meta">${p.piece_count? (p.piece_count + ' pcs') : ''} ${p.figures_count? '‚Ä¢ ' + p.figures_count + ' figs' : ''}</div>
        <div class="price">SAR ${p.price_sar !== undefined ? p.price_sar : '-'}</div>
        ${p.price_discounted ? `<div class="price discounted">Discounted: SAR ${p.price_discounted}</div>` : ''}
        <div style="margin-top:10px">
          <button id="modalAdd" class="btn">Add to cart</button>
          <button id="modalBuy" class="btn small">Buy now</button>
        </div>

        <div class="section">
          <h4>Description</h4>
          <div class="desc">${escapeHtml(p.description || p.notes || 'No description yet.')}</div>
        </div>

        <div class="section">
          <h4>Price comparisons</h4>
          ${(p.price_comparisons||[]).map(c=>`<div class="pc"><a href="${c.url}" target="_blank" rel="noopener">${escapeHtml(c.site)}</a> <span>${escapeHtml(c.price)}</span></div>`).join('')}
        </div>
      </aside>
    </div>
  `;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  $('#closeModal').onclick = closeModal;
  $('#modalAdd').onclick = ()=>{ addToCart(p.id); updateQuickCart(); };
  $('#modalBuy').onclick = ()=> { if(!currentUser) { openLoginModal(true); } else openCheckout(); };
  $$('.gthumb').forEach(t=> t.onclick = ()=> { $('#galleryMain').src = t.dataset.src; $$('.gthumb').forEach(x=>x.classList.remove('active')); t.classList.add('active'); });
  updateQuickCart();
}
function closeModal(){ $('#modal').classList.remove('show'); setTimeout(()=>$('#modalBackdrop').classList.remove('show'),220); }

function updateQuickCart(){
  const quick = document.getElementById('quickCartList');
  // not used in this simplified modal
}

/* ---------- Checkout ---------- */
function openCheckout(){
  if(!currentUser){ openLoginModal(true); return; }
  // Show checkout modal with two big buttons
  const total = cart.reduce((s,i)=>s + (i.price||0) * i.qty, 0);
  $('#modal').innerHTML = `
    <div class="modal-head"><h2>Checkout</h2><button id="closeModal" class="btn small">Close</button></div>
    <div class="checkout-grid">
      <div>
        <h4>Your cart</h4>
        <div id="checkoutCart">${cart.map(it=>`<div class="checkout-item"><img src="${it.image}"><div><strong>${escapeHtml(it.title)}</strong><div class="meta">SAR ${it.price} √ó ${it.qty}</div></div><button class="small remove" data-id="${it.id}">Remove</button></div>`).join('') || '<div class="meta">Cart is empty</div>'}</div>
        <div class="order-summary">Total: SAR ${total.toFixed(2)}</div>
      </div>
      <div>
        <h4>Payment options</h4>
        <p>Choose a payment method:</p>
        <button id="payCash" class="btn pay-cash">Reserve with cash</button>
        <div style="height:8px"></div>
        <button id="payGift" class="btn small pay-gift">Pay with giftcard</button>
        <div id="giftArea" style="display:none;margin-top:8px">
          <input id="giftCode" class="input" placeholder="Giftcard code (e.g. GC-123)">
          <input id="giftAmount" class="input" type="number" placeholder="Amount (SAR)">
          <button id="doGift" class="btn small">Use giftcard</button>
        </div>
        <div class="hint">If amount > total, remaining becomes store credit to your account.</div>
      </div>
    </div>
  `;
  $('#closeModal').onclick = closeModal;
  $$('.remove').forEach(b=>b.onclick = ()=> { removeFromCart(b.dataset.id); openCheckout(); });
  $('#payCash').onclick = ()=> handleCashPay();
  $('#payGift').onclick = ()=> { $('#giftArea').style.display = 'block'; };
  $('#doGift')?.addEventListener('click', handleGiftPay);
}

function handleCashPay(){
  if(!currentUser){ openLoginModal(true); return; }
  const total = cart.reduce((s,i)=>s + (i.price||0)*i.qty, 0);
  const order = { id:'ord-'+Date.now(), user:currentUser, method:'cash', total, items:cart, created:Date.now() };
  let orders = JSON.parse(STORAGE.getItem('nm_orders') || '[]');
  orders.push(order);
  STORAGE.setItem('nm_orders', JSON.stringify(orders));
  // reward points
  points[currentUser] = (points[currentUser]||0) + Math.floor(total/10);
  STORAGE.setItem('nm_points', JSON.stringify(points));
  // clear cart
  cart = []; saveCartFor(currentUser);
  renderCartCount();
  closeModal();
  showToast('Reservation saved ‚Äî Order ID: ' + order.id);
}

function handleGiftPay(){
  if(!currentUser){ openLoginModal(true); return; }
  const code = $('#giftCode').value.trim();
  const amount = Number($('#giftAmount').value) || 0;
  const total = cart.reduce((s,i)=>s + (i.price||0)*i.qty, 0);
  // client-side "giftcards": we store in localStorage nm_giftcards as array {code,balance}
  const gc = JSON.parse(STORAGE.getItem('nm_giftcards')||'[]');
  const idx = gc.findIndex(g=> g.code === code);
  if(idx === -1){ alert('Giftcard code not found'); return; }
  const card = gc[idx];
  if(card.balance <= 0){ alert('Giftcard empty'); return; }
  const toUse = Math.min(amount || total, card.balance);
  card.balance = +(card.balance - toUse).toFixed(2);
  gc[idx] = card;
  STORAGE.setItem('nm_giftcards', JSON.stringify(gc));
  let order = { id:'ord-'+Date.now(), user:currentUser, method:'giftcard', code, paid:toUse, total, items:cart, created:Date.now() };
  let orders = JSON.parse(STORAGE.getItem('nm_orders') || '[]'); orders.push(order); STORAGE.setItem('nm_orders', JSON.stringify(orders));
  // if toUse > total -> credit remainder
  if(toUse > total){
    const credit = +(toUse - total).toFixed(2);
    credits[currentUser] = +( (credits[currentUser]||0) + credit ).toFixed(2);
    STORAGE.setItem('nm_credits', JSON.stringify(credits));
    showToast('Paid. You gained SAR ' + credit.toFixed(2) + ' store credit.');
  }
  // reward points
  points[currentUser] = (points[currentUser]||0) + Math.floor((toUse)/10);
  STORAGE.setItem('nm_points', JSON.stringify(points));
  cart = []; saveCartFor(currentUser); renderCartCount();
  closeModal();
  showToast('Order placed ‚Äî ID: ' + order.id);
}

/* ---------- Login / Signup ---------- */
function openLoginModal(requireAfter=false){
  $('#modal').innerHTML = `
    <div class="modal-head"><h2>Sign in / Create account</h2><button id="closeModal" class="btn small">Close</button></div>
    <div style="padding:12px">
      <input id="emailIn" class="input" placeholder="Email address">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="doSignin" class="btn">Sign in</button>
        <button id="doCreate" class="small">Create account</button>
      </div>
      <div style="margin-top:10px" class="hint">We only save your email. No password required for buyers. Admin uses password protection on <strong>admin.html</strong>.</div>
    </div>
  `;
  $('#modalBackdrop').classList.add('show'); setTimeout(()=>$('#modal').classList.add('show'),10);
  $('#closeModal').onclick = closeModal;
  $('#doSignin').onclick = ()=> {
    const em = $('#emailIn').value.trim().toLowerCase();
    if(!em || !em.includes('@')) { alert('Enter a valid email'); return; }
    signIn(em);
    closeModal();
    if(requireAfter) openCheckout();
  };
  $('#doCreate').onclick = ()=> {
    const em = $('#emailIn').value.trim().toLowerCase();
    if(!em || !em.includes('@')) { alert('Enter a valid email'); return; }
    // store user existence
    let users = JSON.parse(STORAGE.getItem('nm_users')||'[]');
    if(!users.includes(em)) users.push(em);
    STORAGE.setItem('nm_users', JSON.stringify(users));
    // init points/credits
    const sc = JSON.parse(STORAGE.getItem('nm_credits')||'{}'); if(!(em in sc)) sc[em] = 0; STORAGE.setItem('nm_credits', JSON.stringify(sc));
    const pt = JSON.parse(STORAGE.getItem('nm_points')||'{}'); if(!(em in pt)) pt[em] = 0; STORAGE.setItem('nm_points', JSON.stringify(pt));
    signIn(em);
    closeModal();
    if(requireAfter) openCheckout();
  };
}

/* ---------- Feedback widget ---------- */
function initFeedback(){
  const fb = document.getElementById('feedbackWidget');
  const body = $('#feedbackBody');
  const list = $('#feedbackList');
  const minim = $('#feedbackMinimize');
  const stored = JSON.parse(STORAGE.getItem('nm_feedback')||'[]');
  function refreshList(){ const arr = JSON.parse(STORAGE.getItem('nm_feedback')||'[]'); list.innerHTML = arr.map(m=>`<div class="fitem">${escapeHtml(m.text)}<div class="meta">by ${escapeHtml(m.email||'guest')} ‚Äî ${new Date(m.time).toLocaleString()}</div></div>`).join('') || '<div class="meta">No feedback yet</div>'; }
  refreshList();
  minim.onclick = ()=> {
    if(body.style.display === 'none'){ body.style.display = 'block'; minim.innerText='‚Äî'; } else { body.style.display = 'none'; minim.innerText='+'; }
  };
  $('#feedbackSend').onclick = ()=> {
    const txt = $('#feedbackInput').value.trim();
    if(!txt) return;
    const obj = { text: txt, email: currentUser || null, time: Date.now() };
    const arr = JSON.parse(STORAGE.getItem('nm_feedback')||'[]'); arr.push(obj); STORAGE.setItem('nm_feedback', JSON.stringify(arr));
    $('#feedbackInput').value = '';
    refreshList();
    showToast('Thanks ‚Äî feedback saved.');
  };
  $('#feedbackClear').onclick = ()=> { STORAGE.removeItem('nm_feedback'); refreshList(); };
}

/* ---------- Theme toggle ---------- */
function initTheme(){
  const saved = STORAGE.getItem('nm_theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved);
  $('#themeToggle').onclick = ()=> {
    const now = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', now);
    STORAGE.setItem('nm_theme', now);
  };
}

/* ---------- Toast ---------- */
function showToast(msg){
  const t = document.createElement('div'); t.className='toast'; t.innerText = msg;
  document.body.appendChild(t); setTimeout(()=> t.classList.add('show'),10);
  setTimeout(()=> { t.classList.remove('show'); setTimeout(()=> t.remove(),300); }, 3000);
}

/* ---------- Admin quick check (client-side) ---------- */
function requireAdminPassword(){
  // When admin.html loads it will check password M.O.D8643 in that file
}

/* ---------- Small UI hooks ---------- */
document.getElementById('createAccountBtn').onclick = ()=> openLoginModal(false);
document.getElementById('signinBtn').onclick = ()=> openLoginModal(false);
document.getElementById('joinNowHome').onclick = ()=> openLoginModal(false);
$('#cartBtn').onclick = ()=> openCheckout();
$('#search').addEventListener('input', ()=>{
  const q = $('#search').value.trim().toLowerCase();
  if(!q){ renderHome(); return; }
  const results = products.filter(p=> (p.title + (p.origin||'') + (p.subtheme||'')).toLowerCase().includes(q));
  $('#mainArea').innerHTML = `<h3 class="section-title">Results</h3><div id="searchResults"></div>`;
  const sr = document.getElementById('searchResults');
  const grid = document.createElement('div'); grid.className='grid';
  results.forEach((p,i)=> grid.insertAdjacentHTML('beforeend', `<div class="card show"><div class="card-thumb" data-id="${p.id}"><img src="${Array.isArray(p.image)?p.image[0]:p.image}"></div><h3>${escapeHtml(p.title)}</h3><div class="meta">${escapeHtml(p.category)}</div><div class="price">SAR ${p.price_sar||'-'}</div><div class="card-actions"><button class="btn add" data-id="${p.id}">Add</button><button class="small view" data-id="${p.id}">View</button></div></div>`));
  sr.appendChild(grid);
  $$('.card-thumb').forEach(el=> el.onclick = ()=> openDetail(el.dataset.id));
  $$('.view').forEach(b => b.onclick = ()=> openDetail(b.dataset.id));
  $$('.add').forEach(b => b.onclick = ()=> addToCart(b.dataset.id));
});

/* ---------- Init ---------- */
initTheme();
initFeedback();
loadProducts();

/* ---------- Keyboard: close modal ---------- */
document.addEventListener('keydown', e=>{ if(e.key === 'Escape'){ closeModal(); } });

</script>
</body>
</html>
